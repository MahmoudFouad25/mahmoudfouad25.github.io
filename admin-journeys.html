<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>إدارة الرحلات - محمود فؤاد</title>
<style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

:root {
    --primary: #2C5530;
    --secondary: #8B9467;
    --accent: #D4AF37;
    --light: #F5F2E8;
    --dark: #1A1A1A;
    --gradient: linear-gradient(135deg, #2C5530 0%, #8B9467 100%);
    --success: #28a745;
    --danger: #dc3545;
    --warning: #ffc107;
    --info: #17a2b8;
}

body {
    font-family: 'Segoe UI', Tahoma, Arial, sans-serif;
    background: #f5f5f5;
    color: var(--dark);
    min-height: 100vh;
}

/* Loading Overlay */
.loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.7);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 9999;
}

.loading-spinner {
    width: 50px;
    height: 50px;
    border: 5px solid #f3f3f3;
    border-top: 5px solid var(--primary);
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Navigation */
.admin-nav {
    background: white;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    padding: 1rem 2rem;
    position: sticky;
    top: 0;
    z-index: 1000;
}

.nav-container {
    max-width: 1400px;
    margin: 0 auto;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.nav-brand h2 {
    color: var(--primary);
    font-size: 1.5rem;
}

.nav-links {
    display: flex;
    gap: 2rem;
    align-items: center;
}

.nav-links a {
    color: var(--dark);
    text-decoration: none;
    font-weight: 500;
    position: relative;
    transition: color 0.3s;
}

.nav-links a:hover {
    color: var(--primary);
}

.nav-links a.active {
    color: var(--primary);
}

.nav-links a.active::after {
    content: '';
    position: absolute;
    bottom: -5px;
    left: 0;
    right: 0;
    height: 3px;
    background: var(--accent);
}

.badge {
    background: var(--success);
    color: white;
    padding: 2px 6px;
    border-radius: 10px;
    font-size: 0.75rem;
    margin-right: 5px;
    display: inline-block;
    min-width: 20px;
    text-align: center;
}

/* Main Container */
.journeys-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 2rem;
}

/* Page Header */
.page-header {
    background: white;
    padding: 2rem;
    border-radius: 15px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.1);
    margin-bottom: 2rem;
    position: relative;
    overflow: hidden;
}

.page-header::before {
    content: '';
    position: absolute;
    top: 0;
    right: 0;
    width: 200px;
    height: 200px;
    background: var(--gradient);
    opacity: 0.1;
    border-radius: 50%;
    transform: translate(50%, -50%);
}

.page-header h1 {
    color: var(--primary);
    font-size: 2rem;
    margin-bottom: 0.5rem;
}

.page-header p {
    color: #666;
}

/* Stats Cards with Animation */
.stats-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
}

.stat-card {
    background: white;
    padding: 1.5rem;
    border-radius: 10px;
    box-shadow: 0 3px 15px rgba(0,0,0,0.1);
    text-align: center;
    transition: all 0.3s;
    position: relative;
    overflow: hidden;
}

.stat-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 4px;
    background: var(--gradient);
}

.stat-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 5px 25px rgba(0,0,0,0.15);
}

.stat-card h3 {
    color: #666;
    font-size: 0.9rem;
    margin-bottom: 0.5rem;
}

.stat-card .number {
    font-size: 2rem;
    font-weight: bold;
    color: var(--primary);
    display: block;
    animation: countUp 1s ease-out;
}

@keyframes countUp {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Enhanced Filters Section */
.filters-section {
    background: white;
    padding: 1.5rem;
    border-radius: 10px;
    box-shadow: 0 3px 15px rgba(0,0,0,0.1);
    margin-bottom: 2rem;
}

.filters-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.filters-header h3 {
    color: var(--primary);
    font-size: 1.1rem;
}

.filters-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    align-items: end;
}

.filter-group {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.filter-group label {
    color: var(--primary);
    font-weight: 500;
    font-size: 0.9rem;
}

.filter-group input,
.filter-group select {
    padding: 0.75rem;
    border: 2px solid #ddd;
    border-radius: 8px;
    font-size: 1rem;
    transition: all 0.3s;
}

.filter-group input:focus,
.filter-group select:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(44, 85, 48, 0.1);
}

/* Journey Cards Enhanced */
.journeys-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: 1.5rem;
}

.journey-card {
    background: white;
    border-radius: 15px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.1);
    overflow: hidden;
    transition: all 0.3s;
    cursor: pointer;
    position: relative;
}

.journey-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 30px rgba(0,0,0,0.15);
}

.journey-card.priority {
    border: 2px solid var(--warning);
}

.journey-header {
    background: var(--gradient);
    padding: 1.5rem;
    color: white;
    position: relative;
}

.journey-header::after {
    content: '';
    position: absolute;
    bottom: -1px;
    left: 0;
    right: 0;
    height: 20px;
    background: white;
    border-radius: 50% 50% 0 0 / 100% 100% 0 0;
}

.client-info {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1rem;
}

.client-avatar {
    width: 50px;
    height: 50px;
    background: white;
    color: var(--primary);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 1.2rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.client-details h3 {
    margin-bottom: 0.3rem;
}

.client-details p {
    font-size: 0.85rem;
    opacity: 0.9;
}

.journey-status {
    display: inline-block;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 600;
    background: rgba(255, 255, 255, 0.2);
}

.journey-body {
    padding: 1.5rem;
    padding-top: 2rem;
}

.program-info {
    margin-bottom: 1rem;
}

.program-name {
    color: var(--primary);
    font-weight: 600;
    margin-bottom: 0.5rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.phase-indicator {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: #666;
    font-size: 0.9rem;
}

.progress-section {
    margin-bottom: 1rem;
}

.progress-bar {
    width: 100%;
    height: 10px;
    background: #e9ecef;
    border-radius: 5px;
    overflow: hidden;
    margin: 0.5rem 0;
}

.progress-fill {
    height: 100%;
    background: var(--gradient);
    transition: width 0.5s ease;
    position: relative;
}

.progress-fill::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    bottom: 0;
    right: 0;
    background: linear-gradient(
        45deg,
        transparent 25%,
        rgba(255,255,255,.2) 25%,
        rgba(255,255,255,.2) 50%,
        transparent 50%,
        transparent 75%,
        rgba(255,255,255,.2) 75%,
        rgba(255,255,255,.2)
    );
    background-size: 20px 20px;
    animation: progress-animation 1s linear infinite;
}

@keyframes progress-animation {
    0% { background-position: 0 0; }
    100% { background-position: 20px 20px; }
}

.progress-text {
    display: flex;
    justify-content: space-between;
    font-size: 0.85rem;
    color: #666;
}

.journey-meta {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 0.5rem;
    margin-bottom: 1rem;
    padding: 1rem;
    background: #f8f9fa;
    border-radius: 10px;
}

.meta-item {
    text-align: center;
    position: relative;
}

.meta-item:not(:last-child)::after {
    content: '';
    position: absolute;
    left: 0;
    top: 50%;
    bottom: 50%;
    width: 1px;
    background: #dee2e6;
    transform: translateY(-50%);
}

.meta-value {
    font-weight: 600;
    color: var(--primary);
    font-size: 1.1rem;
}

.meta-label {
    font-size: 0.8rem;
    color: #666;
}

/* Engagement Indicator */
.engagement-indicator {
    position: absolute;
    top: 1rem;
    left: 1rem;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    animation: pulse 2s infinite;
}

.engagement-indicator.high {
    background: var(--success);
}

.engagement-indicator.medium {
    background: var(--warning);
}

.engagement-indicator.low {
    background: var(--danger);
}

@keyframes pulse {
    0% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.4); }
    70% { box-shadow: 0 0 0 10px rgba(40, 167, 69, 0); }
    100% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0); }
}

/* Journey Actions */
.journey-actions {
    display: flex;
    gap: 0.5rem;
}

.btn {
    padding: 0.5rem 1rem;
    border: none;
    border-radius: 8px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s;
    font-size: 0.9rem;
    flex: 1;
    text-align: center;
    position: relative;
    overflow: hidden;
}

.btn::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 0;
    height: 0;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.5);
    transform: translate(-50%, -50%);
    transition: width 0.6s, height 0.6s;
}

.btn:active::before {
    width: 300px;
    height: 300px;
}

.btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.btn-primary {
    background: var(--primary);
    color: white;
}

.btn-success {
    background: var(--success);
    color: white;
}

.btn-info {
    background: var(--info);
    color: white;
}

.btn-whatsapp {
    background: #25d366;
    color: white;
}

/* Empty State */
.empty-state {
    text-align: center;
    padding: 4rem 2rem;
    color: #999;
}

.empty-state-icon {
    font-size: 4rem;
    margin-bottom: 1rem;
    opacity: 0.5;
}

.empty-state-message {
    font-size: 1.1rem;
    color: #666;
    margin-bottom: 1.5rem;
}

/* Journey Management Modal Enhanced */
.modal {
    display: none;
    position: fixed;
    z-index: 2000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
    overflow-y: auto;
    animation: fadeIn 0.3s;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

.modal-content {
    background-color: white;
    margin: 2% auto;
    padding: 0;
    border-radius: 15px;
    width: 95%;
    max-width: 1200px;
    animation: slideIn 0.3s;
    max-height: 90vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
}

@keyframes slideIn {
    from { transform: translateY(-50px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}

.modal-header {
    background: var(--gradient);
    color: white;
    padding: 2rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-header h2 {
    font-size: 1.5rem;
    margin: 0;
}

.close {
    color: white;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
    opacity: 0.8;
    transition: opacity 0.3s;
}

.close:hover {
    opacity: 1;
}

.modal-body {
    flex: 1;
    overflow-y: auto;
    padding: 2rem;
}

/* Enhanced Management Tabs */
.management-tabs {
    display: flex;
    gap: 0.5rem;
    border-bottom: 2px solid #e9ecef;
    margin-bottom: 2rem;
    overflow-x: auto;
    padding: 0 0.5rem;
}

.tab-btn {
    padding: 0.75rem 1.5rem;
    background: none;
    border: none;
    cursor: pointer;
    color: #666;
    font-size: 1rem;
    font-weight: 500;
    position: relative;
    transition: all 0.3s;
    white-space: nowrap;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.tab-btn:hover {
    color: var(--primary);
    background: rgba(44, 85, 48, 0.05);
    border-radius: 8px 8px 0 0;
}

.tab-btn.active {
    color: var(--primary);
    background: rgba(44, 85, 48, 0.1);
    border-radius: 8px 8px 0 0;
}

.tab-btn.active::after {
    content: '';
    position: absolute;
    bottom: -2px;
    right: 0;
    width: 100%;
    height: 2px;
    background: var(--primary);
}

.tab-icon {
    font-size: 1.2rem;
}

.tab-content {
    display: none;
    animation: fadeIn 0.3s;
}

.tab-content.active {
    display: block;
}

/* Overview Tab Enhanced */
.client-summary {
    background: #f8f9fa;
    padding: 2rem;
    border-radius: 10px;
    margin-bottom: 2rem;
    display: flex;
    gap: 2rem;
    align-items: center;
}

.summary-avatar {
    width: 80px;
    height: 80px;
    background: var(--gradient);
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2rem;
    font-weight: bold;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.summary-info h3 {
    color: var(--primary);
    margin-bottom: 0.5rem;
}

.summary-info p {
    color: #666;
    margin: 0.3rem 0;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.info-icon {
    color: var(--primary);
    font-size: 1rem;
}

.overview-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
}

.overview-stat {
    background: white;
    border: 2px solid #e9ecef;
    padding: 1.5rem;
    border-radius: 10px;
    text-align: center;
    transition: all 0.3s;
}

.overview-stat:hover {
    border-color: var(--primary);
    transform: translateY(-2px);
}

.overview-stat .value {
    font-size: 2rem;
    font-weight: bold;
    color: var(--primary);
}

.overview-stat .label {
    color: #666;
    font-size: 0.9rem;
}

/* Enhanced Timeline */
.timeline {
    position: relative;
    padding-right: 30px;
}

.timeline::before {
    content: '';
    position: absolute;
    right: 10px;
    top: 0;
    bottom: 0;
    width: 2px;
    background: #e9ecef;
}

.timeline-item {
    position: relative;
    padding-bottom: 2rem;
    animation: slideInRight 0.5s;
}

@keyframes slideInRight {
    from { 
        opacity: 0; 
        transform: translateX(-20px); 
    }
    to { 
        opacity: 1; 
        transform: translateX(0); 
    }
}

.timeline-item::before {
    content: '';
    position: absolute;
    right: 0;
    top: 5px;
    width: 20px;
    height: 20px;
    background: white;
    border: 3px solid var(--primary);
    border-radius: 50%;
    z-index: 1;
}

.timeline-item.completed::before {
    background: var(--primary);
}

.timeline-item.current::before {
    background: var(--warning);
    border-color: var(--warning);
    animation: pulse 2s infinite;
}

.timeline-content {
    background: #f8f9fa;
    padding: 1.5rem;
    border-radius: 10px;
    margin-right: 30px;
    transition: all 0.3s;
}

.timeline-content:hover {
    background: white;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.timeline-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 0.5rem;
}

.timeline-title {
    font-weight: 600;
    color: var(--primary);
}

.timeline-date {
    color: #666;
    font-size: 0.9rem;
}

/* Sessions Tab Enhanced */
.sessions-controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
}

.sessions-grid {
    display: grid;
    gap: 1rem;
}

.session-card {
    background: #f8f9fa;
    padding: 1.5rem;
    border-radius: 10px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: all 0.3s;
    border: 2px solid transparent;
}

.session-card:hover {
    background: white;
    border-color: var(--primary);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.session-info h4 {
    color: var(--primary);
    margin-bottom: 0.5rem;
}

.session-info p {
    color: #666;
    font-size: 0.9rem;
    margin: 0.3rem 0;
}

.session-status {
    padding: 4px 12px;
    border-radius: 5px;
    font-size: 0.85rem;
    font-weight: 600;
}

.session-status.completed {
    background: #d4edda;
    color: #155724;
}

.session-status.scheduled {
    background: #d1ecf1;
    color: #0c5460;
}

.session-status.pending {
    background: #fff3cd;
    color: #856404;
}

.session-actions {
    display: flex;
    gap: 0.5rem;
}

/* Practices Tab Enhanced */
.practices-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
}

.practices-assignment {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
}

.practice-item {
    background: #f8f9fa;
    padding: 1.5rem;
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.3s;
    position: relative;
    border: 2px solid transparent;
}

.practice-item:hover {
    background: #e9ecef;
    transform: translateY(-2px);
}

.practice-item.assigned {
    background: #d4edda;
    border-color: var(--success);
}

.practice-item.assigned::after {
    content: '✓';
    position: absolute;
    top: 1rem;
    left: 1rem;
    background: var(--success);
    color: white;
    width: 25px;
    height: 25px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
}

.practice-item h4 {
    color: var(--primary);
    margin-bottom: 0.5rem;
}

.practice-item p {
    color: #666;
    font-size: 0.9rem;
}

.practice-frequency {
    display: inline-block;
    padding: 2px 8px;
    background: var(--accent);
    color: white;
    border-radius: 12px;
    font-size: 0.8rem;
    margin-top: 0.5rem;
}

/* Resources Tab Enhanced */
.resources-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1rem;
}

.resource-item {
    background: white;
    border: 2px solid #e9ecef;
    padding: 1.5rem;
    border-radius: 10px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s;
}

.resource-item:hover {
    border-color: var(--primary);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.resource-item.assigned {
    border-color: var(--accent);
    background: #fffbf0;
}

.resource-icon {
    font-size: 2rem;
    margin-bottom: 0.5rem;
}

.resource-item h4 {
    color: var(--primary);
    font-size: 1rem;
    margin-bottom: 0.3rem;
}

.resource-item p {
    color: #666;
    font-size: 0.85rem;
}

/* Messages Tab Enhanced */
.messages-container {
    height: 400px;
    overflow-y: auto;
    background: #f8f9fa;
    padding: 1.5rem;
    border-radius: 10px;
    margin-bottom: 1rem;
}

.message-item {
    display: flex;
    margin-bottom: 1rem;
    align-items: flex-start;
    animation: fadeIn 0.3s;
}

.message-item.from-coach {
    flex-direction: row-reverse;
}

.message-avatar {
    width: 40px;
    height: 40px;
    background: var(--gradient);
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    margin: 0 0.5rem;
}

.message-content {
    background: white;
    padding: 1rem;
    border-radius: 10px;
    max-width: 70%;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

.message-content.from-coach {
    background: #e3f2fd;
}

.message-time {
    font-size: 0.8rem;
    color: #999;
    margin-top: 0.3rem;
}

.message-input-area {
    display: flex;
    gap: 0.5rem;
}

.message-input {
    flex: 1;
    padding: 0.75rem;
    border: 2px solid #ddd;
    border-radius: 8px;
    font-size: 1rem;
}

/* Progress Tab Enhanced */
.progress-details {
    display: grid;
    gap: 2rem;
}

.progress-chart {
    background: white;
    padding: 2rem;
    border-radius: 10px;
    border: 2px solid #e9ecef;
}

.engagement-metrics {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
}

.metric-card {
    background: #f8f9fa;
    padding: 1.5rem;
    border-radius: 10px;
    text-align: center;
    transition: all 0.3s;
}

.metric-card:hover {
    background: white;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.metric-card h4 {
    color: #666;
    font-size: 0.9rem;
    margin-bottom: 0.5rem;
}

.metric-value {
    font-size: 2rem;
    font-weight: bold;
    color: var(--primary);
}

/* Form Elements Enhanced */
.form-group {
    margin-bottom: 1.5rem;
}

.form-group label {
    display: block;
    margin-bottom: 0.5rem;
    color: var(--primary);
    font-weight: 600;
}

.form-group input,
.form-group textarea,
.form-group select {
    width: 100%;
    padding: 0.75rem;
    border: 2px solid #ddd;
    border-radius: 8px;
    font-size: 1rem;
    transition: all 0.3s;
}

.form-group textarea {
    resize: vertical;
    min-height: 100px;
}

.form-group input:focus,
.form-group textarea:focus,
.form-group select:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(44, 85, 48, 0.1);
}

/* Action Buttons Group */
.action-buttons {
    display: flex;
    gap: 1rem;
    margin-top: 2rem;
    padding-top: 2rem;
    border-top: 2px solid #e9ecef;
}

/* Notification Enhanced */
.notification {
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 15px 25px;
    border-radius: 8px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.2);
    z-index: 10000;
    animation: slideInNotification 0.3s;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 10px;
}

@keyframes slideInNotification {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

.notification.success {
    background: var(--success);
    color: white;
}

.notification.error {
    background: var(--danger);
    color: white;
}

.notification.info {
    background: var(--info);
    color: white;
}

.notification-icon {
    font-size: 1.2rem;
}

/* Responsive Improvements */
@media (max-width: 768px) {
    .journeys-container {
        padding: 1rem;
    }
    
    .nav-links {
        gap: 1rem;
        font-size: 0.9rem;
    }
    
    .journeys-grid {
        grid-template-columns: 1fr;
    }
    
    .stats-row {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .modal-content {
        margin: 0;
        width: 100%;
        max-width: 100%;
        height: 100%;
        border-radius: 0;
    }
    
    .client-summary {
        flex-direction: column;
        text-align: center;
    }
    
    .management-tabs {
        overflow-x: scroll;
        -webkit-overflow-scrolling: touch;
    }
}

/* Print Styles */
@media print {
    .btn, .action-buttons, .nav-links {
        display: none !important;
    }
    
    .modal-content {
        box-shadow: none;
        margin: 0;
        width: 100%;
    }
}
</style>
</head>
<body>
<!-- Loading Overlay -->
<div class="loading-overlay">
    <div class="loading-spinner"></div>
</div>

<!-- Auth Check -->
<div id="authCheck" class="auth-check" style="display: none;">
    <div class="auth-message">
        <h2>غير مصرح</h2>
        <p>يجب تسجيل الدخول أولاً للوصول لهذه الصفحة</p>
        <button onclick="window.location.href='admin-dashboard.html'">
            الذهاب لصفحة الدخول
        </button>
    </div>
</div>

<!-- Main Content -->
<div id="mainContent" style="display: none;">
    <!-- Navigation -->
    <nav class="admin-nav">
        <div class="nav-container">
            <div class="nav-brand">
                <h2>لوحة تحكم محمود فؤاد</h2>
            </div>
            <div class="nav-links">
                <a href="admin-dashboard.html">
                    <span>🏠</span> الرئيسية
                </a>
                <a href="admin-bookings.html">
                    <span>📅</span> الحجوزات
                </a>
                <a href="admin-journeys.html" class="active">
                    <span>🚀</span> الرحلات
                    <span class="badge" id="activeJourneysCount">0</span>
                </a>
                <a href="#" onclick="logout()">
                    <span>🚪</span> خروج
                </a>
            </div>
        </div>
    </nav>

    <!-- Journeys Container -->
    <div class="journeys-container">
        <!-- Page Header -->
        <div class="page-header">
            <h1>إدارة الرحلات النشطة</h1>
            <p>متابعة وإدارة رحلات العملاء وتقدمهم</p>
        </div>

        <!-- Stats Row -->
        <div class="stats-row">
            <div class="stat-card">
                <h3>الرحلات النشطة</h3>
                <div class="number" id="activeCount">0</div>
            </div>
            <div class="stat-card">
                <h3>رحلات الوضوح</h3>
                <div class="number" id="clarityCount">0</div>
            </div>
            <div class="stat-card">
                <h3>رحلات الاكتشاف</h3>
                <div class="number" id="discoveryCount">0</div>
            </div>
            <div class="stat-card">
                <h3>رحلات التحول</h3>
                <div class="number" id="transformationCount">0</div>
            </div>
            <div class="stat-card">
                <h3>الرحلات المكتملة</h3>
                <div class="number" id="completedCount">0</div>
            </div>
        </div>

        <!-- Filters Section -->
        <div class="filters-section">
            <div class="filters-header">
                <h3>🔍 تصفية النتائج</h3>
                <button class="btn btn-primary" onclick="refreshData()">
                    🔄 تحديث البيانات
                </button>
            </div>
            <div class="filters-grid">
                <div class="filter-group">
                    <label>البحث</label>
                    <input type="text" id="searchInput" placeholder="بحث بالاسم أو البريد..." 
                           onkeyup="applyFilters()">
                </div>
                <div class="filter-group">
                    <label>البرنامج</label>
                    <select id="programFilter" onchange="applyFilters()">
                        <option value="">جميع البرامج</option>
                        <option value="clarity">جلسة الوضوح</option>
                        <option value="discovery">رحلة الاكتشاف</option>
                        <option value="transformation">رحلة التحول</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>الحالة</label>
                    <select id="statusFilter" onchange="applyFilters()">
                        <option value="">جميع الحالات</option>
                        <option value="active">نشطة</option>
                        <option value="paused">متوقفة</option>
                        <option value="completed">مكتملة</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>المرحلة</label>
                    <select id="phaseFilter" onchange="applyFilters()">
                        <option value="">جميع المراحل</option>
                        <option value="1">المرحلة الأولى</option>
                        <option value="2">المرحلة الثانية</option>
                        <option value="3">المرحلة الثالثة</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Journeys Grid -->
        <div id="journeysGrid" class="journeys-grid">
            <!-- سيتم ملؤها بواسطة JavaScript -->
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="empty-state" style="display: none;">
            <div class="empty-state-icon">📂</div>
            <h3 class="empty-state-message">لا توجد رحلات نشطة حالياً</h3>
            <p>ابدأ بتحويل الحجوزات المؤكدة إلى رحلات</p>
        </div>
    </div>
</div>

<!-- Journey Management Modal -->
<div id="journeyModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="modalTitle">إدارة الرحلة</h2>
            <span class="close" onclick="closeModal()">&times;</span>
        </div>
        <div class="modal-body">
            <!-- Management Tabs -->
            <div class="management-tabs">
                <button class="tab-btn active" onclick="switchTab('overview')">
                    <span class="tab-icon">📊</span>
                    نظرة عامة
                </button>
                <button class="tab-btn" onclick="switchTab('sessions')">
                    <span class="tab-icon">📅</span>
                    الجلسات
                </button>
                <button class="tab-btn" onclick="switchTab('practices')">
                    <span class="tab-icon">🎯</span>
                    الممارسات
                </button>
                <button class="tab-btn" onclick="switchTab('resources')">
                    <span class="tab-icon">📚</span>
                    الموارد
                </button>
                <button class="tab-btn" onclick="switchTab('messages')">
                    <span class="tab-icon">💬</span>
                    الرسائل
                </button>
                <button class="tab-btn" onclick="switchTab('progress')">
                    <span class="tab-icon">📈</span>
                    التقدم
                </button>
            </div>

            <!-- Tab Contents -->
            <!-- Overview Tab -->
            <div id="overviewTab" class="tab-content active">
                <div class="client-summary">
                    <div class="summary-avatar" id="clientAvatar">أ</div>
                    <div class="summary-info">
                        <h3 id="clientName">اسم العميل</h3>
                        <p id="clientEmail"><span class="info-icon">📧</span> البريد الإلكتروني</p>
                        <p id="clientPhone"><span class="info-icon">📱</span> رقم الهاتف</p>
                        <p id="clientProgram"><span class="info-icon">🎯</span> البرنامج</p>
                    </div>
                </div>

                <div class="overview-stats">
                    <div class="overview-stat">
                        <div class="value" id="sessionsCompleted">0/0</div>
                        <div class="label">الجلسات</div>
                    </div>
                    <div class="overview-stat">
                        <div class="value" id="currentPhaseDisplay">1/3</div>
                        <div class="label">المرحلة</div>
                    </div>
                    <div class="overview-stat">
                        <div class="value" id="progressPercentage">0%</div>
                        <div class="label">التقدم</div>
                    </div>
                    <div class="overview-stat">
                        <div class="value" id="practicesCount">0</div>
                        <div class="label">الممارسات</div>
                    </div>
                </div>

                <h3 style="margin-top: 2rem; margin-bottom: 1rem; color: var(--primary);">
                    🗓️ الخط الزمني للرحلة
                </h3>
                <div class="timeline" id="journeyTimeline">
                    <!-- سيتم ملؤها ديناميكياً -->
                </div>
            </div>

            <!-- Sessions Tab -->
            <div id="sessionsTab" class="tab-content">
                <div class="sessions-controls">
                    <h3>جلسات الرحلة</h3>
                    <button class="btn btn-primary" onclick="scheduleNewSession()">
                        ➕ جدولة جلسة جديدة
                    </button>
                </div>
                <div class="sessions-grid" id="sessionsList">
                    <!-- سيتم ملؤها ديناميكياً -->
                </div>
            </div>

            <!-- Practices Tab -->
            <div id="practicesTab" class="tab-content">
                <div class="practices-header">
                    <h3>الممارسات المتاحة</h3>
                    <p style="color: #666; font-size: 0.9rem;">اضغط على الممارسة لتخصيصها للعميل</p>
                </div>
                <div class="practices-assignment" id="practicesList">
                    <!-- سيتم ملؤها ديناميكياً -->
                </div>
                <div class="action-buttons">
                    <button class="btn btn-success" onclick="savePracticesAssignment()">
                        💾 حفظ التخصيصات
                    </button>
                </div>
            </div>

            <!-- Resources Tab -->
            <div id="resourcesTab" class="tab-content">
                <h3 style="margin-bottom: 1rem;">الموارد المتاحة</h3>
                <div class="resources-grid" id="resourcesList">
                    <!-- سيتم ملؤها ديناميكياً -->
                </div>
                <div class="action-buttons">
                    <button class="btn btn-success" onclick="saveResourcesAssignment()">
                        💾 حفظ التخصيصات
                    </button>
                </div>
            </div>

            <!-- Messages Tab -->
            <div id="messagesTab" class="tab-content">
                <div class="messages-container" id="messagesContainer">
                    <!-- سيتم ملؤها ديناميكياً -->
                </div>
                <div class="message-input-area">
                    <input type="text" class="message-input" id="messageInput" 
                           placeholder="اكتب رسالتك..." 
                           onkeypress="if(event.key==='Enter') sendMessage()">
                    <button class="btn btn-primary" onclick="sendMessage()">
                        📤 إرسال
                    </button>
                </div>
            </div>

            <!-- Progress Tab -->
            <div id="progressTab" class="tab-content">
                <div class="progress-details">
                    <div class="progress-chart">
                        <h3 style="margin-bottom: 1rem;">معدل الالتزام بالممارسات</h3>
                        <canvas id="progressChart" width="400" height="200"></canvas>
                    </div>
                    
                    <div class="engagement-metrics">
                        <div class="metric-card">
                            <h4>معدل الحضور</h4>
                            <div class="metric-value" id="attendanceRate">100%</div>
                        </div>
                        <div class="metric-card">
                            <h4>الممارسات المكتملة</h4>
                            <div class="metric-value" id="practicesCompleted">0</div>
                        </div>
                        <div class="metric-card">
                            <h4>معدل التفاعل</h4>
                            <div class="metric-value" id="engagementRate">85%</div>
                        </div>
                    </div>
                    
                    <div class="form-group" style="margin-top: 2rem;">
                        <label>ملاحظات التقدم:</label>
                        <textarea id="progressNotes" rows="4" 
                                  placeholder="اكتب ملاحظاتك عن تقدم العميل..."></textarea>
                        <button class="btn btn-primary" style="margin-top: 1rem;" 
                                onclick="saveProgressNotes()">
                            💾 حفظ الملاحظات
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Schedule Session Modal -->
<div id="scheduleModal" class="modal">
    <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header">
            <h2>جدولة جلسة جديدة</h2>
            <span class="close" onclick="closeScheduleModal()">&times;</span>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>التاريخ:</label>
                <input type="date" id="sessionDate" min="">
            </div>
            <div class="form-group">
                <label>الوقت:</label>
                <input type="time" id="sessionTime">
            </div>
            <div class="form-group">
                <label>نوع الجلسة:</label>
                <select id="sessionType">
                    <option value="online">أونلاين (Zoom)</option>
                    <option value="phone">مكالمة هاتفية</option>
                    <option value="inperson">حضوري</option>
                </select>
            </div>
            <div class="form-group">
                <label>رابط الجلسة (للأونلاين):</label>
                <input type="text" id="sessionLink" placeholder="https://zoom.us/j/...">
            </div>
            <div class="form-group">
                <label>ملاحظات:</label>
                <textarea id="sessionNotes" rows="3" placeholder="ملاحظات إضافية..."></textarea>
            </div>
            <div class="action-buttons">
                <button class="btn btn-secondary" onclick="closeScheduleModal()">إلغاء</button>
                <button class="btn btn-success" onclick="confirmSchedule()">تأكيد الجدولة</button>
            </div>
        </div>
    </div>
</div>

<!-- Firebase Scripts -->
<script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
<script src="firebase-config.js"></script>

<script>
// Initialize
const auth = firebase.auth();
const db = firebase.firestore();
let allJourneys = [];
let filteredJourneys = [];
let currentJourney = null;
let selectedPractices = new Set();
let selectedResources = new Set();

// Check authentication on load
window.onload = function() {
    checkAuth();
    setMinDates();
    checkUrlParams();
};

// Check authentication
function checkAuth() {
    const authToken = sessionStorage.getItem('adminAuth');
    const authTime = sessionStorage.getItem('authTime');
    const oneHour = 60 * 60 * 1000;
    
    if (authToken === 'true' && authTime && (Date.now() - parseInt(authTime) < oneHour)) {
        document.getElementById('authCheck').style.display = 'none';
        document.getElementById('mainContent').style.display = 'block';
        loadJourneys();
        
        // Refresh every 30 seconds
        setInterval(loadJourneys, 30000);
    } else {
        document.getElementById('authCheck').style.display = 'flex';
        document.getElementById('mainContent').style.display = 'none';
    }
}

// Check URL parameters
function checkUrlParams() {
    const params = new URLSearchParams(window.location.search);
    const journeyId = params.get('journey');
    
    if (journeyId) {
        // Wait for data to load then open journey
        setTimeout(() => {
            const journey = allJourneys.find(j => j.id === journeyId);
            if (journey) {
                openJourneyManagement(journey);
            }
        }, 2000);
    }
}

// Logout
function logout() {
    if (confirm('هل تريد تسجيل الخروج؟')) {
        sessionStorage.clear();
        window.location.href = 'admin-dashboard.html';
    }
}

// Set minimum dates
function setMinDates() {
    const today = new Date().toISOString().split('T')[0];
    document.querySelectorAll('input[type="date"]').forEach(input => {
        input.min = today;
    });
}

// Convert booking to journey
async function convertBookingToJourney(bookingId) {
    showLoading(true);
    
    try {
        // Get booking data
        const bookingDoc = await db.collection('bookings').doc(bookingId).get();
        if (!bookingDoc.exists) {
            throw new Error('الحجز غير موجود');
        }
        
        const booking = bookingDoc.data();
        
        // Check if journey already exists for this email and program
        const existingJourneyQuery = await db.collection('journeys')
            .where('clientEmail', '==', booking.email)
            .where('program', '==', booking.program)
            .where('status', '==', 'active')
            .get();
        
        if (!existingJourneyQuery.empty) {
            showNotification('يوجد رحلة نشطة بالفعل لهذا العميل في نفس البرنامج', 'warning');
            return;
        }
        
        // Create phases based on program
        const phases = getProgramPhases(booking.program);
        const totalSessions = getProgramSessions(booking.program);
        
        // Create journey document
        const journeyData = {
            // Client info
            clientName: booking.name,
            clientEmail: booking.email,
            clientPhone: booking.phone,
            userId: booking.userId || booking.email,
            
            // Program info
            program: booking.program,
            status: 'active',
            
            // Dates
            startDate: firebase.firestore.FieldValue.serverTimestamp(),
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            lastUpdated: firebase.firestore.FieldValue.serverTimestamp(),
            
            // Progress tracking
            currentPhase: 1,
            totalPhases: phases.length,
            progress: 0,
            
            // Sessions
            totalSessions: totalSessions,
            completedSessions: 0,
            sessionIds: [bookingId],
            
            // Engagement
            engagementScore: 100,
            lastInteraction: firebase.firestore.FieldValue.serverTimestamp(),
            
            // Empty arrays for future use
            assignedPractices: [],
            assignedResources: [],
            messages: [],
            
            // Notes
            goals: booking.goals || '',
            notes: booking.notes || '',
            challenges: booking.challenges || ''
        };
        
        // Create journey
        const journeyRef = await db.collection('journeys').add(journeyData);
        
        // Create phases subcollection
        const batch = db.batch();
        
        phases.forEach((phase, index) => {
            const phaseRef = journeyRef.collection('phases').doc();
            batch.set(phaseRef, {
                name: phase.name,
                description: phase.description,
                order: index + 1,
                status: index === 0 ? 'in_progress' : 'pending',
                startDate: index === 0 ? firebase.firestore.FieldValue.serverTimestamp() : null,
                sessionsRequired: phase.sessions || Math.ceil(totalSessions / phases.length)
            });
        });
        
        // Update booking with journey reference
        batch.update(db.collection('bookings').doc(bookingId), {
            journeyId: journeyRef.id,
            isJourneyCreated: true,
            journeyCreatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        await batch.commit();
        
        showNotification('تم إنشاء الرحلة بنجاح!', 'success');
        
        // Redirect to journey page
        setTimeout(() => {
            window.location.href = `admin-journeys.html?journey=${journeyRef.id}`;
        }, 1500);
        
    } catch (error) {
        console.error('Error creating journey:', error);
        showNotification('خطأ في إنشاء الرحلة: ' + error.message, 'error');
    } finally {
        showLoading(false);
    }
}

// Load journeys
async function loadJourneys() {
    showLoading(true);
    
    try {
        const snapshot = await db.collection('journeys')
            .orderBy('startDate', 'desc')
            .get();
        
        allJourneys = [];
        
        for (const doc of snapshot.docs) {
            const journeyData = doc.data();
            
            // Get phases subcollection
            const phasesSnapshot = await doc.ref.collection('phases')
                .orderBy('order')
                .get();
            
            const phases = [];
            phasesSnapshot.forEach(phaseDoc => {
                phases.push({
                    id: phaseDoc.id,
                    ...phaseDoc.data()
                });
            });
            
            allJourneys.push({
                id: doc.id,
                ...journeyData,
                phases: phases
            });
        }
        
        // Update stats
        updateStats();
        
        // Apply filters and display
        applyFilters();
        
        // Update badge
        const activeCount = allJourneys.filter(j => j.status === 'active').length;
        document.getElementById('activeJourneysCount').textContent = activeCount;
        document.getElementById('activeJourneysCount').style.display = activeCount > 0 ? 'inline' : 'none';
        
    } catch (error) {
        console.error('Error loading journeys:', error);
        showNotification('خطأ في تحميل البيانات', 'error');
    } finally {
        showLoading(false);
    }
}

// Update stats
function updateStats() {
    const stats = {
        active: 0,
        clarity: 0,
        discovery: 0,
        transformation: 0,
        completed: 0
    };
    
    allJourneys.forEach(journey => {
        if (journey.status === 'active') {
            stats.active++;
            switch(journey.program) {
                case 'clarity':
                    stats.clarity++;
                    break;
                case 'discovery':
                    stats.discovery++;
                    break;
                case 'transformation':
                    stats.transformation++;
                    break;
            }
        } else if (journey.status === 'completed') {
            stats.completed++;
        }
    });
    
    // Update UI with animation
    animateNumber('activeCount', stats.active);
    animateNumber('clarityCount', stats.clarity);
    animateNumber('discoveryCount', stats.discovery);
    animateNumber('transformationCount', stats.transformation);
    animateNumber('completedCount', stats.completed);
}

// Animate numbers
function animateNumber(elementId, targetValue) {
    const element = document.getElementById(elementId);
    const startValue = parseInt(element.textContent) || 0;
    const duration = 1000;
    const startTime = performance.now();
    
    function updateNumber(currentTime) {
        const elapsed = currentTime - startTime;
        const progress = Math.min(elapsed / duration, 1);
        
        const currentValue = Math.floor(startValue + (targetValue - startValue) * progress);
        element.textContent = currentValue;
        
        if (progress < 1) {
            requestAnimationFrame(updateNumber);
        }
    }
    
    requestAnimationFrame(updateNumber);
}

// Apply filters
function applyFilters() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const programFilter = document.getElementById('programFilter').value;
    const statusFilter = document.getElementById('statusFilter').value;
    const phaseFilter = document.getElementById('phaseFilter').value;
    
    filteredJourneys = allJourneys.filter(journey => {
        // Search filter
        if (searchTerm) {
            const searchableText = [
                journey.clientName,
                journey.clientEmail,
                journey.clientPhone
            ].join(' ').toLowerCase();
            
            if (!searchableText.includes(searchTerm)) {
                return false;
            }
        }
        
        // Program filter
        if (programFilter && journey.program !== programFilter) {
            return false;
        }
        
        // Status filter
        if (statusFilter && journey.status !== statusFilter) {
            return false;
        }
        
        // Phase filter
        if (phaseFilter && journey.currentPhase?.toString() !== phaseFilter) {
            return false;
        }
        
        return true;
    });
    
    displayJourneys();
}

// Display journeys
function displayJourneys() {
    const container = document.getElementById('journeysGrid');
    const emptyState = document.getElementById('emptyState');
    
    if (filteredJourneys.length === 0) {
        container.style.display = 'none';
        emptyState.style.display = 'block';
        return;
    }
    
    container.style.display = 'grid';
    emptyState.style.display = 'none';
    
    let html = '';
    
    filteredJourneys.forEach((journey, index) => {
        const progress = journey.progress || 0;
        const currentPhase = journey.currentPhase || 1;
        const totalPhases = journey.totalPhases || getProgramPhases(journey.program).length;
        const completedSessions = journey.completedSessions || 0;
        const totalSessions = journey.totalSessions || getProgramSessions(journey.program);
        const engagementScore = journey.engagementScore || 85;
        
        // Determine engagement level
        let engagementClass = 'high';
        if (engagementScore < 60) engagementClass = 'low';
        else if (engagementScore < 80) engagementClass = 'medium';
        
        // Check if needs attention
        const needsAttention = engagementScore < 70 || 
                             (journey.lastInteraction && daysSince(journey.lastInteraction) > 7);
        
        html += `
            <div class="journey-card ${needsAttention ? 'priority' : ''}" 
                 onclick="openJourneyManagement('${journey.id}')"
                 style="animation-delay: ${index * 0.1}s">
                
                <span class="engagement-indicator ${engagementClass}"></span>
                
                <div class="journey-header">
                    <div class="client-info">
                        <div class="client-avatar">${getInitial(journey.clientName)}</div>
                        <div class="client-details">
                            <h3>${journey.clientName || 'غير محدد'}</h3>
                            <p>${journey.clientEmail}</p>
                        </div>
                    </div>
                    <span class="journey-status">${getStatusName(journey.status)}</span>
                </div>
                
                <div class="journey-body">
                    <div class="program-info">
                        <div class="program-name">
                            ${getProgramIcon(journey.program)} ${getProgramName(journey.program)}
                        </div>
                        <div class="phase-indicator">
                            <span>📍</span>
                            <span>المرحلة ${currentPhase} من ${totalPhases}</span>
                        </div>
                    </div>
                    
                    <div class="progress-section">
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${progress}%"></div>
                        </div>
                        <div class="progress-text">
                            <span>التقدم العام</span>
                            <span>${progress}%</span>
                        </div>
                    </div>
                    
                    <div class="journey-meta">
                        <div class="meta-item">
                            <div class="meta-value">${completedSessions}/${totalSessions}</div>
                            <div class="meta-label">الجلسات</div>
                        </div>
                        <div class="meta-item">
                            <div class="meta-value">${journey.assignedPractices?.length || 0}</div>
                            <div class="meta-label">الممارسات</div>
                        </div>
                        <div class="meta-item">
                            <div class="meta-value">${journey.assignedResources?.length || 0}</div>
                            <div class="meta-label">الموارد</div>
                        </div>
                    </div>
                    
                    <div class="journey-actions">
                        <button class="btn btn-primary" onclick="event.stopPropagation(); openJourneyManagement('${journey.id}')">
                            ⚙️ إدارة الرحلة
                        </button>
                        <button class="btn btn-whatsapp" onclick="event.stopPropagation(); openWhatsApp('${journey.clientPhone}', '${journey.clientName}')">
                            💬 واتساب
                        </button>
                    </div>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

// Open journey management
async function openJourneyManagement(journeyId) {
    currentJourney = allJourneys.find(j => j.id === journeyId);
    
    if (!currentJourney) {
        showNotification('الرحلة غير موجودة', 'error');
        return;
    }
    
    // Update modal title
    document.getElementById('modalTitle').textContent = 
        `إدارة رحلة ${currentJourney.clientName} - ${getProgramName(currentJourney.program)}`;
    
    // Reset tabs
    switchTab('overview');
    
    // Load journey details
    await loadJourneyDetails();
    
    // Show modal
    document.getElementById('journeyModal').style.display = 'block';
}

// Load journey details
async function loadJourneyDetails() {
    if (!currentJourney) return;
    
    // Update client info
    document.getElementById('clientAvatar').textContent = getInitial(currentJourney.clientName);
    document.getElementById('clientName').textContent = currentJourney.clientName || 'غير محدد';
    document.getElementById('clientEmail').textContent = currentJourney.clientEmail;
    document.getElementById('clientPhone').textContent = currentJourney.clientPhone;
    document.getElementById('clientProgram').textContent = getProgramName(currentJourney.program);
    
    // Update stats
    const completedSessions = currentJourney.completedSessions || 0;
    const totalSessions = currentJourney.totalSessions || getProgramSessions(currentJourney.program);
    const currentPhase = currentJourney.currentPhase || 1;
    const totalPhases = currentJourney.totalPhases || getProgramPhases(currentJourney.program).length;
    const progress = currentJourney.progress || 0;
    const practicesCount = currentJourney.assignedPractices?.length || 0;
    
    document.getElementById('sessionsCompleted').textContent = `${completedSessions}/${totalSessions}`;
    document.getElementById('currentPhaseDisplay').textContent = `${currentPhase}/${totalPhases}`;
    document.getElementById('progressPercentage').textContent = `${progress}%`;
    document.getElementById('practicesCount').textContent = practicesCount;
    
    // Load timeline
    loadTimeline();
    
    // Initialize practices and resources selections
    selectedPractices = new Set(currentJourney.assignedPractices?.map(p => p.practiceId) || []);
    selectedResources = new Set(currentJourney.assignedResources?.map(r => r.resourceId) || []);
}

// Load timeline
function loadTimeline() {
    const timeline = document.getElementById('journeyTimeline');
    
    if (!currentJourney.phases || currentJourney.phases.length === 0) {
        timeline.innerHTML = '<p>لا توجد مراحل محددة</p>';
        return;
    }
    
    let html = '';
    
    currentJourney.phases.forEach((phase, index) => {
        const isCompleted = phase.status === 'completed';
        const isCurrent = phase.status === 'in_progress';
        
        let dateStr = 'لم تبدأ';
        if (phase.startDate) {
            const date = phase.startDate.toDate ? phase.startDate.toDate() : new Date(phase.startDate);
            dateStr = date.toLocaleDateString('ar-EG');
        }
        
        html += `
            <div class="timeline-item ${isCompleted ? 'completed' : ''} ${isCurrent ? 'current' : ''}">
                <div class="timeline-content">
                    <div class="timeline-header">
                        <span class="timeline-title">المرحلة ${phase.order}: ${phase.name}</span>
                        <span class="timeline-date">${dateStr}</span>
                    </div>
                    <p>${phase.description || ''}</p>
                    ${isCurrent ? '<span style="color: var(--warning); font-weight: 600;">المرحلة الحالية</span>' : ''}
                </div>
            </div>
        `;
    });
    
    timeline.innerHTML = html;
}

// Switch tabs
function switchTab(tabName) {
    // Update tab buttons
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Find and activate the clicked tab button
    const tabButtons = document.querySelectorAll('.tab-btn');
    tabButtons.forEach(btn => {
        if (btn.onclick?.toString().includes(tabName)) {
            btn.classList.add('active');
        }
    });
    
    // Hide all tab contents
    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
    });
    
    // Show selected tab
    document.getElementById(tabName + 'Tab').classList.add('active');
    
    // Load tab content
    switch(tabName) {
        case 'sessions':
            loadSessionsTab();
            break;
        case 'practices':
            loadPracticesTab();
            break;
        case 'resources':
            loadResourcesTab();
            break;
        case 'messages':
            loadMessagesTab();
            break;
        case 'progress':
            loadProgressTab();
            break;
    }
}

// Load sessions tab
async function loadSessionsTab() {
    const container = document.getElementById('sessionsList');
    
    try {
        // Get all bookings for this journey
        const bookingsSnapshot = await db.collection('bookings')
            .where('journeyId', '==', currentJourney.id)
            .orderBy('createdAt', 'desc')
            .get();
        
        if (bookingsSnapshot.empty) {
            // Check by email and program as fallback
            const emailBookingsSnapshot = await db.collection('bookings')
                .where('email', '==', currentJourney.clientEmail)
                .where('program', '==', currentJourney.program)
                .orderBy('createdAt', 'desc')
                .get();
            
            if (emailBookingsSnapshot.empty) {
                container.innerHTML = '<p style="text-align: center; color: #666;">لا توجد جلسات محجوزة بعد</p>';
                return;
            }
            
            // Use email bookings
            displaySessions(emailBookingsSnapshot);
        } else {
            displaySessions(bookingsSnapshot);
        }
        
    } catch (error) {
        console.error('Error loading sessions:', error);
        container.innerHTML = '<p style="color: #dc3545;">خطأ في تحميل الجلسات</p>';
    }
}

// Display sessions
function displaySessions(snapshot) {
    const container = document.getElementById('sessionsList');
    let html = '';
    let sessionNumber = 1;
    
    snapshot.forEach(doc => {
        const booking = doc.data();
        let sessionDate = 'لم يحدد';
        let sessionStatus = 'pending';
        
        if (booking.appointmentDate) {
            const date = booking.appointmentDate.toDate ? 
                booking.appointmentDate.toDate() : new Date(booking.appointmentDate);
            sessionDate = date.toLocaleDateString('ar-EG');
            
            if (booking.appointmentTime) {
                sessionDate += ' - ' + booking.appointmentTime;
            }
            
            // Determine status
            if (booking.status === 'completed') {
                sessionStatus = 'completed';
            } else if (date < new Date()) {
                sessionStatus = 'completed';
            } else {
                sessionStatus = 'scheduled';
            }
        }
        
        html += `
            <div class="session-card">
                <div class="session-info">
                    <h4>جلسة ${sessionNumber}</h4>
                    <p>📅 ${sessionDate}</p>
                    <p>💻 ${getSessionTypeName(booking.sessionType)}</p>
                </div>
                <div class="session-actions">
                    <span class="session-status ${sessionStatus}">${getSessionStatusName(sessionStatus)}</span>
                    ${booking.sessionLink && sessionStatus === 'scheduled' ? 
                        `<button class="btn btn-primary btn-sm" onclick="window.open('${booking.sessionLink}', '_blank')">رابط الجلسة</button>` : ''}
                    ${sessionStatus === 'completed' ? 
                        `<button class="btn btn-info btn-sm" onclick="completeSession('${doc.id}')">✓ تأكيد الإكمال</button>` : ''}
                </div>
            </div>
        `;
        
        sessionNumber++;
    });
    
    container.innerHTML = html;
}

// Load practices tab
function loadPracticesTab() {
    const container = document.getElementById('practicesList');
    
    const allPractices = [
        {
            id: 'practice_1',
            title: 'المثلث القلبي',
            description: 'ممارسة يومية للانفتاح والحضور والتحرك القلبي',
            category: 'daily',
            programs: ['all']
        },
        {
            id: 'practice_2',
            title: 'دفتر الامتنان',
            description: 'سجل 3 أشياء تشعر بالامتنان لها يومياً',
            category: 'daily',
            programs: ['all']
        },
        {
            id: 'practice_3',
            title: 'تأمل الحضور',
            description: '10 دقائق من التأمل اليومي',
            category: 'daily',
            programs: ['discovery', 'transformation']
        },
        {
            id: 'practice_4',
            title: 'تمرين الهوية الصباحي',
            description: 'تجسيد هويتك الجديدة كل صباح',
            category: 'daily',
            programs: ['transformation']
        },
        {
            id: 'practice_5',
            title: 'يوميات القائد الحكيم',
            description: 'تسجيل يومي لإنجازاتك وتحدياتك',
            category: 'daily',
            programs: ['transformation']
        },
        {
            id: 'practice_6',
            title: 'تمرين الوضوح الصباحي',
            description: '5 دقائق لتحديد هدفك اليومي',
            category: 'daily',
            programs: ['clarity']
        }
    ];
    
    // Filter practices based on program
    const programPractices = allPractices.filter(p => 
        p.programs.includes('all') || p.programs.includes(currentJourney.program)
    );
    
    let html = '';
    
    programPractices.forEach(practice => {
        const isAssigned = selectedPractices.has(practice.id);
        
        html += `
            <div class="practice-item ${isAssigned ? 'assigned' : ''}" 
                 onclick="togglePractice('${practice.id}')"
                 data-practice-id="${practice.id}">
                <h4>${practice.title}</h4>
                <p>${practice.description}</p>
                <span class="practice-frequency">
                    ${practice.category === 'daily' ? 'يومياً' : 'أسبوعياً'}
                </span>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

// Load resources tab
function loadResourcesTab() {
    const container = document.getElementById('resourcesList');
    
    const allResources = [
        {
            id: 'resource_1',
            title: 'كيف تحدد أهدافك بوضوح',
            type: 'article',
            icon: '📄',
            programs: ['clarity']
        },
        {
            id: 'resource_2',
            title: 'قوة الوعي الذاتي',
            type: 'video',
            icon: '🎥',
            programs: ['discovery']
        },
        {
            id: 'resource_3',
            title: 'ورقة عمل التوازن',
            type: 'worksheet',
            icon: '📝',
            programs: ['discovery']
        },
        {
            id: 'resource_4',
            title: 'قوة الآن',
            type: 'book',
            icon: '📚',
            programs: ['transformation']
        },
        {
            id: 'resource_5',
            title: 'تأملات التحول',
            type: 'meditation',
            icon: '🧘',
            programs: ['transformation']
        },
        {
            id: 'resource_6',
            title: 'دليل الممارسات اليومية',
            type: 'guide',
            icon: '📖',
            programs: ['all']
        }
    ];
    
    // Filter resources based on program
    const programResources = allResources.filter(r => 
        r.programs.includes('all') || r.programs.includes(currentJourney.program)
    );
    
    let html = '';
    
    programResources.forEach(resource => {
        const isAssigned = selectedResources.has(resource.id);
        
        html += `
            <div class="resource-item ${isAssigned ? 'assigned' : ''}" 
                 onclick="toggleResource('${resource.id}')"
                 data-resource-id="${resource.id}">
                <div class="resource-icon">${resource.icon}</div>
                <h4>${resource.title}</h4>
                <p>${getResourceTypeName(resource.type)}</p>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

// Load messages tab
async function loadMessagesTab() {
    const container = document.getElementById('messagesContainer');
    
    // Get messages from journey
    const messages = currentJourney.messages || [];
    
    if (messages.length === 0) {
        container.innerHTML = `
            <div style="text-align: center; color: #666; padding: 2rem;">
                <p>لا توجد رسائل بعد</p>
                <p>ابدأ المحادثة بإرسال رسالة ترحيب</p>
            </div>
        `;
        return;
    }
    
    let html = '';
    
    messages.forEach(message => {
        const isFromCoach = message.from === 'coach';
        
        html += `
            <div class="message-item ${isFromCoach ? 'from-coach' : ''}">
                <div class="message-avatar">
                    ${isFromCoach ? 'م' : getInitial(currentJourney.clientName)}
                </div>
                <div class="message-content ${isFromCoach ? 'from-coach' : ''}">
                    <div>${message.content}</div>
                    <div class="message-time">${formatTime(message.timestamp)}</div>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
    
    // Scroll to bottom
    container.scrollTop = container.scrollHeight;
}

// Load progress tab
function loadProgressTab() {
    // Load progress notes
    document.getElementById('progressNotes').value = currentJourney.progressNotes || '';
    
    // Update metrics
    updateProgressMetrics();
    
    // Draw progress chart
    drawProgressChart();
}

// Update progress metrics
function updateProgressMetrics() {
    if (!currentJourney) return;
    
    // Calculate attendance rate
    const completedSessions = currentJourney.completedSessions || 0;
    const totalSessions = currentJourney.totalSessions || getProgramSessions(currentJourney.program);
    const attendanceRate = totalSessions > 0 ? 
        Math.round((completedSessions / totalSessions) * 100) : 100;
    
    document.getElementById('attendanceRate').textContent = attendanceRate + '%';
    
    // Calculate practices completion
    const practicesCompleted = currentJourney.practicesCompleted || 0;
    document.getElementById('practicesCompleted').textContent = practicesCompleted;
    
    // Calculate engagement rate
    const engagementRate = currentJourney.engagementScore || 85;
    document.getElementById('engagementRate').textContent = engagementRate + '%';
}

// Draw progress chart
function drawProgressChart() {
    const canvas = document.getElementById('progressChart');
    const ctx = canvas.getContext('2d');
    
    // Clear canvas
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    // Sample data for practices completion over time
    const data = [
        { day: 'السبت', completed: 3 },
        { day: 'الأحد', completed: 2 },
        { day: 'الإثنين', completed: 3 },
        { day: 'الثلاثاء', completed: 1 },
        { day: 'الأربعاء', completed: 3 },
        { day: 'الخميس', completed: 2 },
        { day: 'الجمعة', completed: 3 }
    ];
    
    const chartWidth = canvas.width - 60;
    const chartHeight = canvas.height - 60;
    const barWidth = chartWidth / data.length * 0.6;
    const maxValue = Math.max(...data.map(d => d.completed));
    
    // Draw axes
    ctx.strokeStyle = '#e0e0e0';
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.moveTo(40, 20);
    ctx.lineTo(40, chartHeight + 20);
    ctx.lineTo(chartWidth + 40, chartHeight + 20);
    ctx.stroke();
    
    // Draw bars
    data.forEach((item, index) => {
        const x = 40 + (index * (chartWidth / data.length)) + (chartWidth / data.length - barWidth) / 2;
        const barHeight = (item.completed / maxValue) * chartHeight;
        const y = chartHeight + 20 - barHeight;
        
        // Bar
        ctx.fillStyle = '#2C5530';
        ctx.fillRect(x, y, barWidth, barHeight);
        
        // Value on top
        ctx.fillStyle = '#333';
        ctx.font = '12px Arial';
        ctx.textAlign = 'center';
        ctx.fillText(item.completed, x + barWidth / 2, y - 5);
        
        // Day label
        ctx.fillText(item.day, x + barWidth / 2, chartHeight + 35);
    });
    
    // Y-axis labels
    ctx.textAlign = 'right';
    for (let i = 0; i <= maxValue; i++) {
        const y = chartHeight + 20 - (i / maxValue * chartHeight);
        ctx.fillText(i, 35, y + 5);
    }
}

// Toggle practice assignment
function togglePractice(practiceId) {
    const practiceElement = document.querySelector(`[data-practice-id="${practiceId}"]`);
    
    if (selectedPractices.has(practiceId)) {
        selectedPractices.delete(practiceId);
        practiceElement.classList.remove('assigned');
    } else {
        selectedPractices.add(practiceId);
        practiceElement.classList.add('assigned');
    }
}

// Toggle resource assignment
function toggleResource(resourceId) {
    const resourceElement = document.querySelector(`[data-resource-id="${resourceId}"]`);
    
    if (selectedResources.has(resourceId)) {
        selectedResources.delete(resourceId);
        resourceElement.classList.remove('assigned');
    } else {
        selectedResources.add(resourceId);
        resourceElement.classList.add('assigned');
    }
}

// Save practices assignment
async function savePracticesAssignment() {
    if (!currentJourney) return;
    
    showLoading(true);
    
    try {
        const practices = Array.from(selectedPractices).map(id => ({
            practiceId: id,
            assignedDate: firebase.firestore.FieldValue.serverTimestamp(),
            frequency: 'daily',
            completions: []
        }));
        
        await db.collection('journeys').doc(currentJourney.id).update({
            assignedPractices: practices,
            lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        showNotification('تم حفظ الممارسات المخصصة بنجاح', 'success');
        
        // Update local data
        currentJourney.assignedPractices = practices;
        
        // Reload journey list
        await loadJourneys();
        
    } catch (error) {
        console.error('Error saving practices:', error);
        showNotification('خطأ في حفظ الممارسات', 'error');
    } finally {
        showLoading(false);
    }
}

// Save resources assignment
async function saveResourcesAssignment() {
    if (!currentJourney) return;
    
    showLoading(true);
    
    try {
        const resources = Array.from(selectedResources).map(id => ({
            resourceId: id,
            assignedDate: firebase.firestore.FieldValue.serverTimestamp(),
            viewed: false,
            notes: ''
        }));
        
        await db.collection('journeys').doc(currentJourney.id).update({
            assignedResources: resources,
            lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        showNotification('تم حفظ الموارد المخصصة بنجاح', 'success');
        
        // Update local data
        currentJourney.assignedResources = resources;
        
        // Reload journey list
        await loadJourneys();
        
    } catch (error) {
        console.error('Error saving resources:', error);
        showNotification('خطأ في حفظ الموارد', 'error');
    } finally {
        showLoading(false);
    }
}

// Send message
async function sendMessage() {
    const input = document.getElementById('messageInput');
    const message = input.value.trim();
    
    if (!message || !currentJourney) return;
    
    try {
        // Add message to journey
        const messageData = {
            type: 'message',
            from: 'coach',
            content: message,
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            read: false
        };
        
        await db.collection('journeys').doc(currentJourney.id).update({
            messages: firebase.firestore.FieldValue.arrayUnion(messageData),
            lastMessageDate: firebase.firestore.FieldValue.serverTimestamp(),
            lastInteraction: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // Clear input
        input.value = '';
        
        // Add message locally
        if (!currentJourney.messages) {
            currentJourney.messages = [];
        }
        currentJourney.messages.push({
            ...messageData,
            timestamp: new Date()
        });
        
        // Reload messages
        loadMessagesTab();
        
        showNotification('تم إرسال الرسالة بنجاح', 'success');
        
    } catch (error) {
        console.error('Error sending message:', error);
        showNotification('خطأ في إرسال الرسالة', 'error');
    }
}

// Save progress notes
async function saveProgressNotes() {
    const notes = document.getElementById('progressNotes').value;
    
    if (!currentJourney) return;
    
    showLoading(true);
    
    try {
        await db.collection('journeys').doc(currentJourney.id).update({
            progressNotes: notes,
            progressNotesUpdatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        showNotification('تم حفظ الملاحظات بنجاح', 'success');
        
    } catch (error) {
        console.error('Error saving notes:', error);
        showNotification('خطأ في حفظ الملاحظات', 'error');
    } finally {
        showLoading(false);
    }
}

// Schedule new session
function scheduleNewSession() {
    document.getElementById('scheduleModal').style.display = 'block';
    
    // Set default values
    const tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);
    document.getElementById('sessionDate').value = tomorrow.toISOString().split('T')[0];
    document.getElementById('sessionTime').value = '10:00';
}

// Confirm session schedule
async function confirmSchedule() {
    const date = document.getElementById('sessionDate').value;
    const time = document.getElementById('sessionTime').value;
    const type = document.getElementById('sessionType').value;
    const link = document.getElementById('sessionLink').value;
    const notes = document.getElementById('sessionNotes').value;
    
    if (!date || !time) {
        showNotification('من فضلك أدخل التاريخ والوقت', 'error');
        return;
    }
    
    showLoading(true);
    
    try {
        // Create session booking
        const sessionData = {
            journeyId: currentJourney.id,
            email: currentJourney.clientEmail,
            name: currentJourney.clientName,
            phone: currentJourney.clientPhone,
            program: currentJourney.program,
            sessionNumber: (currentJourney.completedSessions || 0) + 1,
            appointmentDate: new Date(date + ' ' + time),
            appointmentTime: time,
            sessionType: type,
            sessionLink: link,
            notes: notes,
            status: 'confirmed',
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        const sessionRef = await db.collection('bookings').add(sessionData);
        
        // Update journey
        await db.collection('journeys').doc(currentJourney.id).update({
            sessionIds: firebase.firestore.FieldValue.arrayUnion(sessionRef.id),
            nextSessionId: sessionRef.id,
            nextSessionDate: sessionData.appointmentDate,
            lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        showNotification('تم جدولة الجلسة بنجاح', 'success');
        closeScheduleModal();
        
        // Reload sessions
        loadSessionsTab();
        
    } catch (error) {
        console.error('Error scheduling session:', error);
        showNotification('خطأ في جدولة الجلسة', 'error');
    } finally {
        showLoading(false);
    }
}

// Complete session
async function completeSession(sessionId) {
    if (!confirm('هل تريد تحديد هذه الجلسة كمكتملة؟')) return;
    
    showLoading(true);
    
    try {
        // Update session status
        await db.collection('bookings').doc(sessionId).update({
            status: 'completed',
            completedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // Update journey progress
        const newCompletedSessions = (currentJourney.completedSessions || 0) + 1;
        const totalSessions = currentJourney.totalSessions || getProgramSessions(currentJourney.program);
        const newProgress = Math.round((newCompletedSessions / totalSessions) * 100);
        
        await db.collection('journeys').doc(currentJourney.id).update({
            completedSessions: newCompletedSessions,
            progress: newProgress,
            lastSessionDate: firebase.firestore.FieldValue.serverTimestamp(),
            lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // Check if need to update phase
        await updateJourneyPhase(newCompletedSessions);
        
        showNotification('تم تحديث حالة الجلسة بنجاح', 'success');
        
        // Reload data
        await loadJourneys();
        await loadJourneyDetails();
        loadSessionsTab();
        
    } catch (error) {
        console.error('Error completing session:', error);
        showNotification('خطأ في تحديث الجلسة', 'error');
    } finally {
        showLoading(false);
    }
}

// Update journey phase
async function updateJourneyPhase(completedSessions) {
    if (!currentJourney) return;
    
    const totalSessions = currentJourney.totalSessions || getProgramSessions(currentJourney.program);
    const phases = currentJourney.phases || [];
    const sessionsPerPhase = Math.ceil(totalSessions / phases.length);
    
    const newPhase = Math.min(Math.ceil(completedSessions / sessionsPerPhase), phases.length);
    
    if (newPhase > currentJourney.currentPhase) {
        // Update current phase
        await db.collection('journeys').doc(currentJourney.id).update({
            currentPhase: newPhase
        });
        
        // Update phase statuses
        const batch = db.batch();
        
        // Mark previous phase as completed
        if (currentJourney.currentPhase > 0) {
            const prevPhase = phases[currentJourney.currentPhase - 1];
            if (prevPhase) {
                batch.update(
                    db.collection('journeys').doc(currentJourney.id)
                        .collection('phases').doc(prevPhase.id),
                    {
                        status: 'completed',
                        completedDate: firebase.firestore.FieldValue.serverTimestamp()
                    }
                );
            }
        }
        
        // Mark new phase as in progress
        if (newPhase <= phases.length) {
            const newPhaseDoc = phases[newPhase - 1];
            if (newPhaseDoc) {
                batch.update(
                    db.collection('journeys').doc(currentJourney.id)
                        .collection('phases').doc(newPhaseDoc.id),
                    {
                        status: 'in_progress',
                        startDate: firebase.firestore.FieldValue.serverTimestamp()
                    }
                );
            }
        }
        
        await batch.commit();
        
        // Check if journey completed
        if (completedSessions >= totalSessions) {
            await completeJourney();
        }
    }
}

// Complete journey
async function completeJourney() {
    await db.collection('journeys').doc(currentJourney.id).update({
        status: 'completed',
        completedDate: firebase.firestore.FieldValue.serverTimestamp(),
        progress: 100
    });
    
    showNotification('🎉 تهانينا! تم إكمال الرحلة بنجاح', 'success');
}

// Refresh data
function refreshData() {
    loadJourneys();
    showNotification('تم تحديث البيانات', 'info');
}

// Open WhatsApp
function openWhatsApp(phone, name) {
    const cleanPhone = phone.replace(/\D/g, '');
    const fullPhone = cleanPhone.startsWith('2') ? cleanPhone : '2' + cleanPhone;
    
    const message = `مرحباً ${name}،\n\nأتمنى أن تكون بخير.\n\n`;
    
    window.open(`https://wa.me/${fullPhone}?text=${encodeURIComponent(message)}`, '_blank');
}

// Helper functions
function getProgramName(program) {
    const names = {
        clarity: 'جلسة الوضوح',
        discovery: 'رحلة الاكتشاف',
        transformation: 'رحلة التحول'
    };
    return names[program] || program;
}

function getProgramIcon(program) {
    const icons = {
        clarity: '💡',
        discovery: '🔍',
        transformation: '🦋'
    };
    return icons[program] || '🚀';
}

function getProgramSessions(program) {
    const sessions = {
        clarity: 1,
        discovery: 3,
        transformation: 6
    };
    return sessions[program] || 1;
}

function getProgramPhases(program) {
    const phases = {
        clarity: [
            { name: 'جلسة الوضوح', description: 'جلسة واحدة مكثفة', sessions: 1 }
        ],
        discovery: [
            { name: 'اكتشاف الذات', description: 'فهم الأنماط والقيم', sessions: 1 },
            { name: 'بناء الوعي', description: 'تحديد نقاط القوة', sessions: 1 },
            { name: 'خطة العمل', description: 'رسم خارطة التغيير', sessions: 1 }
        ],
        transformation: [
            { name: 'الإنبات', description: 'كشف الجذور', sessions: 2 },
            { name: 'النمو', description: 'بناء الهوية', sessions: 2 },
            { name: 'الازدهار', description: 'دمج التغيير', sessions: 2 }
        ]
    };
    return phases[program] || [];
}

function getStatusName(status) {
    const names = {
        active: 'نشطة',
        paused: 'متوقفة',
        completed: 'مكتملة',
        cancelled: 'ملغية'
    };
    return names[status] || status;
}

function getSessionTypeName(type) {
    const names = {
        online: 'أونلاين',
        phone: 'هاتفي',
        inperson: 'حضوري'
    };
    return names[type] || type;
}

function getSessionStatusName(status) {
    const names = {
        pending: 'في الانتظار',
        scheduled: 'مجدولة',
        completed: 'مكتملة',
        cancelled: 'ملغية'
    };
    return names[status] || status;
}

function getResourceTypeName(type) {
    const names = {
        article: 'مقال',
        video: 'فيديو',
        worksheet: 'ورقة عمل',
        book: 'كتاب',
        meditation: 'تأمل',
        guide: 'دليل'
    };
    return names[type] || type;
}

function formatDate(timestamp) {
    if (!timestamp) return 'غير محدد';
    const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
    return date.toLocaleDateString('ar-EG');
}

function formatTime(timestamp) {
    if (!timestamp) return '';
    const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
    return date.toLocaleTimeString('ar-EG', {
        hour: '2-digit',
        minute: '2-digit'
    });
}

function daysSince(timestamp) {
    if (!timestamp) return 0;
    const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
    const diff = Date.now() - date.getTime();
    return Math.floor(diff / (1000 * 60 * 60 * 24));
}

function getInitial(name) {
    return name ? name.charAt(0).toUpperCase() : '؟';
}

function showLoading(show) {
    document.querySelector('.loading-overlay').style.display = show ? 'flex' : 'none';
}

function showNotification(message, type = 'success') {
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    
    const icon = {
        success: '✓',
        error: '✗',
        info: 'ℹ',
        warning: '⚠'
    };
    
    notification.innerHTML = `
        <span class="notification-icon">${icon[type] || icon.info}</span>
        <span>${message}</span>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.opacity = '1';
        notification.style.transform = 'translateX(0)';
    }, 10);
    
    setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => notification.remove(), 300);
    }, 3000);
    
    notification.onclick = () => notification.remove();
}

function closeModal() {
    document.getElementById('journeyModal').style.display = 'none';
    currentJourney = null;
    selectedPractices.clear();
    selectedResources.clear();
}

function closeScheduleModal() {
    document.getElementById('scheduleModal').style.display = 'none';
    
    // Reset form
    document.getElementById('sessionDate').value = '';
    document.getElementById('sessionTime').value = '';
    document.getElementById('sessionType').value = 'online';
    document.getElementById('sessionLink').value = '';
    document.getElementById('sessionNotes').value = '';
}

// Initialize when DOM loaded
document.addEventListener('DOMContentLoaded', function() {
    checkAuth();
    
    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeModal();
            closeScheduleModal();
        }
    });
    
    // Click outside modal to close
    window.onclick = function(event) {
        if (event.target.classList.contains('modal')) {
            event.target.style.display = 'none';
        }
    }
});
</script>
</body>
</html>
