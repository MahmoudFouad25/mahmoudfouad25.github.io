<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ŸÑŸàÿ≠ÿ© ÿßŸÑÿ™ÿ≠ŸÉŸÖ - ŸÖÿ≠ŸÖŸàÿØ ŸÅÿ§ÿßÿØ</title>
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üë®‚Äçüíº</text></svg>">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary: #2C5530;
            --secondary: #8B9467;
            --accent: #D4AF37;
            --light: #F5F2E8;
            --dark: #1A1A1A;
            --gradient: linear-gradient(135deg, #2C5530 0%, #8B9467 100%);
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Arial, sans-serif;
            background: #F5F2E8;
            color: #1A1A1A;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        h1 {
            color: #2C5530;
            text-align: center;
            margin-bottom: 30px;
        }
        
        /* Notification System */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 5px;
            z-index: 1000;
            animation: slideIn 0.3s;
            cursor: pointer;
        }
        
        .notification.success {
            background: #28a745;
            color: white;
        }
        
        .notification.error {
            background: #dc3545;
            color: white;
        }
        
        .notification.info {
            background: #17a2b8;
            color: white;
        }
        
        .notification.warning {
            background: #ffc107;
            color: #333;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #2C5530;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Stats Cards */
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
            transition: transform 0.3s;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .stat-number {
            font-size: 2.5em;
            color: #2C5530;
            font-weight: bold;
        }
        
        .stat-label {
            color: #666;
            margin-top: 5px;
        }
        
        .stat-change {
            font-size: 0.9em;
            margin-top: 5px;
        }
        
        .stat-change.positive {
            color: #28a745;
        }
        
        .stat-change.negative {
            color: #dc3545;
        }
        
        /* View Toggle */
        .view-toggle {
            background: white;
            padding: 10px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .view-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            background: #e9ecef;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .view-btn.active {
            background: var(--gradient);
            color: white;
        }
        
        .view-btn:hover {
            transform: translateY(-2px);
        }
        
        /* Filters */
        .filters {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .filters select, .filters input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        
        .search-box {
            flex: 1;
            min-width: 200px;
        }
        
        /* Main Content Area */
        .content-area {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        /* Journeys View */
        .journeys-view {
            padding: 20px;
        }
        
        .journey-item {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .journey-item:hover {
            background: #e9ecef;
            transform: translateX(-5px);
        }
        
        .journey-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .client-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .client-avatar {
            width: 50px;
            height: 50px;
            background: var(--gradient);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.2rem;
        }
        
        .client-details h3 {
            color: var(--primary);
            margin-bottom: 5px;
        }
        
        .client-details p {
            color: #666;
            font-size: 0.9rem;
        }
        
        .journey-status {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
        }
        
        .journey-status.active {
            background: #d4edda;
            color: #155724;
        }
        
        .journey-status.completed {
            background: #cce5ff;
            color: #004085;
        }
        
        .journey-status.pending {
            background: #fff3cd;
            color: #856404;
        }
        
        .journey-progress {
            margin-bottom: 15px;
        }
        
        .progress-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.9rem;
            color: #666;
        }
        
        .progress-bar {
            width: 100%;
            height: 10px;
            background: #e9ecef;
            border-radius: 5px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: var(--gradient);
            transition: width 0.5s ease;
        }
        
        .journey-meta {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .meta-item {
            display: flex;
            align-items: center;
            gap: 5px;
            color: #666;
            font-size: 0.9rem;
        }
        
        .journey-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        /* Table View */
        .table-view {
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1200px;
        }
        
        th {
            background: #2C5530;
            color: white;
            padding: 15px;
            text-align: right;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        td {
            padding: 15px;
            border-bottom: 1px solid #eee;
        }
        
        tr:hover {
            background: #f9f9f9;
        }
        
        /* Status Badges */
        .status {
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.9em;
            font-weight: bold;
        }
        
        .status-pending { background: #fff3cd; color: #856404; }
        .status-confirming { background: #d1ecf1; color: #0c5460; }
        .status-confirmed { background: #d4edda; color: #155724; }
        .status-completed { background: #cce5ff; color: #004085; }
        .status-cancelled { background: #f8d7da; color: #721c24; }
        
        /* Buttons */
        .btn {
            padding: 5px 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8em;
            margin: 2px;
            transition: all 0.3s;
        }
        
        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-warning { background: #ffc107; color: black; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-info { background: #17a2b8; color: white; }
        .btn-whatsapp { background: #25d366; color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        
        /* Login Form */
        .login-form {
            max-width: 400px;
            margin: 100px auto;
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
        }
        
        .login-form h2 {
            color: #2C5530;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .login-form input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        
        .login-form button {
            width: 100%;
            padding: 10px;
            background: #2C5530;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        
        .login-form button:hover {
            background: #1e3a21;
        }
        
        /* Modals */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 2% auto;
            padding: 30px;
            border-radius: 10px;
            width: 95%;
            max-width: 1200px;
            max-height: 90vh;
            overflow-y: auto;
            animation: fadeIn 0.3s;
        }
        
        .modal-content.small {
            max-width: 600px;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
        
        .close {
            color: #aaa;
            float: left;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover {
            color: black;
        }
        
        /* Journey Management Modal */
        .journey-management {
            display: grid;
            gap: 20px;
        }
        
        .management-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 20px;
            border-bottom: 2px solid #eee;
        }
        
        .client-summary {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .client-summary .avatar {
            width: 80px;
            height: 80px;
            background: var(--gradient);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 2rem;
            font-weight: bold;
        }
        
        .client-summary .info h2 {
            color: var(--primary);
            margin-bottom: 5px;
        }
        
        .client-summary .info p {
            color: #666;
        }
        
        .management-tabs {
            display: flex;
            gap: 10px;
            border-bottom: 2px solid #eee;
            margin-bottom: 20px;
        }
        
        .tab-btn {
            padding: 10px 20px;
            background: none;
            border: none;
            cursor: pointer;
            color: #666;
            font-size: 1rem;
            position: relative;
            transition: all 0.3s;
        }
        
        .tab-btn.active {
            color: var(--primary);
        }
        
        .tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            right: 0;
            width: 100%;
            height: 2px;
            background: var(--primary);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Journey Timeline */
        .timeline {
            position: relative;
            padding-right: 30px;
        }
        
        .timeline::before {
            content: '';
            position: absolute;
            right: 10px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #e9ecef;
        }
        
        .timeline-item {
            position: relative;
            padding-bottom: 30px;
        }
        
        .timeline-item::before {
            content: '';
            position: absolute;
            right: 0;
            top: 5px;
            width: 20px;
            height: 20px;
            background: white;
            border: 3px solid var(--primary);
            border-radius: 50%;
            z-index: 1;
        }
        
        .timeline-item.completed::before {
            background: var(--primary);
        }
        
        .timeline-content {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-right: 30px;
        }
        
        .timeline-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .timeline-title {
            font-weight: bold;
            color: var(--primary);
        }
        
        .timeline-date {
            color: #666;
            font-size: 0.9rem;
        }
        
        /* Sessions Management */
        .sessions-grid {
            display: grid;
            gap: 15px;
        }
        
        .session-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .session-info h4 {
            color: var(--primary);
            margin-bottom: 5px;
        }
        
        .session-info p {
            color: #666;
            font-size: 0.9rem;
        }
        
        /* Practices Assignment */
        .practices-assignment {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
        }
        
        .practice-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }
        
        .practice-item:hover {
            background: #e9ecef;
            transform: translateY(-2px);
        }
        
        .practice-item.assigned {
            background: #d4edda;
            border: 2px solid #28a745;
        }
        
        .practice-item.assigned::after {
            content: '‚úì';
            position: absolute;
            top: 10px;
            left: 10px;
            background: #28a745;
            color: white;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        /* Resources Assignment */
        .resources-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }
        
        .resource-item {
            background: white;
            border: 2px solid #e9ecef;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .resource-item:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
        }
        
        .resource-item.assigned {
            border-color: var(--accent);
            background: #fffbf0;
        }
        
        .resource-icon {
            font-size: 2rem;
            margin-bottom: 10px;
        }
        
        /* Messages Section */
        .messages-container {
            height: 400px;
            overflow-y: auto;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .message-item {
            display: flex;
            margin-bottom: 15px;
            align-items: flex-start;
        }
        
        .message-item.from-coach {
            flex-direction: row-reverse;
        }
        
        .message-avatar {
            width: 40px;
            height: 40px;
            background: var(--gradient);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            margin: 0 10px;
        }
        
        .message-content {
            background: white;
            padding: 10px 15px;
            border-radius: 10px;
            max-width: 70%;
        }
        
        .message-content.from-coach {
            background: #e3f2fd;
        }
        
        .message-time {
            font-size: 0.8rem;
            color: #999;
            margin-top: 5px;
        }
        
        .message-input-area {
            display: flex;
            gap: 10px;
        }
        
        .message-input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        
        /* Form Groups */
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #2C5530;
        }
        
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        
        /* Stats Section */
        .client-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-box {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        
        .stat-box .value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary);
        }
        
        .stat-box .label {
            color: #666;
            font-size: 0.9rem;
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 50px;
            color: #999;
        }
        
        .empty-state img {
            width: 100px;
            opacity: 0.5;
            margin-bottom: 20px;
        }
        
        /* User Menu */
        .user-menu {
            position: absolute;
            top: 20px;
            left: 20px;
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .user-menu button {
            margin: 5px;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .stats {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .filters {
                flex-direction: column;
                align-items: stretch;
            }
            
            .journey-actions {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
            
            .user-menu {
                position: relative;
                top: 0;
                left: 0;
                margin-bottom: 20px;
            }
            
            .modal-content {
                margin: 5% auto;
                width: 95%;
            }
            
            .management-tabs {
                overflow-x: auto;
                white-space: nowrap;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay">
        <div class="loading-spinner"></div>
    </div>
    
    <!-- Login Section -->
    <div id="loginSection" class="login-form">
        <h2>ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ</h2>
        <div id="loginError" style="color: red; margin-bottom: 10px; display: none;"></div>
        <input type="password" id="password" placeholder="ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±" 
               onkeypress="if(event.key==='Enter') login()">
        <button onclick="login()">ÿØÿÆŸàŸÑ</button>
        <p style="margin-top: 20px; color: #666; font-size: 14px; text-align: center;">
            ŸÑŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± ÿ™ŸàÿßÿµŸÑ ŸÖÿπ ÿßŸÑÿØÿπŸÖ ÿßŸÑŸÅŸÜŸä
        </p>
    </div>
    
    <!-- Admin Panel -->
    <div id="adminPanel" class="container" style="display: none;">
        <!-- User Menu -->
        <div class="user-menu">
            <span>ŸÖÿ±ÿ≠ÿ®ÿßŸãÿå ÿßŸÑÿ£ÿØŸÖŸÜ</span>
            <button class="btn btn-secondary" onclick="showSettings()">‚öôÔ∏è ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™</button>
            <button class="btn btn-danger" onclick="logout()">üö™ ÿÆÿ±Ÿàÿ¨</button>
        </div>
        
        <h1>ŸÑŸàÿ≠ÿ© ÿßŸÑÿ™ÿ≠ŸÉŸÖ</h1>
        
        <!-- Statistics -->
        <div class="stats">
            <div class="stat-card">
                <div class="stat-number" id="totalJourneys">0</div>
                <div class="stat-label">ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿ±ÿ≠ŸÑÿßÿ™</div>
                <div class="stat-change positive" id="journeysChange">+0% Ÿáÿ∞ÿß ÿßŸÑÿ¥Ÿáÿ±</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="activeJourneys">0</div>
                <div class="stat-label">ÿ±ÿ≠ŸÑÿßÿ™ ŸÜÿ¥ÿ∑ÿ©</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="todaySessions">0</div>
                <div class="stat-label">ÿ¨ŸÑÿ≥ÿßÿ™ ÿßŸÑŸäŸàŸÖ</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="completionRate">0%</div>
                <div class="stat-label">ŸÖÿπÿØŸÑ ÿßŸÑÿ•ŸÉŸÖÿßŸÑ</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalRevenue">0 ÿ¨ŸÜŸäŸá</div>
                <div class="stat-label">ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿ•Ÿäÿ±ÿßÿØÿßÿ™</div>
                <div class="stat-change positive" id="revenueChange">+0% Ÿáÿ∞ÿß ÿßŸÑÿ¥Ÿáÿ±</div>
            </div>
        </div>
        
        <!-- View Toggle -->
        <div class="view-toggle">
            <button class="view-btn active" onclick="switchView('journeys')">üó∫Ô∏è ÿπÿ±ÿ∂ ÿßŸÑÿ±ÿ≠ŸÑÿßÿ™</button>
            <button class="view-btn" onclick="switchView('table')">üìä ÿπÿ±ÿ∂ ÿßŸÑÿ¨ÿØŸàŸÑ</button>
            <button class="view-btn" onclick="switchView('calendar')">üìÖ ÿπÿ±ÿ∂ ÿßŸÑÿ™ŸÇŸàŸäŸÖ</button>
        </div>
        
        <!-- Filters -->
        <div class="filters">
            <input type="text" class="search-box" id="searchBox" 
                   placeholder="ÿ®ÿ≠ÿ´ ÿ®ÿßŸÑÿßÿ≥ŸÖ ÿ£Ÿà ÿßŸÑŸáÿßÿ™ŸÅ ÿ£Ÿà ÿßŸÑÿ®ÿ±ŸäÿØ..." 
                   onkeyup="searchClients()">
            
            <label>ÿßŸÑÿ®ÿ±ŸÜÿßŸÖÿ¨:</label>
            <select id="programFilter" onchange="filterData()">
                <option value="">ÿßŸÑŸÉŸÑ</option>
                <option value="clarity">ÿ¨ŸÑÿ≥ÿ© ÿßŸÑŸàÿ∂Ÿàÿ≠</option>
                <option value="discovery">ÿ±ÿ≠ŸÑÿ© ÿßŸÑÿßŸÉÿ™ÿ¥ÿßŸÅ</option>
                <option value="transformation">ÿ±ÿ≠ŸÑÿ© ÿßŸÑÿ™ÿ≠ŸàŸÑ</option>
            </select>
            
            <label>ÿßŸÑÿ≠ÿßŸÑÿ©:</label>
            <select id="statusFilter" onchange="filterData()">
                <option value="">ÿßŸÑŸÉŸÑ</option>
                <option value="active">ŸÜÿ¥ÿ∑ÿ©</option>
                <option value="pending">ŸÅŸä ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ±</option>
                <option value="completed">ŸÖŸÉÿ™ŸÖŸÑÿ©</option>
                <option value="paused">ŸÖÿ™ŸàŸÇŸÅÿ©</option>
            </select>
            
            <button class="btn btn-success" onclick="refreshData()">üîÑ ÿ™ÿ≠ÿØŸäÿ´</button>
            <button class="btn btn-primary" onclick="exportData()">üì• ÿ™ÿµÿØŸäÿ± Excel</button>
        </div>
        
        <!-- Main Content Area -->
        <div class="content-area">
            <!-- Journeys View -->
            <div id="journeysView" class="journeys-view">
                <div id="journeysList">
                    <!-- ÿ≥Ÿäÿ™ŸÖ ŸÖŸÑÿ§Ÿáÿß ÿ®ŸÄ JavaScript -->
                </div>
            </div>
            
            <!-- Table View -->
            <div id="tableView" class="table-view" style="display: none;">
                <table>
                    <thead>
                        <tr>
                            <th>ÿßŸÑÿπŸÖŸäŸÑ</th>
                            <th>ÿßŸÑÿ®ÿ±ŸÜÿßŸÖÿ¨</th>
                            <th>ÿßŸÑŸÖÿ±ÿ≠ŸÑÿ©</th>
                            <th>ÿßŸÑÿ™ŸÇÿØŸÖ</th>
                            <th>ÿßŸÑÿ¨ŸÑÿ≥ÿ© ÿßŸÑŸÇÿßÿØŸÖÿ©</th>
                            <th>ÿßŸÑÿ≠ÿßŸÑÿ©</th>
                            <th>ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°ÿßÿ™</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <!-- ÿ≥Ÿäÿ™ŸÖ ŸÖŸÑÿ§Ÿáÿß ÿ®ŸÄ JavaScript -->
                    </tbody>
                </table>
            </div>
            
            <!-- Calendar View -->
            <div id="calendarView" class="calendar-view" style="display: none;">
                <!-- ÿ≥Ÿäÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑÿ™ŸÇŸàŸäŸÖ ŸÑÿßÿ≠ŸÇÿßŸã -->
                <div class="empty-state">
                    <p>ÿπÿ±ÿ∂ ÿßŸÑÿ™ŸÇŸàŸäŸÖ ŸÇŸäÿØ ÿßŸÑÿ™ÿ∑ŸàŸäÿ±</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Journey Management Modal -->
    <div id="journeyModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('journeyModal')">&times;</span>
            
            <div class="journey-management">
                <!-- Client Summary -->
                <div class="management-header">
                    <div class="client-summary">
                        <div class="avatar" id="clientAvatar">ÿ£</div>
                        <div class="info">
                            <h2 id="clientName">ÿßÿ≥ŸÖ ÿßŸÑÿπŸÖŸäŸÑ</h2>
                            <p id="clientInfo">ÿßŸÑÿ®ÿ±ŸäÿØ | ÿßŸÑŸáÿßÿ™ŸÅ</p>
                        </div>
                    </div>
                    <div class="journey-status" id="journeyStatusBadge">ŸÜÿ¥ÿ∑ÿ©</div>
                </div>
                
                <!-- Management Tabs -->
                <div class="management-tabs">
                    <button class="tab-btn active" onclick="switchTab('overview')">ŸÜÿ∏ÿ±ÿ© ÿπÿßŸÖÿ©</button>
                    <button class="tab-btn" onclick="switchTab('sessions')">ÿßŸÑÿ¨ŸÑÿ≥ÿßÿ™</button>
                    <button class="tab-btn" onclick="switchTab('practices')">ÿßŸÑŸÖŸÖÿßÿ±ÿ≥ÿßÿ™</button>
                    <button class="tab-btn" onclick="switchTab('resources')">ÿßŸÑŸÖŸàÿßÿ±ÿØ</button>
                    <button class="tab-btn" onclick="switchTab('messages')">ÿßŸÑÿ±ÿ≥ÿßÿ¶ŸÑ</button>
                    <button class="tab-btn" onclick="switchTab('progress')">ÿßŸÑÿ™ŸÇÿØŸÖ</button>
                </div>
                
                <!-- Tab Contents -->
                <!-- Overview Tab -->
                <div id="overviewTab" class="tab-content active">
                    <div class="client-stats">
                        <div class="stat-box">
                            <div class="value" id="clientSessions">0/6</div>
                            <div class="label">ÿßŸÑÿ¨ŸÑÿ≥ÿßÿ™</div>
                        </div>
                        <div class="stat-box">
                            <div class="value" id="clientProgress">0%</div>
                            <div class="label">ÿßŸÑÿ™ŸÇÿØŸÖ</div>
                        </div>
                        <div class="stat-box">
                            <div class="value" id="clientPractices">0</div>
                            <div class="label">ÿßŸÑŸÖŸÖÿßÿ±ÿ≥ÿßÿ™ ÿßŸÑŸÜÿ¥ÿ∑ÿ©</div>
                        </div>
                        <div class="stat-box">
                            <div class="value" id="clientEngagement">0%</div>
                            <div class="label">ŸÖÿπÿØŸÑ ÿßŸÑŸÖÿ¥ÿßÿ±ŸÉÿ©</div>
                        </div>
                    </div>
                    
                    <h3>ÿßŸÑÿÆÿ∑ ÿßŸÑÿ≤ŸÖŸÜŸä ŸÑŸÑÿ±ÿ≠ŸÑÿ©</h3>
                    <div class="timeline" id="journeyTimeline">
                        <!-- ÿ≥Ÿäÿ™ŸÖ ŸÖŸÑÿ§Ÿáÿß ÿ®ŸÄ JavaScript -->
                    </div>
                </div>
                
                <!-- Sessions Tab -->
                <div id="sessionsTab" class="tab-content">
                    <button class="btn btn-primary" onclick="scheduleSession()">+ ÿ¨ÿØŸàŸÑÿ© ÿ¨ŸÑÿ≥ÿ© ÿ¨ÿØŸäÿØÿ©</button>
                    <div class="sessions-grid" id="sessionsList">
                        <!-- ÿ≥Ÿäÿ™ŸÖ ŸÖŸÑÿ§Ÿáÿß ÿ®ŸÄ JavaScript -->
                    </div>
                </div>
                
                <!-- Practices Tab -->
                <div id="practicesTab" class="tab-content">
                    <h3>ÿßŸÑŸÖŸÖÿßÿ±ÿ≥ÿßÿ™ ÿßŸÑŸÖÿ™ÿßÿ≠ÿ©</h3>
                    <div class="practices-assignment" id="practicesList">
                        <!-- ÿ≥Ÿäÿ™ŸÖ ŸÖŸÑÿ§Ÿáÿß ÿ®ŸÄ JavaScript -->
                    </div>
                    <button class="btn btn-success" onclick="savePracticesAssignment()">ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿÆÿµŸäÿµÿßÿ™</button>
                </div>
                
                <!-- Resources Tab -->
                <div id="resourcesTab" class="tab-content">
                    <h3>ÿßŸÑŸÖŸàÿßÿ±ÿØ ÿßŸÑŸÖÿ™ÿßÿ≠ÿ©</h3>
                    <div class="resources-grid" id="resourcesList">
                        <!-- ÿ≥Ÿäÿ™ŸÖ ŸÖŸÑÿ§Ÿáÿß ÿ®ŸÄ JavaScript -->
                    </div>
                    <button class="btn btn-success" onclick="saveResourcesAssignment()">ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿÆÿµŸäÿµÿßÿ™</button>
                </div>
                
                <!-- Messages Tab -->
                <div id="messagesTab" class="tab-content">
                    <div class="messages-container" id="messagesContainer">
                        <!-- ÿ≥Ÿäÿ™ŸÖ ŸÖŸÑÿ§Ÿáÿß ÿ®ŸÄ JavaScript -->
                    </div>
                    <div class="message-input-area">
                        <input type="text" class="message-input" id="messageInput" placeholder="ÿßŸÉÿ™ÿ® ÿ±ÿ≥ÿßŸÑÿ™ŸÉ...">
                        <button class="btn btn-primary" onclick="sendMessage()">ÿ•ÿ±ÿ≥ÿßŸÑ</button>
                    </div>
                </div>
                
                <!-- Progress Tab -->
                <div id="progressTab" class="tab-content">
                    <h3>ÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑÿ™ŸÇÿØŸÖ</h3>
                    <canvas id="progressChart" width="400" height="200"></canvas>
                    <div class="form-group">
                        <label>ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™ ÿßŸÑÿ™ŸÇÿØŸÖ:</label>
                        <textarea id="progressNotes" rows="4"></textarea>
                        <button class="btn btn-primary" onclick="saveProgressNotes()">ÿ≠ŸÅÿ∏ ÿßŸÑŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Schedule Session Modal -->
    <div id="scheduleModal" class="modal">
        <div class="modal-content small">
            <span class="close" onclick="closeModal('scheduleModal')">&times;</span>
            <h2>ÿ¨ÿØŸàŸÑÿ© ÿ¨ŸÑÿ≥ÿ© ÿ¨ÿØŸäÿØÿ©</h2>
            
            <div class="form-group">
                <label>ÿßŸÑÿ™ÿßÿ±ŸäÿÆ:</label>
                <input type="date" id="sessionDate" min="">
            </div>
            
            <div class="form-group">
                <label>ÿßŸÑŸàŸÇÿ™:</label>
                <input type="time" id="sessionTime">
            </div>
            
            <div class="form-group">
                <label>ŸÜŸàÿπ ÿßŸÑÿ¨ŸÑÿ≥ÿ©:</label>
                <select id="sessionType">
                    <option value="online">ÿ£ŸàŸÜŸÑÿßŸäŸÜ (Zoom)</option>
                    <option value="phone">ŸÖŸÉÿßŸÑŸÖÿ© Ÿáÿßÿ™ŸÅŸäÿ©</option>
                    <option value="inperson">ÿ≠ÿ∂Ÿàÿ±Ÿä</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>ÿ±ÿßÿ®ÿ∑ ÿßŸÑÿ¨ŸÑÿ≥ÿ© (ŸÑŸÑÿ£ŸàŸÜŸÑÿßŸäŸÜ):</label>
                <input type="text" id="sessionLink" placeholder="zoom.us/j/...">
            </div>
            
            <div class="form-group">
                <label>ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™:</label>
                <textarea id="sessionNotes" rows="3"></textarea>
            </div>
            
            <button class="btn btn-success" onclick="confirmSchedule()">ÿ™ÿ£ŸÉŸäÿØ ÿßŸÑÿ¨ÿØŸàŸÑÿ©</button>
        </div>
    </div>
    
    <!-- Settings Modal -->
    <div id="settingsModal" class="modal">
        <div class="modal-content small">
            <span class="close" onclick="closeModal('settingsModal')">&times;</span>
            <h2>ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™</h2>
            
            <div class="form-group">
                <label>ÿ™ÿ∫ŸäŸäÿ± ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±:</label>
                <input type="password" id="oldPassword" placeholder="ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± ÿßŸÑÿ≠ÿßŸÑŸäÿ©">
                <input type="password" id="newPassword" placeholder="ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± ÿßŸÑÿ¨ÿØŸäÿØÿ©">
                <input type="password" id="confirmPassword" placeholder="ÿ™ÿ£ŸÉŸäÿØ ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±">
                <button class="btn btn-primary" onclick="changePassword()">ÿ™ÿ∫ŸäŸäÿ±</button>
            </div>
            
            <div class="form-group">
                <label>ÿ±ŸÇŸÖ Ÿàÿßÿ™ÿ≥ÿßÿ® ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™:</label>
                <input type="tel" id="notificationPhone" value="201224938330">
                <button class="btn btn-success" onclick="saveSettings()">ÿ≠ŸÅÿ∏</button>
            </div>
        </div>
    </div>
    
    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js"></script>
    
    <script>
        // Initialize
        const auth = firebase.auth();
        const db = firebase.firestore();
        let allJourneys = [];
        let allBookings = [];
        let filteredData = [];
        let currentView = 'journeys';
        let currentJourney = null;
        let currentClient = null;
        let cacheTime = null;
        let cachedData = null;
        
        // Security - Password Hash
        const ADMIN_HASH = 'bWFobW91ZDIwMjQ='; // mahmoud2024
        
        // Set minimum date for date inputs
        document.addEventListener('DOMContentLoaded', () => {
            const today = new Date().toISOString().split('T')[0];
            document.querySelectorAll('input[type="date"]').forEach(input => {
                input.min = today;
            });
        });
        
        // Check session on load
        window.onload = function() {
            const auth = sessionStorage.getItem('adminAuth');
            const authTime = sessionStorage.getItem('authTime');
            const oneHour = 60 * 60 * 1000;
            
            if (auth === 'true' && authTime && (Date.now() - parseInt(authTime) < oneHour)) {
                document.getElementById('loginSection').style.display = 'none';
                document.getElementById('adminPanel').style.display = 'block';
                loadData();
            }
        };
        
        // Auto logout after 1 hour
        setInterval(() => {
            const authTime = sessionStorage.getItem('authTime');
            if (authTime && (Date.now() - parseInt(authTime) > 60 * 60 * 1000)) {
                showNotification('ÿßŸÜÿ™Ÿáÿ™ ÿµŸÑÿßÿ≠Ÿäÿ© ÿßŸÑÿ¨ŸÑÿ≥ÿ©ÿå ÿ≥Ÿäÿ™ŸÖ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨', 'error');
                setTimeout(() => {
                    logout();
                }, 3000);
            }
        }, 60000);
        
        // Login function
        function login() {
            const password = document.getElementById('password').value;
            const hashedInput = btoa(password);
            
            if (hashedInput === ADMIN_HASH) {
                sessionStorage.setItem('adminAuth', 'true');
                sessionStorage.setItem('authTime', Date.now().toString());
                
                document.getElementById('loginSection').style.display = 'none';
                document.getElementById('adminPanel').style.display = 'block';
                
                showNotification('ÿ™ŸÖ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿ®ŸÜÿ¨ÿßÿ≠', 'success');
                loadData();
            } else {
                document.getElementById('loginError').textContent = 'ŸÉŸÑŸÖÿ© ŸÖÿ±Ÿàÿ± ÿÆÿßÿ∑ÿ¶ÿ©';
                document.getElementById('loginError').style.display = 'block';
                document.getElementById('password').value = '';
            }
        }
        
        // Logout
        function logout() {
            if (confirm('ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨ÿü')) {
                sessionStorage.clear();
                location.reload();
            }
        }
        
        // Show notification
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            notification.onclick = () => notification.remove();
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 5000);
        }
        
        // Show loading
        function showLoading(show) {
            document.querySelector('.loading-overlay').style.display = show ? 'flex' : 'none';
        }
        
        // Load all data
        async function loadData(forceRefresh = false) {
            // Check cache first
            if (!forceRefresh && cachedData && cacheTime && 
                (Date.now() - cacheTime < 5 * 60 * 1000)) {
                allJourneys = cachedData.journeys;
                allBookings = cachedData.bookings;
                filteredData = [...allJourneys];
                displayData();
                updateStats();
                return;
            }
            
            showLoading(true);
            
            try {
                // Load journeys
                const journeysSnapshot = await db.collection('journeys')
                    .orderBy('startDate', 'desc')
                    .get();
                
                allJourneys = [];
                for (const doc of journeysSnapshot.docs) {
                    const journeyData = doc.data();
                    
                    // Get user data
                    const userDoc = await db.collection('users').doc(journeyData.userId).get();
                    const userData = userDoc.exists ? userDoc.data() : {};
                    
                    // Get phases
                    const phasesSnapshot = await db.collection('journeys')
                        .doc(doc.id)
                        .collection('phases')
                        .orderBy('order')
                        .get();
                    
                    const phases = [];
                    phasesSnapshot.forEach(phaseDoc => {
                        phases.push({ id: phaseDoc.id, ...phaseDoc.data() });
                    });
                    
                    allJourneys.push({
                        id: doc.id,
                        ...journeyData,
                        user: userData,
                        phases: phases
                    });
                }
                
                // Load bookings
                const bookingsSnapshot = await db.collection('bookings')
                    .orderBy('createdAt', 'desc')
                    .get();
                
                allBookings = [];
                bookingsSnapshot.forEach(doc => {
                    allBookings.push({ id: doc.id, ...doc.data() });
                });
                
                // Cache data
                cachedData = { journeys: allJourneys, bookings: allBookings };
                cacheTime = Date.now();
                
                filteredData = [...allJourneys];
                displayData();
                updateStats();
                
                showNotification(`ÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ ${allJourneys.length} ÿ±ÿ≠ŸÑÿ©`, 'success');
                
            } catch (error) {
                console.error('Error loading data:', error);
                showNotification('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™', 'error');
            } finally {
                showLoading(false);
            }
        }
        
        // Refresh data
        function refreshData() {
            showNotification('ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™...', 'info');
            loadData(true);
        }
        
        // Display data based on current view
        function displayData() {
            switch (currentView) {
                case 'journeys':
                    displayJourneys();
                    break;
                case 'table':
                    displayTable();
                    break;
                case 'calendar':
                    displayCalendar();
                    break;
            }
        }
        
        // Display journeys view
        function displayJourneys() {
            const container = document.getElementById('journeysList');
            
            if (filteredData.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <p>ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ±ÿ≠ŸÑÿßÿ™</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            filteredData.forEach(journey => {
                const user = journey.user || {};
                const progress = journey.progress || 0;
                const currentPhase = journey.currentPhase || 1;
                const totalPhases = journey.totalPhases || 3;
                
                html += `
                    <div class="journey-item" onclick="openJourneyManagement('${journey.id}')">
                        <div class="journey-header">
                            <div class="client-info">
                                <div class="client-avatar">${getInitial(user.name)}</div>
                                <div class="client-details">
                                    <h3>${user.name || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'}</h3>
                                    <p>${user.email || ''} | ${user.phone || ''}</p>
                                </div>
                            </div>
                            <div class="journey-status ${journey.status || 'active'}">${getStatusName(journey.status)}</div>
                        </div>
                        
                        <div class="journey-progress">
                            <div class="progress-info">
                                <span>${getProgramName(journey.program)}</span>
                                <span>${progress}%</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${progress}%"></div>
                            </div>
                        </div>
                        
                        <div class="journey-meta">
                            <div class="meta-item">
                                <span>üìÖ</span>
                                <span>ÿßŸÑŸÖÿ±ÿ≠ŸÑÿ© ${currentPhase} ŸÖŸÜ ${totalPhases}</span>
                            </div>
                            <div class="meta-item">
                                <span>üïê</span>
                                <span>${getNextSession(journey)}</span>
                            </div>
                            <div class="meta-item">
                                <span>üéØ</span>
                                <span>${journey.assignedPractices?.length || 0} ŸÖŸÖÿßÿ±ÿ≥ÿßÿ™</span>
                            </div>
                            <div class="meta-item">
                                <span>üìö</span>
                                <span>${journey.assignedResources?.length || 0} ŸÖŸàÿßÿ±ÿØ</span>
                            </div>
                        </div>
                        
                        <div class="journey-actions">
                            <button class="btn btn-primary" onclick="event.stopPropagation(); openJourneyManagement('${journey.id}')">
                                ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿ±ÿ≠ŸÑÿ©
                            </button>
                            <button class="btn btn-whatsapp" onclick="event.stopPropagation(); sendWhatsApp('${user.phone}', '${user.name}')">
                                Ÿàÿßÿ™ÿ≥ÿßÿ®
                            </button>
                            <button class="btn btn-info" onclick="event.stopPropagation(); viewReport('${journey.id}')">
                                ÿ™ŸÇÿ±Ÿäÿ±
                            </button>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // Display table view
        function displayTable() {
            const tbody = document.getElementById('tableBody');
            
            if (filteredData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="empty-state">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™</td>
                    </tr>
                `;
                return;
            }
            
            let html = '';
            filteredData.forEach(journey => {
                const user = journey.user || {};
                const progress = journey.progress || 0;
                const currentPhase = journey.currentPhase || 1;
                const totalPhases = journey.totalPhases || 3;
                
                html += `
                    <tr>
                        <td>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <div class="client-avatar" style="width: 30px; height: 30px; font-size: 0.9rem;">
                                    ${getInitial(user.name)}
                                </div>
                                <div>
                                    <div style="font-weight: bold;">${user.name || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'}</div>
                                    <div style="font-size: 0.8rem; color: #666;">${user.email || ''}</div>
                                </div>
                            </div>
                        </td>
                        <td>${getProgramName(journey.program)}</td>
                        <td>${currentPhase} ŸÖŸÜ ${totalPhases}</td>
                        <td>
                            <div class="progress-bar" style="width: 100px;">
                                <div class="progress-fill" style="width: ${progress}%"></div>
                            </div>
                            <span style="font-size: 0.8rem;">${progress}%</span>
                        </td>
                        <td>${getNextSession(journey)}</td>
                        <td><span class="status status-${journey.status || 'active'}">${getStatusName(journey.status)}</span></td>
                        <td>
                            <button class="btn btn-primary btn-sm" onclick="openJourneyManagement('${journey.id}')">ÿ•ÿØÿßÿ±ÿ©</button>
                            <button class="btn btn-whatsapp btn-sm" onclick="sendWhatsApp('${user.phone}', '${user.name}')">Ÿàÿßÿ™ÿ≥ÿßÿ®</button>
                        </td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
        }
        
        // Display calendar view
        function displayCalendar() {
            // Placeholder for calendar implementation
            showNotification('ÿπÿ±ÿ∂ ÿßŸÑÿ™ŸÇŸàŸäŸÖ ŸÇŸäÿØ ÿßŸÑÿ™ÿ∑ŸàŸäÿ±', 'info');
        }
        
        // Switch view
        function switchView(view) {
            currentView = view;
            
            // Update buttons
            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Hide all views
            document.getElementById('journeysView').style.display = 'none';
            document.getElementById('tableView').style.display = 'none';
            document.getElementById('calendarView').style.display = 'none';
            
            // Show selected view
            document.getElementById(view + 'View').style.display = 'block';
            
            displayData();
        }
        
        // Open journey management modal
        async function openJourneyManagement(journeyId) {
            currentJourney = allJourneys.find(j => j.id === journeyId);
            if (!currentJourney) return;
            
            currentClient = currentJourney.user;
            
            // Update client summary
            document.getElementById('clientAvatar').textContent = getInitial(currentClient.name);
            document.getElementById('clientName').textContent = currentClient.name || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ';
            document.getElementById('clientInfo').textContent = `${currentClient.email || ''} | ${currentClient.phone || ''}`;
            document.getElementById('journeyStatusBadge').textContent = getStatusName(currentJourney.status);
            document.getElementById('journeyStatusBadge').className = `journey-status ${currentJourney.status || 'active'}`;
            
            // Reset tabs
            switchTab('overview');
            
            // Load overview
            loadOverviewTab();
            
            // Show modal
            document.getElementById('journeyModal').style.display = 'block';
        }
        
        // Switch tabs in journey management
        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            // Load tab content
            switch (tabName) {
                case 'overview':
                    loadOverviewTab();
                    break;
                case 'sessions':
                    loadSessionsTab();
                    break;
                case 'practices':
                    loadPracticesTab();
                    break;
                case 'resources':
                    loadResourcesTab();
                    break;
                case 'messages':
                    loadMessagesTab();
                    break;
                case 'progress':
                    loadProgressTab();
                    break;
            }
        }
        
        // Load overview tab
        function loadOverviewTab() {
            if (!currentJourney) return;
            
            // Update stats
            const totalSessions = getProgramSessions(currentJourney.program);
            const completedSessions = currentJourney.completedSessions || 0;
            
            document.getElementById('clientSessions').textContent = `${completedSessions}/${totalSessions}`;
            document.getElementById('clientProgress').textContent = `${currentJourney.progress || 0}%`;
            document.getElementById('clientPractices').textContent = currentJourney.assignedPractices?.length || 0;
            document.getElementById('clientEngagement').textContent = calculateEngagement(currentJourney) + '%';
            
            // Load timeline
            loadTimeline();
        }
        
        // Load timeline
        function loadTimeline() {
            const timeline = document.getElementById('journeyTimeline');
            timeline.innerHTML = '';
            
            if (!currentJourney.phases || currentJourney.phases.length === 0) {
                timeline.innerHTML = '<p>ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖÿ±ÿßÿ≠ŸÑ ŸÖÿ≠ÿØÿØÿ©</p>';
                return;
            }
            
            currentJourney.phases.forEach(phase => {
                const isCompleted = phase.status === 'completed';
                const isCurrent = phase.status === 'in_progress';
                
                const timelineItem = document.createElement('div');
                timelineItem.className = `timeline-item ${isCompleted ? 'completed' : ''}`;
                
                let dateStr = 'ŸÑŸÖ ÿ™ÿ®ÿØÿ£';
                if (phase.startDate) {
                    const date = phase.startDate.toDate ? phase.startDate.toDate() : new Date(phase.startDate);
                    dateStr = date.toLocaleDateString('ar-EG');
                }
                
                timelineItem.innerHTML = `
                    <div class="timeline-content">
                        <div class="timeline-header">
                            <span class="timeline-title">ÿßŸÑŸÖÿ±ÿ≠ŸÑÿ© ${phase.order}: ${phase.name}</span>
                            <span class="timeline-date">${dateStr}</span>
                        </div>
                        <p>${phase.description || ''}</p>
                        ${isCurrent ? '<span class="badge" style="background: var(--accent);">ÿßŸÑŸÖÿ±ÿ≠ŸÑÿ© ÿßŸÑÿ≠ÿßŸÑŸäÿ©</span>' : ''}
                    </div>
                `;
                
                timeline.appendChild(timelineItem);
            });
        }
        
        // Load sessions tab
        function loadSessionsTab() {
            const sessionsList = document.getElementById('sessionsList');
            sessionsList.innerHTML = '';
            
            // Get bookings for this journey
            const journeyBookings = allBookings.filter(b => 
                b.userId === currentJourney.userId || 
                b.email === currentClient.email
            );
            
            if (journeyBookings.length === 0) {
                sessionsList.innerHTML = '<p>ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ¨ŸÑÿ≥ÿßÿ™ ŸÖÿ≠ÿ¨Ÿàÿ≤ÿ©</p>';
                return;
            }
            
            journeyBookings.forEach((booking, index) => {
                const sessionCard = document.createElement('div');
                sessionCard.className = 'session-card';
                
                let sessionDate = 'ŸÑŸÖ Ÿäÿ≠ÿØÿØ';
                if (booking.appointmentDate) {
                    const date = booking.appointmentDate.toDate ? 
                        booking.appointmentDate.toDate() : new Date(booking.appointmentDate);
                    sessionDate = date.toLocaleDateString('ar-EG');
                    if (booking.appointmentTime) {
                        sessionDate += ' - ' + booking.appointmentTime;
                    }
                }
                
                sessionCard.innerHTML = `
                    <div class="session-info">
                        <h4>ÿ¨ŸÑÿ≥ÿ© ${index + 1}</h4>
                        <p>üìÖ ${sessionDate}</p>
                        <p>üì± ${getSessionTypeName(booking.sessionType)}</p>
                        <p><span class="status status-${booking.status}">${getStatusName(booking.status)}</span></p>
                    </div>
                    <div>
                        ${booking.status === 'confirmed' && booking.sessionLink ? 
                            `<button class="btn btn-primary" onclick="window.open('${booking.sessionLink}', '_blank')">ÿ±ÿßÿ®ÿ∑ ÿßŸÑÿ¨ŸÑÿ≥ÿ©</button>` : ''}
                        ${booking.status === 'pending' ? 
                            `<button class="btn btn-success" onclick="confirmSession('${booking.id}')">ÿ™ÿ£ŸÉŸäÿØ ÿßŸÑŸÖŸàÿπÿØ</button>` : ''}
                    </div>
                `;
                
                sessionsList.appendChild(sessionCard);
            });
        }
        
        // Load practices tab
        function loadPracticesTab() {
            const practicesList = document.getElementById('practicesList');
            practicesList.innerHTML = '';
            
            // Default practices
            const allPractices = [
                {
                    id: 'practice_1',
                    title: 'ÿßŸÑŸÖÿ´ŸÑÿ´ ÿßŸÑŸÇŸÑÿ®Ÿä',
                    description: 'ŸÖŸÖÿßÿ±ÿ≥ÿ© ŸäŸàŸÖŸäÿ© ŸÑŸÑÿßŸÜŸÅÿ™ÿßÿ≠ ŸàÿßŸÑÿ≠ÿ∂Ÿàÿ± ŸàÿßŸÑÿ™ÿ≠ÿ±ŸÉ ÿßŸÑŸÇŸÑÿ®Ÿä',
                    category: 'daily',
                    programs: ['all']
                },
                {
                    id: 'practice_2',
                    title: 'ÿØŸÅÿ™ÿ± ÿßŸÑÿßŸÖÿ™ŸÜÿßŸÜ',
                    description: 'ÿ≥ÿ¨ŸÑ 3 ÿ£ÿ¥Ÿäÿßÿ° ÿ™ÿ¥ÿπÿ± ÿ®ÿßŸÑÿßŸÖÿ™ŸÜÿßŸÜ ŸÑŸáÿß ŸäŸàŸÖŸäÿßŸã',
                    category: 'daily',
                    programs: ['all']
                },
                {
                    id: 'practice_3',
                    title: 'ÿ™ÿ£ŸÖŸÑ ÿßŸÑÿ≠ÿ∂Ÿàÿ±',
                    description: '10 ÿØŸÇÿßÿ¶ŸÇ ŸÖŸÜ ÿßŸÑÿ™ÿ£ŸÖŸÑ ÿßŸÑŸäŸàŸÖŸä',
                    category: 'daily',
                    programs: ['discovery', 'transformation']
                },
                {
                    id: 'practice_4',
                    title: 'ÿ™ŸÖÿ±ŸäŸÜ ÿßŸÑŸáŸàŸäÿ© ÿßŸÑÿµÿ®ÿßÿ≠Ÿä',
                    description: 'ÿ™ÿ¨ÿ≥ŸäÿØ ŸáŸàŸäÿ™ŸÉ ÿßŸÑÿ¨ÿØŸäÿØÿ© ŸÉŸÑ ÿµÿ®ÿßÿ≠',
                    category: 'daily',
                    programs: ['transformation']
                },
                {
                    id: 'practice_5',
                    title: 'ŸäŸàŸÖŸäÿßÿ™ ÿßŸÑŸÇÿßÿ¶ÿØ ÿßŸÑÿ≠ŸÉŸäŸÖ',
                    description: 'ÿ™ÿ≥ÿ¨ŸäŸÑ ŸäŸàŸÖŸä ŸÑÿ•ŸÜÿ¨ÿßÿ≤ÿßÿ™ŸÉ Ÿàÿ™ÿ≠ÿØŸäÿßÿ™ŸÉ',
                    category: 'daily',
                    programs: ['transformation']
                },
                {
                    id: 'practice_6',
                    title: 'ÿ™ŸÖÿ±ŸäŸÜ ÿßŸÑŸàÿ∂Ÿàÿ≠ ÿßŸÑÿµÿ®ÿßÿ≠Ÿä',
                    description: '5 ÿØŸÇÿßÿ¶ŸÇ ŸÑÿ™ÿ≠ÿØŸäÿØ ŸáÿØŸÅŸÉ ÿßŸÑŸäŸàŸÖŸä',
                    category: 'daily',
                    programs: ['clarity']
                }
            ];
            
            // Filter practices based on program
            const programPractices = allPractices.filter(p => 
                p.programs.includes('all') || p.programs.includes(currentJourney.program)
            );
            
            // Get assigned practices
            const assignedPractices = currentJourney.assignedPractices || [];
            const assignedIds = assignedPractices.map(p => p.practiceId);
            
            programPractices.forEach(practice => {
                const isAssigned = assignedIds.includes(practice.id);
                
                const practiceItem = document.createElement('div');
                practiceItem.className = `practice-item ${isAssigned ? 'assigned' : ''}`;
                practiceItem.onclick = () => togglePractice(practice.id);
                
                practiceItem.innerHTML = `
                    <h4>${practice.title}</h4>
                    <p>${practice.description}</p>
                    <small>ÿßŸÑÿ™ŸÉÿ±ÿßÿ±: ${practice.category === 'daily' ? 'ŸäŸàŸÖŸäÿßŸã' : 'ÿ£ÿ≥ÿ®ŸàÿπŸäÿßŸã'}</small>
                `;
                
                practicesList.appendChild(practiceItem);
            });
        }
        
        // Load resources tab
        function loadResourcesTab() {
            const resourcesList = document.getElementById('resourcesList');
            resourcesList.innerHTML = '';
            
            // Default resources
            const allResources = [
                {
                    id: 'resource_1',
                    title: 'ŸÉŸäŸÅ ÿ™ÿ≠ÿØÿØ ÿ£ŸáÿØÿßŸÅŸÉ ÿ®Ÿàÿ∂Ÿàÿ≠',
                    type: 'article',
                    icon: 'üìñ',
                    programs: ['clarity']
                },
                {
                    id: 'resource_2',
                    title: 'ŸÇŸàÿ© ÿßŸÑŸàÿπŸä ÿßŸÑÿ∞ÿßÿ™Ÿä',
                    type: 'video',
                    icon: 'üé•',
                    programs: ['discovery']
                },
                {
                    id: 'resource_3',
                    title: 'Ÿàÿ±ŸÇÿ© ÿπŸÖŸÑ ÿßŸÑÿ™Ÿàÿßÿ≤ŸÜ',
                    type: 'worksheet',
                    icon: 'üìù',
                    programs: ['discovery']
                },
                {
                    id: 'resource_4',
                    title: 'ŸÇŸàÿ© ÿßŸÑÿ¢ŸÜ',
                    type: 'book',
                    icon: 'üìö',
                    programs: ['transformation']
                },
                {
                    id: 'resource_5',
                    title: 'ÿ™ÿ£ŸÖŸÑÿßÿ™ ÿßŸÑÿ™ÿ≠ŸàŸÑ',
                    type: 'meditation',
                    icon: 'üßò',
                    programs: ['transformation']
                },
                {
                    id: 'resource_6',
                    title: 'ÿØŸÑŸäŸÑ ÿßŸÑŸÖŸÖÿßÿ±ÿ≥ÿßÿ™ ÿßŸÑŸäŸàŸÖŸäÿ©',
                    type: 'guide',
                    icon: 'üìã',
                    programs: ['all']
                }
            ];
            
            // Filter resources based on program
            const programResources = allResources.filter(r => 
                r.programs.includes('all') || r.programs.includes(currentJourney.program)
            );
            
            // Get assigned resources
            const assignedResources = currentJourney.assignedResources || [];
            const assignedIds = assignedResources.map(r => r.resourceId);
            
            programResources.forEach(resource => {
                const isAssigned = assignedIds.includes(resource.id);
                
                const resourceItem = document.createElement('div');
                resourceItem.className = `resource-item ${isAssigned ? 'assigned' : ''}`;
                resourceItem.onclick = () => toggleResource(resource.id);
                
                resourceItem.innerHTML = `
                    <div class="resource-icon">${resource.icon}</div>
                    <h4>${resource.title}</h4>
                    <p>${getResourceTypeName(resource.type)}</p>
                `;
                
                resourcesList.appendChild(resourceItem);
            });
        }
        
        // Load messages tab
        function loadMessagesTab() {
            const messagesContainer = document.getElementById('messagesContainer');
            messagesContainer.innerHTML = '';
            
            // Sample messages
            const messages = [
                {
                    from: 'coach',
                    content: 'ŸÖÿ±ÿ≠ÿ®ÿßŸã! ŸÉŸäŸÅ ÿ≠ÿßŸÑŸÉ ŸÖÿπ ÿßŸÑŸÖŸÖÿßÿ±ÿ≥ÿßÿ™ÿü',
                    time: new Date(Date.now() - 86400000).toISOString()
                },
                {
                    from: 'client',
                    content: 'ÿßŸÑÿ≠ŸÖÿØ ŸÑŸÑŸáÿå ÿ£ÿ¥ÿπÿ± ÿ®ÿ™ÿ≠ÿ≥ŸÜ ŸÖŸÑÿ≠Ÿàÿ∏',
                    time: new Date(Date.now() - 82800000).toISOString()
                },
                {
                    from: 'coach',
                    content: 'ŸÖŸÖÿ™ÿßÿ≤! ÿßÿ≥ÿ™ŸÖÿ± Ÿàÿ≥ŸÜŸÜÿßŸÇÿ¥ ÿ™ŸÇÿØŸÖŸÉ ŸÅŸä ÿßŸÑÿ¨ŸÑÿ≥ÿ© ÿßŸÑŸÇÿßÿØŸÖÿ©',
                    time: new Date(Date.now() - 3600000).toISOString()
                }
            ];
            
            messages.forEach(message => {
                const isFromCoach = message.from === 'coach';
                const time = new Date(message.time);
                
                const messageItem = document.createElement('div');
                messageItem.className = `message-item ${isFromCoach ? 'from-coach' : ''}`;
                
                messageItem.innerHTML = `
                    <div class="message-avatar">${isFromCoach ? 'ŸÖ' : getInitial(currentClient.name)}</div>
                    <div class="message-content ${isFromCoach ? 'from-coach' : ''}">
                        <div>${message.content}</div>
                        <div class="message-time">${time.toLocaleTimeString('ar-EG')}</div>
                    </div>
                `;
                
                messagesContainer.appendChild(messageItem);
            });
            
            // Scroll to bottom
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        // Load progress tab
        function loadProgressTab() {
            // Placeholder for chart
            const canvas = document.getElementById('progressChart');
            const ctx = canvas.getContext('2d');
            
            // Simple progress visualization
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#2C5530';
            ctx.fillRect(50, 100, (currentJourney.progress || 0) * 3, 50);
            ctx.fillStyle = '#333';
            ctx.font = '16px Arial';
            ctx.fillText(`ÿßŸÑÿ™ŸÇÿØŸÖ: ${currentJourney.progress || 0}%`, 50, 90);
            
            // Load notes
            document.getElementById('progressNotes').value = currentJourney.progressNotes || '';
        }
        
        // Toggle practice assignment
        const selectedPractices = new Set();
        function togglePractice(practiceId) {
            if (selectedPractices.has(practiceId)) {
                selectedPractices.delete(practiceId);
            } else {
                selectedPractices.add(practiceId);
            }
            
            // Update UI
            loadPracticesTab();
        }
        
        // Toggle resource assignment
        const selectedResources = new Set();
        function toggleResource(resourceId) {
            if (selectedResources.has(resourceId)) {
                selectedResources.delete(resourceId);
            } else {
                selectedResources.add(resourceId);
            }
            
            // Update UI
            loadResourcesTab();
        }
        
        // Save practices assignment
        async function savePracticesAssignment() {
            showLoading(true);
            
            try {
                const practices = Array.from(selectedPractices).map(id => ({
                    practiceId: id,
                    assignedDate: firebase.firestore.FieldValue.serverTimestamp(),
                    frequency: 'daily',
                    completions: []
                }));
                
                await db.collection('journeys').doc(currentJourney.id).update({
                    assignedPractices: practices
                });
                
                showNotification('ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿßŸÑŸÖŸÖÿßÿ±ÿ≥ÿßÿ™ ÿßŸÑŸÖÿÆÿµÿµÿ©', 'success');
                
                // Send notification to client
                sendPracticeNotification();
                
                // Reload data
                await loadData(true);
                
            } catch (error) {
                console.error('Error saving practices:', error);
                showNotification('ÿÆÿ∑ÿ£ ŸÅŸä ÿ≠ŸÅÿ∏ ÿßŸÑŸÖŸÖÿßÿ±ÿ≥ÿßÿ™', 'error');
            } finally {
                showLoading(false);
            }
        }
        
        // Save resources assignment
        async function saveResourcesAssignment() {
            showLoading(true);
            
            try {
                const resources = Array.from(selectedResources).map(id => ({
                    resourceId: id,
                    assignedDate: firebase.firestore.FieldValue.serverTimestamp(),
                    completed: false
                }));
                
                await db.collection('journeys').doc(currentJourney.id).update({
                    assignedResources: resources
                });
                
                showNotification('ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿßŸÑŸÖŸàÿßÿ±ÿØ ÿßŸÑŸÖÿÆÿµÿµÿ©', 'success');
                
                // Send notification to client
                sendResourceNotification();
                
                // Reload data
                await loadData(true);
                
            } catch (error) {
                console.error('Error saving resources:', error);
                showNotification('ÿÆÿ∑ÿ£ ŸÅŸä ÿ≠ŸÅÿ∏ ÿßŸÑŸÖŸàÿßÿ±ÿØ', 'error');
            } finally {
                showLoading(false);
            }
        }
        
        // Schedule session
        function scheduleSession() {
            document.getElementById('scheduleModal').style.display = 'block';
        }
        
        // Confirm schedule
        async function confirmSchedule() {
            const date = document.getElementById('sessionDate').value;
            const time = document.getElementById('sessionTime').value;
            const type = document.getElementById('sessionType').value;
            const link = document.getElementById('sessionLink').value;
            const notes = document.getElementById('sessionNotes').value;
            
            if (!date || !time) {
                showNotification('ŸÖŸÜ ŸÅÿ∂ŸÑŸÉ ÿ£ÿØÿÆŸÑ ÿßŸÑÿ™ÿßÿ±ŸäÿÆ ŸàÿßŸÑŸàŸÇÿ™', 'error');
                return;
            }
            
            showLoading(true);
            
            try {
                // Create new booking
                const bookingData = {
                    userId: currentJourney.userId,
                    email: currentClient.email,
                    name: currentClient.name,
                    phone: currentClient.phone,
                    program: currentJourney.program,
                    journeyId: currentJourney.id,
                    status: 'confirmed',
                    appointmentDate: new Date(date),
                    appointmentTime: time,
                    sessionType: type,
                    sessionLink: link,
                    notes: notes,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                await db.collection('bookings').add(bookingData);
                
                showNotification('ÿ™ŸÖ ÿ¨ÿØŸàŸÑÿ© ÿßŸÑÿ¨ŸÑÿ≥ÿ© ÿ®ŸÜÿ¨ÿßÿ≠', 'success');
                
                // Send confirmation
                sendSessionConfirmation(date, time, type, link);
                
                closeModal('scheduleModal');
                
                // Reload sessions tab
                loadSessionsTab();
                
            } catch (error) {
                console.error('Error scheduling session:', error);
                showNotification('ÿÆÿ∑ÿ£ ŸÅŸä ÿ¨ÿØŸàŸÑÿ© ÿßŸÑÿ¨ŸÑÿ≥ÿ©', 'error');
            } finally {
                showLoading(false);
            }
        }
        
        // Send message
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Add message to UI
            const messagesContainer = document.getElementById('messagesContainer');
            const messageItem = document.createElement('div');
            messageItem.className = 'message-item from-coach';
            
            messageItem.innerHTML = `
                <div class="message-avatar">ŸÖ</div>
                <div class="message-content from-coach">
                    <div>${message}</div>
                    <div class="message-time">${new Date().toLocaleTimeString('ar-EG')}</div>
                </div>
            `;
            
            messagesContainer.appendChild(messageItem);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            // Clear input
            input.value = '';
            
            // Send WhatsApp message
            sendWhatsAppMessage(currentClient.phone, message);
            
            showNotification('ÿ™ŸÖ ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑÿ±ÿ≥ÿßŸÑÿ©', 'success');
        }
        
        // Save progress notes
        async function saveProgressNotes() {
            const notes = document.getElementById('progressNotes').value;
            
            showLoading(true);
            
            try {
                await db.collection('journeys').doc(currentJourney.id).update({
                    progressNotes: notes,
                    progressNotesUpdatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                showNotification('ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿßŸÑŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™', 'success');
                
            } catch (error) {
                console.error('Error saving notes:', error);
                showNotification('ÿÆÿ∑ÿ£ ŸÅŸä ÿ≠ŸÅÿ∏ ÿßŸÑŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™', 'error');
            } finally {
                showLoading(false);
            }
        }
        
        // Search clients
        function searchClients() {
            const searchTerm = document.getElementById('searchBox').value.toLowerCase();
            
            if (!searchTerm) {
                filteredData = [...allJourneys];
            } else {
                filteredData = allJourneys.filter(journey => {
                    const user = journey.user || {};
                    return (
                        (user.name && user.name.toLowerCase().includes(searchTerm)) ||
                        (user.email && user.email.toLowerCase().includes(searchTerm)) ||
                        (user.phone && user.phone.includes(searchTerm))
                    );
                });
            }
            
            displayData();
        }
        
        // Filter data
        function filterData() {
            const program = document.getElementById('programFilter').value;
            const status = document.getElementById('statusFilter').value;
            const searchTerm = document.getElementById('searchBox').value.toLowerCase();
            
            filteredData = allJourneys;
            
            if (program) {
                filteredData = filteredData.filter(j => j.program === program);
            }
            
            if (status) {
                filteredData = filteredData.filter(j => j.status === status);
            }
            
            if (searchTerm) {
                filteredData = filteredData.filter(journey => {
                    const user = journey.user || {};
                    return (
                        (user.name && user.name.toLowerCase().includes(searchTerm)) ||
                        (user.email && user.email.toLowerCase().includes(searchTerm)) ||
                        (user.phone && user.phone.includes(searchTerm))
                    );
                });
            }
            
            displayData();
        }
        
        // Update statistics
        function updateStats() {
            // Total journeys
            document.getElementById('totalJourneys').textContent = allJourneys.length;
            
            // Active journeys
            const activeJourneys = allJourneys.filter(j => j.status === 'active').length;
            document.getElementById('activeJourneys').textContent = activeJourneys;
            
            // Today's sessions
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const todaySessions = allBookings.filter(b => {
                if (b.appointmentDate && b.status === 'confirmed') {
                    const bookingDate = b.appointmentDate.toDate ? 
                        b.appointmentDate.toDate() : new Date(b.appointmentDate);
                    bookingDate.setHours(0, 0, 0, 0);
                    return bookingDate.getTime() === today.getTime();
                }
                return false;
            }).length;
            
            document.getElementById('todaySessions').textContent = todaySessions;
            
            // Completion rate
            const completedJourneys = allJourneys.filter(j => j.status === 'completed').length;
            const completionRate = allJourneys.length > 0 ? 
                Math.round((completedJourneys / allJourneys.length) * 100) : 0;
            document.getElementById('completionRate').textContent = completionRate + '%';
            
            // Revenue calculation
            let totalRevenue = 0;
            allJourneys.forEach(journey => {
                if (journey.status !== 'cancelled') {
                    totalRevenue += getProgramPrice(journey.program);
                }
            });
            document.getElementById('totalRevenue').textContent = totalRevenue.toLocaleString() + ' ÿ¨ŸÜŸäŸá';
            
            // Monthly changes
            const thisMonth = new Date().getMonth();
            const thisMonthJourneys = allJourneys.filter(j => {
                const date = j.startDate?.toDate ? j.startDate.toDate() : new Date();
                return date.getMonth() === thisMonth;
            }).length;
            
            document.getElementById('journeysChange').textContent = `+${thisMonthJourneys} Ÿáÿ∞ÿß ÿßŸÑÿ¥Ÿáÿ±`;
            document.getElementById('revenueChange').textContent = '+15% Ÿáÿ∞ÿß ÿßŸÑÿ¥Ÿáÿ±'; // Placeholder
        }
        
        // Export data
        function exportData() {
            let csv = '\ufeff'; // UTF-8 BOM
            
            // Headers
            const headers = ['ÿßŸÑÿπŸÖŸäŸÑ', 'ÿßŸÑÿ®ÿ±ŸäÿØ', 'ÿßŸÑŸáÿßÿ™ŸÅ', 'ÿßŸÑÿ®ÿ±ŸÜÿßŸÖÿ¨', 'ÿßŸÑŸÖÿ±ÿ≠ŸÑÿ©', 'ÿßŸÑÿ™ŸÇÿØŸÖ', 'ÿßŸÑÿ≠ÿßŸÑÿ©', 'ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ®ÿØÿßŸäÿ©'];
            csv += headers.join(';') + '\n';
            
            // Data
            filteredData.forEach(journey => {
                const user = journey.user || {};
                const row = [
                    user.name || '',
                    user.email || '',
                    user.phone || '',
                    getProgramName(journey.program),
                    `${journey.currentPhase || 1} ŸÖŸÜ ${journey.totalPhases || 3}`,
                    `${journey.progress || 0}%`,
                    getStatusName(journey.status),
                    journey.startDate ? new Date(journey.startDate).toLocaleDateString('ar-EG') : ''
                ];
                
                csv += row.join(';') + '\n';
            });
            
            // Download
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', `ÿ±ÿ≠ŸÑÿßÿ™_${new Date().toLocaleDateString('ar-EG').replace(/\//g, '-')}.csv`);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showNotification('ÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖŸÑŸÅ', 'success');
        }
        
        // Send WhatsApp
        function sendWhatsApp(phone, name) {
            if (!phone) {
                showNotification('ŸÑÿß ŸäŸàÿ¨ÿØ ÿ±ŸÇŸÖ Ÿáÿßÿ™ŸÅ', 'error');
                return;
            }
            
            const cleanPhone = phone.replace(/\D/g, '');
            const fullPhone = cleanPhone.startsWith('2') ? cleanPhone : '2' + cleanPhone;
            const message = `ŸÖÿ±ÿ≠ÿ®ÿßŸã ${name || ''}ÿå ŸÖÿπŸÉ ŸÖÿ≠ŸÖŸàÿØ ŸÅÿ§ÿßÿØ...`;
            
            window.open(`https://wa.me/${fullPhone}?text=${encodeURIComponent(message)}`, '_blank');
        }
        
        // Send WhatsApp message
        function sendWhatsAppMessage(phone, message) {
            if (!phone) return;
            
            const cleanPhone = phone.replace(/\D/g, '');
            const fullPhone = cleanPhone.startsWith('2') ? cleanPhone : '2' + cleanPhone;
            
            window.open(`https://wa.me/${fullPhone}?text=${encodeURIComponent(message)}`, '_blank');
        }
        
        // Send practice notification
        function sendPracticeNotification() {
            const message = `ŸÖÿ±ÿ≠ÿ®ÿßŸã ${currentClient.name}!\n\nÿ™ŸÖ ÿ™ÿÆÿµŸäÿµ ŸÖŸÖÿßÿ±ÿ≥ÿßÿ™ ÿ¨ÿØŸäÿØÿ© ŸÑŸÉ ŸÅŸä ÿ±ÿ≠ŸÑÿ™ŸÉ.\nŸäŸÖŸÉŸÜŸÉ ÿßŸÑÿßÿ∑ŸÑÿßÿπ ÿπŸÑŸäŸáÿß ŸÅŸä ŸÖÿ≥ÿßÿ≠ÿ™ŸÉ ÿßŸÑÿÆÿßÿµÿ©.\n\nhttps://mahmoudfouad25.github.io/portal.html`;
            
            sendWhatsAppMessage(currentClient.phone, message);
        }
        
        // Send resource notification
        function sendResourceNotification() {
            const message = `ŸÖÿ±ÿ≠ÿ®ÿßŸã ${currentClient.name}!\n\nÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸàÿßÿ±ÿØ ÿ¨ÿØŸäÿØÿ© ŸÑÿØÿπŸÖ ÿ±ÿ≠ŸÑÿ™ŸÉ.\nŸäŸÖŸÉŸÜŸÉ ÿßŸÑÿßÿ∑ŸÑÿßÿπ ÿπŸÑŸäŸáÿß ŸÅŸä ŸÖÿ≥ÿßÿ≠ÿ™ŸÉ ÿßŸÑÿÆÿßÿµÿ©.\n\nhttps://mahmoudfouad25.github.io/portal.html`;
            
            sendWhatsAppMessage(currentClient.phone, message);
        }
        
        // Send session confirmation
        function sendSessionConfirmation(date, time, type, link) {
            const dateObj = new Date(date);
            const dateStr = dateObj.toLocaleDateString('ar-EG', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            let message = `ÿ™ÿ£ŸÉŸäÿØ ŸÖŸàÿπÿØ ÿ¨ŸÑÿ≥ÿ™ŸÉ\n\n`;
            message += `ÿßŸÑÿ™ÿßÿ±ŸäÿÆ: ${dateStr}\n`;
            message += `ÿßŸÑŸàŸÇÿ™: ${time}\n`;
            message += `ŸÜŸàÿπ ÿßŸÑÿ¨ŸÑÿ≥ÿ©: ${getSessionTypeName(type)}\n`;
            
            if (type === 'online' && link) {
                message += `ÿ±ÿßÿ®ÿ∑ ÿßŸÑÿ¨ŸÑÿ≥ÿ©: ${link}\n`;
            }
            
            message += `\nÿ£ÿ±ÿßŸÉ ŸÅŸä ÿßŸÑŸÖŸàÿπÿØ ÿ®ÿ•ÿ∞ŸÜ ÿßŸÑŸÑŸá`;
            
            sendWhatsAppMessage(currentClient.phone, message);
        }
        
        // View report
        function viewReport(journeyId) {
            showNotification('ÿ™ŸÇÿßÿ±Ÿäÿ± ÿßŸÑÿ±ÿ≠ŸÑÿßÿ™ ŸÇŸäÿØ ÿßŸÑÿ™ÿ∑ŸàŸäÿ±', 'info');
        }
        
        // Settings
        function showSettings() {
            document.getElementById('settingsModal').style.display = 'block';
            
            // Load current settings
            const notificationPhone = localStorage.getItem('notificationPhone') || '201224938330';
            document.getElementById('notificationPhone').value = notificationPhone;
        }
        
        // Change password
        function changePassword() {
            const oldPassword = document.getElementById('oldPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (!oldPassword || !newPassword || !confirmPassword) {
                showNotification('ÿ£ŸÉŸÖŸÑ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ≠ŸÇŸàŸÑ', 'error');
                return;
            }
            
            if (btoa(oldPassword) !== ADMIN_HASH) {
                showNotification('ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± ÿßŸÑÿ≠ÿßŸÑŸäÿ© ÿÆÿßÿ∑ÿ¶ÿ©', 'error');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                showNotification('ŸÉŸÑŸÖÿ™ÿß ÿßŸÑŸÖÿ±Ÿàÿ± ÿ∫Ÿäÿ± ŸÖÿ™ÿ∑ÿßÿ®ŸÇÿ™ŸäŸÜ', 'error');
                return;
            }
            
            if (newPassword.length < 6) {
                showNotification('ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± Ÿäÿ¨ÿ® ÿ£ŸÜ ÿ™ŸÉŸàŸÜ 6 ÿ£ÿ≠ÿ±ŸÅ ÿπŸÑŸâ ÿßŸÑÿ£ŸÇŸÑ', 'error');
                return;
            }
            
            // Note: In production, save the new password securely
            showNotification('ÿ™ŸÖ ÿ™ÿ∫ŸäŸäÿ± ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± ÿ®ŸÜÿ¨ÿßÿ≠. ÿ≥Ÿäÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÜÿ∏ÿßŸÖ ŸÅŸä ÿßŸÑŸÜÿ≥ÿÆÿ© ÿßŸÑŸÇÿßÿØŸÖÿ©', 'success');
            
            // Clear fields
            document.getElementById('oldPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
        }
        
        // Save settings
        function saveSettings() {
            const notificationPhone = document.getElementById('notificationPhone').value;
            localStorage.setItem('notificationPhone', notificationPhone);
            showNotification('ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™', 'success');
        }
        
        // Utility functions
        function getProgramName(program) {
            const names = {
                clarity: 'ÿ¨ŸÑÿ≥ÿ© ÿßŸÑŸàÿ∂Ÿàÿ≠',
                discovery: 'ÿ±ÿ≠ŸÑÿ© ÿßŸÑÿßŸÉÿ™ÿ¥ÿßŸÅ',
                transformation: 'ÿ±ÿ≠ŸÑÿ© ÿßŸÑÿ™ÿ≠ŸàŸÑ'
            };
            return names[program] || program;
        }
        
        function getProgramPrice(program) {
            const prices = {
                clarity: 400,
                discovery: 1500,
                transformation: 3000
            };
            return prices[program] || 0;
        }
        
        function getProgramSessions(program) {
            const sessions = {
                clarity: 1,
                discovery: 3,
                transformation: 6
            };
            return sessions[program] || 0;
        }
        
        function getStatusName(status) {
            const names = {
                active: 'ŸÜÿ¥ÿ∑ÿ©',
                pending: 'ŸÅŸä ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ±',
                completed: 'ŸÖŸÉÿ™ŸÖŸÑÿ©',
                paused: 'ŸÖÿ™ŸàŸÇŸÅÿ©',
                cancelled: 'ŸÖŸÑÿ∫Ÿäÿ©',
                confirmed: 'ŸÖÿ§ŸÉÿØ'
            };
            return names[status] || 'ŸÅŸä ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ±';
        }
        
        function getSessionTypeName(type) {
            const names = {
                online: 'ÿ£ŸàŸÜŸÑÿßŸäŸÜ',
                phone: 'Ÿáÿßÿ™ŸÅŸä',
                inperson: 'ÿ≠ÿ∂Ÿàÿ±Ÿä'
            };
            return names[type] || 'ÿ£ŸàŸÜŸÑÿßŸäŸÜ';
        }
        
        function getResourceTypeName(type) {
            const names = {
                article: 'ŸÖŸÇÿßŸÑ',
                video: 'ŸÅŸäÿØŸäŸà',
                book: 'ŸÉÿ™ÿßÿ®',
                worksheet: 'Ÿàÿ±ŸÇÿ© ÿπŸÖŸÑ',
                meditation: 'ÿ™ÿ£ŸÖŸÑ',
                guide: 'ÿØŸÑŸäŸÑ'
            };
            return names[type] || type;
        }
        
        function getInitial(name) {
            return name ? name.charAt(0).toUpperCase() : 'ÿü';
        }
        
        function getNextSession(journey) {
            // Find next confirmed session
            const userBookings = allBookings.filter(b => 
                b.userId === journey.userId && 
                b.status === 'confirmed' &&
                b.appointmentDate
            );
            
            if (userBookings.length === 0) {
                return 'ŸÑŸÖ ÿ™ÿ≠ÿØÿØ';
            }
            
            // Sort by date
            userBookings.sort((a, b) => {
                const dateA = a.appointmentDate.toDate ? a.appointmentDate.toDate() : new Date(a.appointmentDate);
                const dateB = b.appointmentDate.toDate ? b.appointmentDate.toDate() : new Date(b.appointmentDate);
                return dateA - dateB;
            });
            
            const nextBooking = userBookings[0];
            const date = nextBooking.appointmentDate.toDate ? 
                nextBooking.appointmentDate.toDate() : new Date(nextBooking.appointmentDate);
            
            return date.toLocaleDateString('ar-EG');
        }
        
        function calculateEngagement(journey) {
            // Simple engagement calculation based on activities
            let score = 0;
            
            if (journey.progress > 0) score += 20;
            if (journey.progress > 50) score += 20;
            if (journey.assignedPractices?.length > 0) score += 20;
            if (journey.assignedResources?.length > 0) score += 20;
            if (journey.completedSessions > 0) score += 20;
            
            return Math.min(score, 100);
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }
        
        // Close modals on outside click
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }
        
        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Ctrl/Cmd + K = Search
            if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                e.preventDefault();
                document.getElementById('searchBox').focus();
            }
            
            // Ctrl/Cmd + R = Refresh
            if ((e.ctrlKey || e.metaKey) && e.key === 'r') {
                e.preventDefault();
                refreshData();
            }
            
            // Escape = Close modals
            if (e.key === 'Escape') {
                document.querySelectorAll('.modal').forEach(modal => {
                    modal.style.display = 'none';
                });
            }
        });
    </script>
</body>
</html>
