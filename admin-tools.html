<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>مكتبة الأدوات - محمود فؤاد</title>
<style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

:root {
    --primary: #2C5530;
    --secondary: #8B9467;
    --accent: #D4AF37;
    --light: #F5F2E8;
    --dark: #1A1A1A;
    --gradient: linear-gradient(135deg, #2C5530 0%, #8B9467 100%);
    --success: #28a745;
    --danger: #dc3545;
    --warning: #ffc107;
    --info: #17a2b8;
    
    /* Tool Type Colors */
    --practice-color: #3498db;
    --meditation-color: #9b59b6;
    --game-color: #e74c3c;
    --challenge-color: #f39c12;
    --reflection-color: #1abc9c;
    --voice-color: #34495e;
}

body {
    font-family: 'Segoe UI', Tahoma, Arial, sans-serif;
    background: #f5f5f5;
    color: var(--dark);
    min-height: 100vh;
}

/* Navigation - Same as other admin pages */
.admin-nav {
    background: white;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    padding: 1rem 2rem;
    position: sticky;
    top: 0;
    z-index: 1000;
}

/* Container */
.tools-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 2rem;
}

/* Page Header */
.page-header {
    background: white;
    padding: 2rem;
    border-radius: 15px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.1);
    margin-bottom: 2rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.page-header h1 {
    color: var(--primary);
    font-size: 2rem;
}

.header-actions {
    display: flex;
    gap: 1rem;
}

/* Tool Types Grid */
.tool-types-section {
    background: white;
    padding: 1.5rem;
    border-radius: 15px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.1);
    margin-bottom: 2rem;
}

.tool-types-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 1rem;
    margin-top: 1rem;
}

.tool-type-card {
    padding: 1.5rem;
    border-radius: 10px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s;
    border: 2px solid transparent;
    position: relative;
}

.tool-type-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

.tool-type-card.active {
    border-color: var(--primary);
    background: rgba(44, 85, 48, 0.05);
}

.tool-type-icon {
    font-size: 2.5rem;
    margin-bottom: 0.5rem;
    display: block;
}

.tool-type-name {
    font-weight: 600;
    color: var(--dark);
    margin-bottom: 0.3rem;
}

.tool-type-count {
    font-size: 0.9rem;
    color: #666;
}

.add-type-card {
    border: 2px dashed #ddd;
    background: #fafafa;
}

.add-type-card:hover {
    border-color: var(--primary);
    background: white;
}

/* Filters and Search */
.tools-controls {
    background: white;
    padding: 1.5rem;
    border-radius: 15px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.1);
    margin-bottom: 2rem;
}

.controls-row {
    display: flex;
    gap: 1rem;
    align-items: center;
    flex-wrap: wrap;
}

.search-box {
    flex: 1;
    min-width: 300px;
    position: relative;
}

.search-box input {
    width: 100%;
    padding: 0.75rem 1rem 0.75rem 3rem;
    border: 2px solid #ddd;
    border-radius: 8px;
    font-size: 1rem;
}

.search-icon {
    position: absolute;
    right: 1rem;
    top: 50%;
    transform: translateY(-50%);
    color: #666;
}

.filter-group {
    display: flex;
    gap: 0.5rem;
}

.filter-btn {
    padding: 0.5rem 1rem;
    border: 2px solid #ddd;
    background: white;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s;
}

.filter-btn:hover {
    border-color: var(--primary);
}

.filter-btn.active {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
}

.view-toggle {
    display: flex;
    gap: 0.5rem;
    background: #f0f0f0;
    padding: 0.25rem;
    border-radius: 8px;
}

.view-btn {
    padding: 0.5rem;
    background: transparent;
    border: none;
    cursor: pointer;
    border-radius: 6px;
    transition: all 0.3s;
}

.view-btn.active {
    background: white;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

/* Tools Grid */
.tools-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: 1.5rem;
}

.tool-card {
    background: white;
    border-radius: 15px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.1);
    overflow: hidden;
    transition: all 0.3s;
    position: relative;
}

.tool-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 30px rgba(0,0,0,0.15);
}

.tool-card-header {
    padding: 1.5rem;
    background: #f8f9fa;
    border-bottom: 1px solid #e9ecef;
}

.tool-card-title {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
}

.tool-name {
    font-size: 1.2rem;
    font-weight: 600;
    color: var(--primary);
}

.tool-type-badge {
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 600;
    color: white;
}

.tool-type-practice { background: var(--practice-color); }
.tool-type-meditation { background: var(--meditation-color); }
.tool-type-game { background: var(--game-color); }
.tool-type-challenge { background: var(--challenge-color); }
.tool-type-reflection { background: var(--reflection-color); }
.tool-type-voice { background: var(--voice-color); }

.tool-description {
    color: #666;
    font-size: 0.9rem;
    line-height: 1.5;
}

.tool-card-body {
    padding: 1.5rem;
}

.tool-meta {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1rem;
    margin-bottom: 1rem;
}

.meta-item {
    text-align: center;
}

.meta-label {
    font-size: 0.8rem;
    color: #666;
    display: block;
}

.meta-value {
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--primary);
}

.tool-stats {
    display: flex;
    justify-content: space-between;
    padding: 1rem;
    background: #f8f9fa;
    border-radius: 10px;
    margin-bottom: 1rem;
}

.stat-item {
    text-align: center;
}

.stat-value {
    display: block;
    font-size: 1.2rem;
    font-weight: bold;
    color: var(--primary);
}

.stat-label {
    font-size: 0.8rem;
    color: #666;
}

.tool-actions {
    display: flex;
    gap: 0.5rem;
}

.btn {
    padding: 0.5rem 1rem;
    border: none;
    border-radius: 8px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s;
    font-size: 0.9rem;
    flex: 1;
    text-align: center;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
}

.btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.btn-primary {
    background: var(--primary);
    color: white;
}

.btn-secondary {
    background: white;
    color: var(--primary);
    border: 2px solid var(--primary);
}

.btn-icon {
    padding: 0.5rem;
    min-width: auto;
    flex: none;
}

/* Tool Creator Modal */
.modal {
    display: none;
    position: fixed;
    z-index: 2000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
    overflow-y: auto;
}

.modal-content {
    background-color: white;
    margin: 2% auto;
    padding: 0;
    border-radius: 15px;
    width: 95%;
    max-width: 900px;
    max-height: 90vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
}

.modal-header {
    background: var(--gradient);
    color: white;
    padding: 2rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-header h2 {
    font-size: 1.5rem;
    margin: 0;
}

.close {
    color: white;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
}

.modal-body {
    flex: 1;
    overflow-y: auto;
    padding: 2rem;
}

/* Tool Creator Steps */
.creator-steps {
    display: flex;
    justify-content: space-between;
    margin-bottom: 2rem;
    padding: 0 2rem;
}

.step {
    flex: 1;
    text-align: center;
    position: relative;
}

.step::after {
    content: '';
    position: absolute;
    top: 20px;
    right: -50%;
    width: 100%;
    height: 2px;
    background: #ddd;
}

.step:last-child::after {
    display: none;
}

.step-number {
    width: 40px;
    height: 40px;
    background: #ddd;
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 0.5rem;
    font-weight: bold;
    position: relative;
    z-index: 1;
}

.step.active .step-number {
    background: var(--primary);
}

.step.completed .step-number {
    background: var(--success);
}

.step-title {
    font-size: 0.9rem;
    color: #666;
}

.step.active .step-title {
    color: var(--primary);
    font-weight: 600;
}

/* Form Sections */
.form-section {
    display: none;
}

.form-section.active {
    display: block;
}

.form-group {
    margin-bottom: 1.5rem;
}

.form-group label {
    display: block;
    margin-bottom: 0.5rem;
    color: var(--primary);
    font-weight: 600;
}

.form-group input,
.form-group textarea,
.form-group select {
    width: 100%;
    padding: 0.75rem;
    border: 2px solid #ddd;
    border-radius: 8px;
    font-size: 1rem;
    transition: all 0.3s;
}

.form-group textarea {
    resize: vertical;
    min-height: 100px;
}

.form-group input:focus,
.form-group textarea:focus,
.form-group select:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(44, 85, 48, 0.1);
}

/* Type Specific Content */
.type-specific-content {
    background: #f8f9fa;
    padding: 1.5rem;
    border-radius: 10px;
    margin-top: 1rem;
}

/* Steps Builder */
.steps-builder {
    margin-top: 1rem;
}

.step-item {
    background: white;
    padding: 1.5rem;
    border-radius: 10px;
    margin-bottom: 1rem;
    border: 2px solid #e9ecef;
    position: relative;
}

.step-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.step-handle {
    cursor: move;
    color: #666;
    margin-left: 0.5rem;
}

.remove-step {
    color: var(--danger);
    cursor: pointer;
}

.add-step-btn {
    width: 100%;
    padding: 1rem;
    border: 2px dashed #ddd;
    background: transparent;
    color: var(--primary);
    font-weight: 600;
    cursor: pointer;
    border-radius: 10px;
    transition: all 0.3s;
}

.add-step-btn:hover {
    background: rgba(44, 85, 48, 0.05);
    border-color: var(--primary);
}

/* Tracking Setup */
.measurement-options {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-top: 1rem;
}

.measurement-option {
    padding: 1rem;
    border: 2px solid #ddd;
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.3s;
    text-align: center;
}

.measurement-option:hover {
    border-color: var(--primary);
}

.measurement-option.selected {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
}

.measurement-icon {
    font-size: 2rem;
    display: block;
    margin-bottom: 0.5rem;
}

/* Questions Builder */
.questions-builder {
    margin-top: 1rem;
}

.question-item {
    background: white;
    padding: 1rem;
    border-radius: 8px;
    margin-bottom: 0.5rem;
    display: flex;
    gap: 1rem;
    align-items: center;
}

.question-input {
    flex: 1;
}

.question-type {
    width: 150px;
}

.remove-question {
    color: var(--danger);
    cursor: pointer;
    padding: 0.5rem;
}

/* Automation Setup */
.reminder-setup {
    background: #f8f9fa;
    padding: 1.5rem;
    border-radius: 10px;
    margin-top: 1rem;
}

.time-picker-group {
    display: flex;
    gap: 1rem;
    align-items: center;
}

.channel-options {
    display: flex;
    gap: 1rem;
    margin-top: 1rem;
}

.channel-option {
    flex: 1;
    padding: 0.75rem;
    border: 2px solid #ddd;
    border-radius: 8px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s;
}

.channel-option:hover {
    border-color: var(--primary);
}

.channel-option.selected {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
}

/* Preview Section */
.tool-preview {
    background: white;
    border: 2px solid #e9ecef;
    border-radius: 15px;
    padding: 2rem;
    margin-top: 2rem;
}

.preview-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid #e9ecef;
}

.preview-title {
    font-size: 1.3rem;
    color: var(--primary);
}

/* Action Buttons */
.action-buttons {
    display: flex;
    gap: 1rem;
    margin-top: 2rem;
    padding-top: 2rem;
    border-top: 2px solid #e9ecef;
}

.btn-large {
    padding: 1rem 2rem;
    font-size: 1.1rem;
}

/* Loading State */
.loading {
    text-align: center;
    padding: 3rem;
}

.spinner {
    border: 3px solid #f3f3f3;
    border-top: 3px solid var(--primary);
    border-radius: 50%;
    width: 40px;
    height: 40px;
    animation: spin 1s linear infinite;
    margin: 0 auto;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Empty State */
.empty-state {
    text-align: center;
    padding: 4rem 2rem;
    color: #999;
}

.empty-state-icon {
    font-size: 4rem;
    margin-bottom: 1rem;
    opacity: 0.5;
}

/* Notification */
.notification {
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 15px 25px;
    border-radius: 8px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.2);
    z-index: 10000;
    animation: slideIn 0.3s;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 10px;
}

@keyframes slideIn {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

.notification.success {
    background: var(--success);
    color: white;
}

.notification.error {
    background: var(--danger);
    color: white;
}

/* Tool Stats Dashboard */
.stats-dashboard {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
}

.stat-card {
    background: white;
    padding: 1.5rem;
    border-radius: 10px;
    box-shadow: 0 3px 15px rgba(0,0,0,0.1);
    text-align: center;
}

.stat-icon {
    font-size: 2rem;
    margin-bottom: 0.5rem;
    opacity: 0.8;
}

.stat-number {
    font-size: 2rem;
    font-weight: bold;
    color: var(--primary);
}

.stat-title {
    font-size: 0.9rem;
    color: #666;
    margin-top: 0.5rem;
}

/* Responsive */
@media (max-width: 768px) {
    .tools-container {
        padding: 1rem;
    }
    
    .page-header {
        flex-direction: column;
        gap: 1rem;
    }
    
    .controls-row {
        flex-direction: column;
    }
    
    .search-box {
        min-width: 100%;
    }
    
    .tools-grid {
        grid-template-columns: 1fr;
    }
    
    .modal-content {
        width: 100%;
        margin: 0;
        border-radius: 0;
        height: 100%;
        max-height: 100%;
    }
    
    .creator-steps {
        padding: 0 1rem;
    }
    
    .step-title {
        font-size: 0.8rem;
    }
}
</style>
</head>
<body>

<!-- Navigation -->
<nav class="admin-nav">
    <div class="nav-container" style="max-width: 1400px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center;">
        <div class="nav-brand">
            <h2>لوحة تحكم محمود فؤاد</h2>
        </div>
        <div class="nav-links" style="display: flex; gap: 2rem; align-items: center;">
            <a href="admin-dashboard.html" style="color: var(--dark); text-decoration: none;">
                <span>🏠</span> الرئيسية
                    </a>
                        <a href="admin-bookings.html" style="color: var(--dark); text-decoration: none;">
        <span>📅</span>
        <span>الحجوزات</span>    
            </a>
            <a href="central-dashboard.html" style="color: var(--dark); text-decoration: none;">
                <span>🚀</span> الرحلات
            </a>
            <a href="admin-tools.html" class="active" style="color: var(--primary); text-decoration: none; position: relative;">
                <span>🧰</span> مكتبة الأدوات
                <span style="position: absolute; bottom: -5px; left: 0; right: 0; height: 3px; background: var(--accent);"></span>
            </a>
            <a href="admin-journey-tools.html" style="color: var(--dark); text-decoration: none;">
                <span>🚀</span> تخصيص الأدوات
            </a>
            <a href="#" onclick="logout()" style="color: var(--dark); text-decoration: none;">
                <span>🚪</span> خروج
            </a>
        </div>
    </div>
</nav>

<!-- Main Container -->
<div class="tools-container">
    <!-- Page Header -->
    <div class="page-header">
        <div>
            <h1>🧰 مكتبة الأدوات</h1>
            <p style="color: #666; margin-top: 0.5rem;">أنشئ وأدر أدواتك المخصصة للعملاء</p>
        </div>
        <div class="header-actions">
            <button class="btn btn-primary btn-large" onclick="openToolCreator()">
                <span>➕</span> إنشاء أداة جديدة
            </button>
        </div>
    </div>

    <!-- Stats Dashboard -->
    <div class="stats-dashboard">
        <div class="stat-card">
            <div class="stat-icon">🧰</div>
            <div class="stat-number" id="totalToolsCount">0</div>
            <div class="stat-title">إجمالي الأدوات</div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">👥</div>
            <div class="stat-number" id="activeUsageCount">0</div>
            <div class="stat-title">استخدامات نشطة</div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">⭐</div>
            <div class="stat-number" id="avgRating">0</div>
            <div class="stat-title">متوسط التقييم</div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">✅</div>
            <div class="stat-number" id="completionRate">0%</div>
            <div class="stat-title">معدل الإكمال</div>
        </div>
    </div>

    <!-- Tool Types -->
    <div class="tool-types-section">
        <h3 style="color: var(--primary); margin-bottom: 1rem;">أنواع الأدوات</h3>
        <div class="tool-types-grid" id="toolTypesGrid">
            <!-- سيتم ملؤها بواسطة JavaScript -->
        </div>
    </div>

    <!-- Filters and Search -->
    <div class="tools-controls">
        <div class="controls-row">
            <div class="search-box">
                <span class="search-icon">🔍</span>
                <input type="text" id="searchInput" placeholder="ابحث عن أداة..." onkeyup="filterTools()">
            </div>
            
            <div class="filter-group">
                <button class="filter-btn active" onclick="filterByProgram('all')">كل البرامج</button>
                <button class="filter-btn" onclick="filterByProgram('clarity')">الوضوح</button>
                <button class="filter-btn" onclick="filterByProgram('discovery')">الاكتشاف</button>
                <button class="filter-btn" onclick="filterByProgram('transformation')">التحول</button>
            </div>
            
            <div class="view-toggle">
                <button class="view-btn active" onclick="switchView('grid')">⊞</button>
                <button class="view-btn" onclick="switchView('list')">☰</button>
            </div>
        </div>
    </div>

    <!-- Tools Grid -->
    <div id="toolsGrid" class="tools-grid">
        <!-- سيتم ملؤها بواسطة JavaScript -->
    </div>

    <!-- Empty State -->
    <div id="emptyState" class="empty-state" style="display: none;">
        <div class="empty-state-icon">🧰</div>
        <h3>لا توجد أدوات بعد</h3>
        <p>ابدأ بإنشاء أول أداة في مكتبتك</p>
        <button class="btn btn-primary" onclick="openToolCreator()">إنشاء أداة</button>
    </div>
</div>

<!-- Tool Creator Modal -->
<div id="toolCreatorModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>إنشاء أداة جديدة</h2>
            <span class="close" onclick="closeToolCreator()">&times;</span>
        </div>
        
        <div class="modal-body">
            <!-- Creator Steps -->
            <div class="creator-steps">
                <div class="step active" id="step1">
                    <div class="step-number">1</div>
                    <div class="step-title">المعلومات الأساسية</div>
                </div>
                <div class="step" id="step2">
                    <div class="step-number">2</div>
                    <div class="step-title">المحتوى</div>
                </div>
                <div class="step" id="step3">
                    <div class="step-number">3</div>
                    <div class="step-title">التتبع والقياس</div>
                </div>
                <div class="step" id="step4">
                    <div class="step-number">4</div>
                    <div class="step-title">الأتمتة</div>
                </div>
            </div>

            <!-- Step 1: Basic Info -->
            <div class="form-section active" id="section1">
                <h3 style="color: var(--primary); margin-bottom: 1.5rem;">المعلومات الأساسية</h3>
                
                <div class="form-group">
                    <label>اسم الأداة</label>
                    <input type="text" id="toolName" placeholder="مثال: المثلث القلبي">
                </div>
                
                <div class="form-group">
                    <label>نوع الأداة</label>
                    <select id="toolType" onchange="updateTypeSpecificFields()">
                        <option value="">اختر النوع</option>
                        <option value="practice">ممارسة</option>
                        <option value="meditation">تأمل</option>
                        <option value="game">لعبة تفاعلية</option>
                        <option value="challenge">تحدي</option>
                        <option value="reflection">تأمل كتابي</option>
                        <option value="voice">تمرين صوتي</option>
                        <option value="custom">نوع مخصص</option>
                    </select>
                </div>
                
                <div class="form-group" id="customTypeGroup" style="display: none;">
                    <label>اسم النوع المخصص</label>
                    <input type="text" id="customTypeName" placeholder="مثال: تمرين تنفس">
                </div>
                
                <div class="form-group">
                    <label>وصف الأداة</label>
                    <textarea id="toolDescription" rows="4" placeholder="وصف تفصيلي للأداة وفوائدها..."></textarea>
                </div>
                
                <div class="form-group">
                    <label>البرامج المستهدفة</label>
                    <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" id="targetAll" onchange="toggleAllPrograms()">
                            <span>جميع البرامج</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" id="targetClarity" class="program-check">
                            <span>الوضوح</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" id="targetDiscovery" class="program-check">
                            <span>الاكتشاف</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" id="targetTransformation" class="program-check">
                            <span>التحول</span>
                        </label>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>المدة الافتراضية (بالدقائق)</label>
                    <input type="number" id="defaultDuration" value="15" min="1">
                </div>
                
                <div class="form-group">
                    <label>التكرار الافتراضي</label>
                    <select id="defaultFrequency">
                        <option value="daily">يومياً</option>
                        <option value="every2days">كل يومين</option>
                        <option value="weekly">أسبوعياً</option>
                        <option value="asneeded">حسب الحاجة</option>
                    </select>
                </div>
            </div>

            <!-- Step 2: Content -->
            <div class="form-section" id="section2">
                <h3 style="color: var(--primary); margin-bottom: 1.5rem;">محتوى الأداة</h3>
                
                <!-- Type Specific Content will be inserted here -->
                <div id="typeSpecificContent"></div>
            </div>

            <!-- Step 3: Tracking -->
            <div class="form-section" id="section3">
                <h3 style="color: var(--primary); margin-bottom: 1.5rem;">التتبع والقياس</h3>
                
                <div class="form-group">
                    <label>كيف سيتم قياس هذه الأداة؟</label>
                    <div class="measurement-options">
                        <div class="measurement-option" onclick="selectMeasurement('binary')">
                            <span class="measurement-icon">✅</span>
                            <div>تم / لم يتم</div>
                        </div>
                        <div class="measurement-option" onclick="selectMeasurement('scale')">
                            <span class="measurement-icon">📊</span>
                            <div>مقياس (1-10)</div>
                        </div>
                        <div class="measurement-option" onclick="selectMeasurement('duration')">
                            <span class="measurement-icon">⏱️</span>
                            <div>المدة الفعلية</div>
                        </div>
                        <div class="measurement-option" onclick="selectMeasurement('quality')">
                            <span class="measurement-icon">⭐</span>
                            <div>جودة الأداء</div>
                        </div>
                        <div class="measurement-option" onclick="selectMeasurement('text')">
                            <span class="measurement-icon">📝</span>
                            <div>نص مفتوح</div>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>معايير النجاح</label>
                    <textarea id="successCriteria" rows="3" placeholder="متى تعتبر هذه الأداة ناجحة؟"></textarea>
                </div>
                
                <div class="form-group">
                    <label>أسئلة المتابعة</label>
                    <div class="questions-builder" id="questionsBuilder">
                        <div class="question-item">
                            <input type="text" class="question-input" placeholder="السؤال">
                            <select class="question-type">
                                <option value="text">نص</option>
                                <option value="scale">مقياس</option>
                                <option value="choice">اختيار</option>
                            </select>
                            <span class="remove-question" onclick="removeQuestion(this)">❌</span>
                        </div>
                    </div>
                    <button class="add-step-btn" onclick="addQuestion()">+ إضافة سؤال</button>
                </div>
            </div>

            <!-- Step 4: Automation -->
            <div class="form-section" id="section4">
                <h3 style="color: var(--primary); margin-bottom: 1.5rem;">الأتمتة والتذكيرات</h3>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="enableReminders" onchange="toggleReminders()">
                        تفعيل التذكيرات التلقائية
                    </label>
                </div>
                
                <div class="reminder-setup" id="reminderSetup" style="display: none;">
                    <div class="form-group">
                        <label>وقت التذكير</label>
                        <div class="time-picker-group">
                            <input type="time" id="reminderTime" value="09:00">
                            <select id="reminderTiming">
                                <option value="exact">في الوقت المحدد</option>
                                <option value="before">قبل الممارسة بـ</option>
                                <option value="after">بعد الجلسة بـ</option>
                            </select>
                            <input type="number" id="reminderOffset" value="30" min="5" style="width: 80px; display: none;">
                            <span id="offsetUnit" style="display: none;">دقيقة</span>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>قنوات الإرسال</label>
                        <div class="channel-options">
                            <div class="channel-option selected" onclick="toggleChannel(this, 'whatsapp')">
                                <span>📱</span> واتساب
                            </div>
                            <div class="channel-option" onclick="toggleChannel(this, 'email')">
                                <span>📧</span> إيميل
                            </div>
                            <div class="channel-option" onclick="toggleChannel(this, 'push')">
                                <span>🔔</span> إشعارات
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>رسالة التذكير</label>
                        <textarea id="reminderMessage" rows="3" placeholder="مرحباً {الاسم}، حان وقت {اسم_الأداة}! 🌟"></textarea>
                        <small style="color: #666;">يمكنك استخدام: {الاسم}, {اسم_الأداة}, {الوقت}</small>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>رسائل تلقائية</label>
                    
                    <div style="margin-bottom: 1rem;">
                        <label style="font-weight: normal;">عند التخصيص:</label>
                        <input type="text" id="msgOnAssign" placeholder="تم إضافة {اسم_الأداة} لرحلتك! 🎯">
                    </div>
                    
                    <div style="margin-bottom: 1rem;">
                        <label style="font-weight: normal;">عند الإكمال:</label>
                        <input type="text" id="msgOnComplete" placeholder="أحسنت! أكملت {اسم_الأداة} بنجاح 🎉">
                    </div>
                    
                    <div>
                        <label style="font-weight: normal;">عند التخطي:</label>
                        <input type="text" id="msgOnSkip" placeholder="لا بأس، يمكنك المحاولة لاحقاً 💪">
                    </div>
                </div>
                
                <!-- Preview Section -->
                <div class="tool-preview">
                    <div class="preview-header">
                        <h4 class="preview-title">معاينة الأداة</h4>
                        <button class="btn btn-secondary" onclick="refreshPreview()">🔄 تحديث</button>
                    </div>
                    <div id="toolPreview">
                        <!-- Preview content will be generated here -->
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="action-buttons">
                <button class="btn btn-secondary btn-large" id="prevBtn" onclick="previousStep()" style="display: none;">
                    السابق
                </button>
                <button class="btn btn-primary btn-large" id="nextBtn" onclick="nextStep()">
                    التالي
                </button>
                <button class="btn btn-success btn-large" id="saveBtn" onclick="saveTool()" style="display: none;">
                    💾 حفظ الأداة
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 9999; display: flex; justify-content: center; align-items: center;">
    <div class="spinner"></div>
</div>

<!-- Firebase Scripts -->
<script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
<script src="firebase-config.js"></script>

<script>
// Initialize
const auth = firebase.auth();
const db = firebase.firestore();

// State
let allTools = [];
let filteredTools = [];
let currentStep = 1;
let selectedMeasurement = null;
let selectedChannels = ['whatsapp'];
let currentFilter = 'all';
let currentView = 'grid';

// Tool Types Configuration
const toolTypes = [
    { id: 'practice', name: 'ممارسات', icon: '🎯', color: 'var(--practice-color)' },
    { id: 'meditation', name: 'تأملات', icon: '🧘', color: 'var(--meditation-color)' },
    { id: 'game', name: 'ألعاب تفاعلية', icon: '🎮', color: 'var(--game-color)' },
    { id: 'challenge', name: 'تحديات', icon: '🏆', color: 'var(--challenge-color)' },
    { id: 'reflection', name: 'تأملات كتابية', icon: '📝', color: 'var(--reflection-color)' },
    { id: 'voice', name: 'تمارين صوتية', icon: '🎙️', color: 'var(--voice-color)' }
];

// Check authentication on load
window.onload = function() {
    checkAuth();
};

// Check authentication
function checkAuth() {
    const authToken = sessionStorage.getItem('adminAuth');
    const authTime = sessionStorage.getItem('authTime');
    const oneHour = 60 * 60 * 1000;
    
    if (authToken === 'true' && authTime && (Date.now() - parseInt(authTime) < oneHour)) {
        loadTools();
        loadToolTypes();
        setInterval(loadTools, 30000); // Refresh every 30 seconds
    } else {
        window.location.href = 'admin-dashboard.html';
    }
}

// Logout
function logout() {
    if (confirm('هل تريد تسجيل الخروج؟')) {
        sessionStorage.clear();
        window.location.href = 'admin-dashboard.html';
    }
}

// Load tool types
function loadToolTypes() {
    const container = document.getElementById('toolTypesGrid');
    let html = '';
    
    // Add existing types
    toolTypes.forEach(type => {
        html += `
            <div class="tool-type-card" onclick="filterByType('${type.id}')" data-type="${type.id}">
                <span class="tool-type-icon" style="color: ${type.color}">${type.icon}</span>
                <div class="tool-type-name">${type.name}</div>
                <div class="tool-type-count" id="count-${type.id}">0 أداة</div>
            </div>
        `;
    });
    
    // Add custom types from database
    db.collection('toolTypes').where('isCustom', '==', true).get().then(snapshot => {
        snapshot.forEach(doc => {
            const customType = doc.data();
            html += `
                <div class="tool-type-card" onclick="filterByType('${doc.id}')" data-type="${doc.id}">
                    <span class="tool-type-icon">${customType.icon || '📦'}</span>
                    <div class="tool-type-name">${customType.name}</div>
                    <div class="tool-type-count" id="count-${doc.id}">0 أداة</div>
                </div>
            `;
        });
        
        // Add "create type" card
        html += `
            <div class="tool-type-card add-type-card" onclick="createNewType()">
                <span class="tool-type-icon">➕</span>
                <div class="tool-type-name">إضافة نوع</div>
            </div>
        `;
        
        container.innerHTML = html;
        updateTypeCounts();
    });
}

// Load tools
async function loadTools() {
    showLoading(true);
    
    try {
        const snapshot = await db.collection('toolsLibrary')
            .orderBy('basicInfo.createdDate', 'desc')
            .get();
        
        allTools = [];
        
        snapshot.forEach(doc => {
            allTools.push({
                id: doc.id,
                ...doc.data()
            });
        });
        
        updateStats();
        filterTools();
        
    } catch (error) {
        console.error('Error loading tools:', error);
        showNotification('خطأ في تحميل الأدوات', 'error');
    } finally {
        showLoading(false);
    }
}

// Update statistics
function updateStats() {
    // Total tools
    document.getElementById('totalToolsCount').textContent = allTools.length;
    
    // Active usage count
    let activeUsage = 0;
    let totalRating = 0;
    let ratedTools = 0;
    let totalCompletions = 0;
    let totalAssignments = 0;
    
    allTools.forEach(tool => {
        const analytics = tool.tracking?.analytics || {};
        activeUsage += analytics.timesUsed || 0;
        
        if (analytics.averageRating) {
            totalRating += analytics.averageRating;
            ratedTools++;
        }
        
        if (analytics.successRate) {
            totalCompletions += analytics.successRate;
            totalAssignments++;
        }
    });
    
    document.getElementById('activeUsageCount').textContent = activeUsage;
    document.getElementById('avgRating').textContent = ratedTools > 0 ? 
        (totalRating / ratedTools).toFixed(1) : '0';
    document.getElementById('completionRate').textContent = totalAssignments > 0 ? 
        Math.round(totalCompletions / totalAssignments) + '%' : '0%';
}

// Update type counts
function updateTypeCounts() {
    const counts = {};
    
    allTools.forEach(tool => {
        const type = tool.basicInfo?.type || 'unknown';
        counts[type] = (counts[type] || 0) + 1;
    });
    
    Object.keys(counts).forEach(type => {
        const element = document.getElementById(`count-${type}`);
        if (element) {
            element.textContent = counts[type] + ' أداة';
        }
    });
}

// Filter by type
function filterByType(type) {
    // Update UI
    document.querySelectorAll('.tool-type-card').forEach(card => {
        card.classList.remove('active');
    });
    
    document.querySelector(`[data-type="${type}"]`)?.classList.add('active');
    
    // Filter tools
    if (type === currentFilter) {
        // If clicking same type, reset filter
        currentFilter = 'all';
        document.querySelector(`[data-type="${type}"]`)?.classList.remove('active');
    } else {
        currentFilter = type;
    }
    
    filterTools();
}

// Filter by program
function filterByProgram(program) {
    // Update UI
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    event.target.classList.add('active');
    
    // Set filter
    currentFilter = program;
    filterTools();
}

// Filter tools
function filterTools() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    
    filteredTools = allTools.filter(tool => {
        // Search filter
        if (searchTerm) {
            const searchableText = [
                tool.basicInfo?.name,
                tool.basicInfo?.description,
                tool.basicInfo?.type
            ].join(' ').toLowerCase();
            
            if (!searchableText.includes(searchTerm)) {
                return false;
            }
        }
        
        // Type/Program filter
        if (currentFilter !== 'all') {
            // Check if it's a type filter
            if (tool.basicInfo?.type === currentFilter) {
                return true;
            }
            
            // Check if it's a program filter
            const targetPrograms = tool.settings?.targetPrograms || [];
            if (targetPrograms.includes(currentFilter) || targetPrograms.includes('all')) {
                return true;
            }
            
            return false;
        }
        
        return true;
    });
    
    displayTools();
}

// Display tools
function displayTools() {
    const container = document.getElementById('toolsGrid');
    const emptyState = document.getElementById('emptyState');
    
    if (filteredTools.length === 0) {
        container.style.display = 'none';
        emptyState.style.display = 'block';
        return;
    }
    
    container.style.display = currentView === 'grid' ? 'grid' : 'block';
    emptyState.style.display = 'none';
    
    let html = '';
    
    filteredTools.forEach(tool => {
        const type = toolTypes.find(t => t.id === tool.basicInfo?.type);
        const typeColor = type?.color || '#666';
        const typeIcon = type?.icon || '📦';
        const analytics = tool.tracking?.analytics || {};
        
        html += `
            <div class="tool-card">
                <div class="tool-card-header">
                    <div class="tool-card-title">
                        <h3 class="tool-name">${tool.basicInfo?.name || 'أداة غير مسماة'}</h3>
                        <span class="tool-type-badge tool-type-${tool.basicInfo?.type}">
                            ${typeIcon} ${type?.name || tool.basicInfo?.type}
                        </span>
                    </div>
                    <p class="tool-description">${tool.basicInfo?.description || ''}</p>
                </div>
                
                <div class="tool-card-body">
                    <div class="tool-meta">
                        <div class="meta-item">
                            <span class="meta-label">المدة</span>
                            <span class="meta-value">${tool.settings?.defaultDuration || 15} د</span>
                        </div>
                        <div class="meta-item">
                            <span class="meta-label">التكرار</span>
                            <span class="meta-value">${getFrequencyName(tool.settings?.frequency)}</span>
                        </div>
                        <div class="meta-item">
                            <span class="meta-label">البرامج</span>
                            <span class="meta-value">${getProgramsDisplay(tool.settings?.targetPrograms)}</span>
                        </div>
                    </div>
                    
                    <div class="tool-stats">
                        <div class="stat-item">
                            <span class="stat-value">${analytics.timesUsed || 0}</span>
                            <span class="stat-label">مرة استخدام</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-value">${analytics.averageRating || 0}⭐</span>
                            <span class="stat-label">التقييم</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-value">${analytics.successRate || 0}%</span>
                            <span class="stat-label">نسبة النجاح</span>
                        </div>
                    </div>
                    
                    <div class="tool-actions">
                        <button class="btn btn-primary" onclick="editTool('${tool.id}')">
                            <span>✏️</span> تعديل
                        </button>
                        <button class="btn btn-secondary" onclick="duplicateTool('${tool.id}')">
                            <span>📋</span> نسخ
                        </button>
                        <button class="btn btn-icon" onclick="viewToolStats('${tool.id}')">
                            <span>📊</span>
                        </button>
                        <button class="btn btn-icon" onclick="deleteTool('${tool.id}')" style="color: var(--danger);">
                            <span>🗑️</span>
                        </button>
                    </div>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

// Switch view
function switchView(view) {
    currentView = view;
    
    document.querySelectorAll('.view-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    event.target.classList.add('active');
    
    displayTools();
}

// Open tool creator
function openToolCreator() {
    resetForm();
    document.getElementById('toolCreatorModal').style.display = 'block';
}

// Close tool creator
function closeToolCreator() {
    if (confirm('هل تريد إغلاق النافذة؟ سيتم فقدان التغييرات غير المحفوظة.')) {
        document.getElementById('toolCreatorModal').style.display = 'none';
        resetForm();
    }
}

// Reset form
function resetForm() {
    currentStep = 1;
    selectedMeasurement = null;
    selectedChannels = ['whatsapp'];
    
    // Clear all form fields
    document.querySelectorAll('input[type="text"], input[type="number"], textarea, select').forEach(field => {
        field.value = '';
    });
    
    document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
        checkbox.checked = false;
    });
    
    // Reset steps UI
    updateStepsUI();
}

// Update steps UI
function updateStepsUI() {
    // Update step indicators
    for (let i = 1; i <= 4; i++) {
        const step = document.getElementById(`step${i}`);
        const section = document.getElementById(`section${i}`);
        
        step.classList.remove('active', 'completed');
        section.classList.remove('active');
        
        if (i < currentStep) {
            step.classList.add('completed');
        } else if (i === currentStep) {
            step.classList.add('active');
            section.classList.add('active');
        }
    }
    
    // Update buttons
    document.getElementById('prevBtn').style.display = currentStep > 1 ? 'block' : 'none';
    document.getElementById('nextBtn').style.display = currentStep < 4 ? 'block' : 'none';
    document.getElementById('saveBtn').style.display = currentStep === 4 ? 'block' : 'none';
    
    // Load type specific content if on step 2
    if (currentStep === 2) {
        loadTypeSpecificContent();
    }
    
    // Generate preview if on step 4
    if (currentStep === 4) {
        generatePreview();
    }
}

// Next step
function nextStep() {
    if (validateCurrentStep()) {
        currentStep++;
        updateStepsUI();
    }
}

// Previous step
function previousStep() {
    currentStep--;
    updateStepsUI();
}

// Validate current step
function validateCurrentStep() {
    switch (currentStep) {
        case 1:
            const name = document.getElementById('toolName').value.trim();
            const type = document.getElementById('toolType').value;
            const description = document.getElementById('toolDescription').value.trim();
            
            if (!name) {
                showNotification('من فضلك أدخل اسم الأداة', 'error');
                return false;
            }
            
            if (!type) {
                showNotification('من فضلك اختر نوع الأداة', 'error');
                return false;
            }
            
            if (!description) {
                showNotification('من فضلك أدخل وصف الأداة', 'error');
                return false;
            }
            
            return true;
            
        case 2:
            // Validate based on tool type
            return validateTypeSpecificContent();
            
        case 3:
            if (!selectedMeasurement) {
                showNotification('من فضلك اختر طريقة القياس', 'error');
                return false;
            }
            return true;
            
        default:
            return true;
    }
}

// Update type specific fields
function updateTypeSpecificFields() {
    const type = document.getElementById('toolType').value;
    const customGroup = document.getElementById('customTypeGroup');
    
    if (type === 'custom') {
        customGroup.style.display = 'block';
    } else {
        customGroup.style.display = 'none';
    }
}

// Load type specific content
function loadTypeSpecificContent() {
    const type = document.getElementById('toolType').value;
    const container = document.getElementById('typeSpecificContent');
    
    let html = '';
    
    switch (type) {
        case 'practice':
            html = `
                <div class="type-specific-content">
                    <h4 style="color: var(--primary); margin-bottom: 1rem;">محتوى الممارسة</h4>
                    
                    <div class="form-group">
                        <label>تعليمات الممارسة</label>
                        <textarea id="practiceInstructions" rows="5" placeholder="اكتب التعليمات التفصيلية للممارسة..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>خطوات التنفيذ</label>
                        <div class="steps-builder" id="practiceSteps">
                            <div class="step-item">
                                <div class="step-header">
                                    <span class="step-handle">☰</span>
                                    <h5>الخطوة 1</h5>
                                    <span class="remove-step" onclick="removeStep(this)">❌</span>
                                </div>
                                <input type="text" placeholder="عنوان الخطوة" class="step-title-input">
                                <textarea placeholder="وصف الخطوة" rows="2" class="step-description"></textarea>
                                <input type="number" placeholder="المدة (دقائق)" value="5" min="1" class="step-duration">
                            </div>
                        </div>
                        <button class="add-step-btn" onclick="addPracticeStep()">+ إضافة خطوة</button>
                    </div>
                    
                    <div class="form-group">
                        <label>نصائح للنجاح</label>
                        <textarea id="practiceTips" rows="3" placeholder="نصائح تساعد العميل على النجاح..."></textarea>
                    </div>
                </div>
            `;
            break;
            
        case 'meditation':
            html = `
                <div class="type-specific-content">
                    <h4 style="color: var(--primary); margin-bottom: 1rem;">محتوى التأمل</h4>
                    
                    <div class="form-group">
                        <label>نص التأمل</label>
                        <textarea id="meditationScript" rows="10" placeholder="اكتب نص التأمل الموجه..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>ملف صوتي (اختياري)</label>
                        <input type="file" id="meditationAudio" accept="audio/*">
                        <small style="color: #666;">يمكنك رفع ملف صوتي للتأمل</small>
                    </div>
                    
                    <div class="form-group">
                        <label>موسيقى خلفية</label>
                        <select id="backgroundMusic">
                            <option value="none">بدون موسيقى</option>
                            <option value="nature">أصوات الطبيعة</option>
                            <option value="calm">موسيقى هادئة</option>
                            <option value="binaural">نغمات ثنائية</option>
                            <option value="custom">رفع موسيقى مخصصة</option>
                        </select>
                    </div>
                    
                    <div class="form-group" id="customMusicGroup" style="display: none;">
                        <label>رفع موسيقى مخصصة</label>
                        <input type="file" id="customMusic" accept="audio/*">
                    </div>
                    
                    <div class="form-group">
                        <label>إرشادات ما قبل التأمل</label>
                        <textarea id="preMeditationGuide" rows="3" placeholder="تحضيرات قبل البدء..."></textarea>
                    </div>
                </div>
            `;
            break;
            
        case 'game':
            html = `
                <div class="type-specific-content">
                    <h4 style="color: var(--primary); margin-bottom: 1rem;">محتوى اللعبة</h4>
                    
                    <div class="form-group">
                        <label>قواعد اللعبة</label>
                        <textarea id="gameRules" rows="5" placeholder="اشرح قواعد اللعبة بوضوح..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>أهداف اللعبة</label>
                        <div id="gameObjectives">
                            <div style="margin-bottom: 0.5rem;">
                                <input type="text" placeholder="الهدف الأول" style="width: calc(100% - 40px);">
                                <button onclick="removeObjective(this)" style="width: 30px;">❌</button>
                            </div>
                        </div>
                        <button class="add-step-btn" onclick="addObjective()">+ إضافة هدف</button>
                    </div>
                    
                    <div class="form-group">
                        <label>نظام النقاط</label>
                        <textarea id="scoringSystem" rows="3" placeholder="كيف يتم حساب النقاط؟"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>المستويات (اختياري)</label>
                        <div id="gameLevels">
                            <div class="step-item">
                                <h5>المستوى 1</h5>
                                <input type="text" placeholder="اسم المستوى" class="level-name">
                                <textarea placeholder="متطلبات المستوى" rows="2" class="level-requirements"></textarea>
                                <input type="text" placeholder="المكافآت" class="level-rewards">
                            </div>
                        </div>
                        <button class="add-step-btn" onclick="addGameLevel()">+ إضافة مستوى</button>
                    </div>
                </div>
            `;
            break;
            
        case 'challenge':
            html = `
                <div class="type-specific-content">
                    <h4 style="color: var(--primary); margin-bottom: 1rem;">محتوى التحدي</h4>
                    
                    <div class="form-group">
                        <label>وصف التحدي</label>
                        <textarea id="challengeDescription" rows="5" placeholder="اشرح التحدي بالتفصيل..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>مدة التحدي (بالأيام)</label>
                        <input type="number" id="challengeDuration" value="7" min="1">
                    </div>
                    
                    <div class="form-group">
                        <label>مراحل التحدي</label>
                        <div id="challengeMilestones">
                            <div class="step-item">
                                <div class="step-header">
                                    <span>اليوم 1</span>
                                    <span class="remove-step" onclick="removeMilestone(this)">❌</span>
                                </div>
                                <input type="text" placeholder="مهمة اليوم" class="milestone-task">
                                <select class="milestone-verification">
                                    <option value="checkbox">مربع اختيار</option>
                                    <option value="photo">صورة</option>
                                    <option value="text">نص</option>
                                </select>
                            </div>
                        </div>
                        <button class="add-step-btn" onclick="addMilestone()">+ إضافة يوم</button>
                    </div>
                    
                    <div class="form-group">
                        <label>المكافآت</label>
                        <textarea id="challengeRewards" rows="3" placeholder="ماذا يحصل عليه من ينجح في التحدي؟"></textarea>
                    </div>
                </div>
            `;
            break;
            
        case 'reflection':
            html = `
                <div class="type-specific-content">
                    <h4 style="color: var(--primary); margin-bottom: 1rem;">محتوى التأمل الكتابي</h4>
                    
                    <div class="form-group">
                        <label>مقدمة التأمل</label>
                        <textarea id="reflectionIntro" rows="3" placeholder="مقدمة تحفز على التأمل..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>أسئلة التأمل</label>
                        <div id="reflectionQuestions">
                            <div style="margin-bottom: 0.5rem;">
                                <input type="text" placeholder="السؤال الأول" style="width: calc(100% - 40px);">
                                <button onclick="removeReflectionQuestion(this)" style="width: 30px;">❌</button>
                            </div>
                        </div>
                        <button class="add-step-btn" onclick="addReflectionQuestion()">+ إضافة سؤال</button>
                    </div>
                    
                    <div class="form-group">
                        <label>إرشادات الكتابة</label>
                        <textarea id="writingGuidelines" rows="3" placeholder="نصائح للكتابة الفعالة..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>الحد الأدنى للكلمات (اختياري)</label>
                        <input type="number" id="minWords" placeholder="مثال: 100" min="0">
                    </div>
                </div>
            `;
            break;
            
        case 'voice':
            html = `
                <div class="type-specific-content">
                    <h4 style="color: var(--primary); margin-bottom: 1rem;">محتوى التمرين الصوتي</h4>
                    
                    <div class="form-group">
                        <label>تعليمات التمرين</label>
                        <textarea id="voiceInstructions" rows="5" placeholder="اشرح كيفية أداء التمرين الصوتي..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>مدة التسجيل المطلوبة (بالثواني)</label>
                        <input type="number" id="recordingDuration" value="60" min="10">
                    </div>
                    
                    <div class="form-group">
                        <label>موضوعات مقترحة</label>
                        <div id="voiceTopics">
                            <div style="margin-bottom: 0.5rem;">
                                <input type="text" placeholder="موضوع للحديث عنه" style="width: calc(100% - 40px);">
                                <button onclick="removeVoiceTopic(this)" style="width: 30px;">❌</button>
                            </div>
                        </div>
                        <button class="add-step-btn" onclick="addVoiceTopic()">+ إضافة موضوع</button>
                    </div>
                    
                    <div class="form-group">
                        <label>أسئلة توجيهية</label>
                        <textarea id="guidingQuestions" rows="3" placeholder="أسئلة تساعد في توجيه التسجيل..."></textarea>
                    </div>
                </div>
            `;
            break;
    }
    
    container.innerHTML = html;
    
    // Add event listeners for dynamic elements
    if (type === 'meditation') {
        document.getElementById('backgroundMusic').addEventListener('change', function() {
            document.getElementById('customMusicGroup').style.display = 
                this.value === 'custom' ? 'block' : 'none';
        });
    }
}

// Validate type specific content
function validateTypeSpecificContent() {
    const type = document.getElementById('toolType').value;
    
    switch (type) {
        case 'practice':
            const instructions = document.getElementById('practiceInstructions').value.trim();
            if (!instructions) {
                showNotification('من فضلك أدخل تعليمات الممارسة', 'error');
                return false;
            }
            return true;
            
        case 'meditation':
            const script = document.getElementById('meditationScript').value.trim();
            if (!script) {
                showNotification('من فضلك أدخل نص التأمل', 'error');
                return false;
            }
            return true;
            
        case 'game':
            const rules = document.getElementById('gameRules').value.trim();
            if (!rules) {
                showNotification('من فضلك أدخل قواعد اللعبة', 'error');
                return false;
            }
            return true;
            
        case 'challenge':
            const description = document.getElementById('challengeDescription').value.trim();
            if (!description) {
                showNotification('من فضلك أدخل وصف التحدي', 'error');
                return false;
            }
            return true;
            
        case 'reflection':
            const questions = document.querySelectorAll('#reflectionQuestions input[type="text"]');
            if (questions.length === 0 || !questions[0].value.trim()) {
                showNotification('من فضلك أضف سؤال واحد على الأقل', 'error');
                return false;
            }
            return true;
            
        case 'voice':
            const voiceInstructions = document.getElementById('voiceInstructions').value.trim();
            if (!voiceInstructions) {
                showNotification('من فضلك أدخل تعليمات التمرين', 'error');
                return false;
            }
            return true;
            
        default:
            return true;
    }
}

// Add practice step
function addPracticeStep() {
    const container = document.getElementById('practiceSteps');
    const stepCount = container.querySelectorAll('.step-item').length + 1;
    
    const stepHtml = `
        <div class="step-item">
            <div class="step-header">
                <span class="step-handle">☰</span>
                <h5>الخطوة ${stepCount}</h5>
                <span class="remove-step" onclick="removeStep(this)">❌</span>
            </div>
            <input type="text" placeholder="عنوان الخطوة" class="step-title-input">
            <textarea placeholder="وصف الخطوة" rows="2" class="step-description"></textarea>
            <input type="number" placeholder="المدة (دقائق)" value="5" min="1" class="step-duration">
        </div>
    `;
    
    container.insertAdjacentHTML('beforeend', stepHtml);
}

// Remove step
function removeStep(button) {
    button.closest('.step-item').remove();
    updateStepNumbers();
}

// Update step numbers
function updateStepNumbers() {
    const steps = document.querySelectorAll('#practiceSteps .step-item');
    steps.forEach((step, index) => {
        step.querySelector('h5').textContent = `الخطوة ${index + 1}`;
    });
}

// Select measurement
function selectMeasurement(type) {
    selectedMeasurement = type;
    
    document.querySelectorAll('.measurement-option').forEach(option => {
        option.classList.remove('selected');
    });
    
    event.target.closest('.measurement-option').classList.add('selected');
}

// Add question
function addQuestion() {
    const container = document.getElementById('questionsBuilder');
    
    const questionHtml = `
        <div class="question-item">
            <input type="text" class="question-input" placeholder="السؤال">
            <select class="question-type">
                <option value="text">نص</option>
                <option value="scale">مقياس</option>
                <option value="choice">اختيار</option>
            </select>
            <span class="remove-question" onclick="removeQuestion(this)">❌</span>
        </div>
    `;
    
    container.insertAdjacentHTML('beforeend', questionHtml);
}

// Remove question
function removeQuestion(button) {
    button.closest('.question-item').remove();
}

// Toggle reminders
function toggleReminders() {
    const enabled = document.getElementById('enableReminders').checked;
    document.getElementById('reminderSetup').style.display = enabled ? 'block' : 'none';
}

// Toggle channel
function toggleChannel(element, channel) {
    element.classList.toggle('selected');
    
    if (element.classList.contains('selected')) {
        if (!selectedChannels.includes(channel)) {
            selectedChannels.push(channel);
        }
    } else {
        selectedChannels = selectedChannels.filter(c => c !== channel);
    }
}

// Toggle all programs
function toggleAllPrograms() {
    const allChecked = document.getElementById('targetAll').checked;
    
    document.querySelectorAll('.program-check').forEach(checkbox => {
        checkbox.checked = allChecked;
        checkbox.disabled = allChecked;
    });
}

// Generate preview
function generatePreview() {
    const name = document.getElementById('toolName').value;
    const type = document.getElementById('toolType').value;
    const description = document.getElementById('toolDescription').value;
    const duration = document.getElementById('defaultDuration').value;
    const frequency = document.getElementById('defaultFrequency').value;
    
    const preview = document.getElementById('toolPreview');
    
    const typeInfo = toolTypes.find(t => t.id === type);
    
    let previewHtml = `
        <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 10px; margin-bottom: 1rem;">
            <h3 style="color: var(--primary); margin-bottom: 0.5rem;">
                ${typeInfo?.icon || '📦'} ${name}
            </h3>
            <p style="color: #666; margin-bottom: 1rem;">${description}</p>
            
            <div style="display: flex; gap: 2rem; margin-bottom: 1rem;">
                <div>
                    <strong>النوع:</strong> ${typeInfo?.name || type}
                </div>
                <div>
                    <strong>المدة:</strong> ${duration} دقيقة
                </div>
                <div>
                    <strong>التكرار:</strong> ${getFrequencyName(frequency)}
                </div>
            </div>
        </div>
    `;
    
    // Add type-specific preview
    switch (type) {
        case 'practice':
            const steps = document.querySelectorAll('#practiceSteps .step-item');
            if (steps.length > 0) {
                previewHtml += '<h4>خطوات التنفيذ:</h4><ol>';
                steps.forEach(step => {
                    const title = step.querySelector('.step-title-input').value;
                    const desc = step.querySelector('.step-description').value;
                    if (title) {
                        previewHtml += `<li><strong>${title}</strong><br>${desc}</li>`;
                    }
                });
                previewHtml += '</ol>';
            }
            break;
            
        case 'challenge':
            const challengeDuration = document.getElementById('challengeDuration').value;
            previewHtml += `<p><strong>مدة التحدي:</strong> ${challengeDuration} أيام</p>`;
            break;
    }
    
    // Add tracking info
    if (selectedMeasurement) {
        previewHtml += `
            <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #ddd;">
                <strong>طريقة القياس:</strong> ${getMeasurementName(selectedMeasurement)}
            </div>
        `;
    }
    
    // Add automation info
    if (document.getElementById('enableReminders').checked) {
        const time = document.getElementById('reminderTime').value;
        previewHtml += `
            <div style="margin-top: 0.5rem;">
                <strong>التذكير:</strong> ${time} عبر ${selectedChannels.join(', ')}
            </div>
        `;
    }
    
    preview.innerHTML = previewHtml;
}

// Refresh preview
function refreshPreview() {
    generatePreview();
}

// Save tool
async function saveTool() {
    if (!validateAllSteps()) {
        return;
    }
    
    showLoading(true);
    
    try {
        // Collect all data
        const toolData = {
            basicInfo: {
                name: document.getElementById('toolName').value.trim(),
                type: document.getElementById('toolType').value,
                description: document.getElementById('toolDescription').value.trim(),
                creator: auth.currentUser?.uid || 'admin',
                createdDate: firebase.firestore.FieldValue.serverTimestamp(),
                lastModified: firebase.firestore.FieldValue.serverTimestamp(),
                version: 1
            },
            
            settings: {
                defaultDuration: parseInt(document.getElementById('defaultDuration').value) || 15,
                frequency: document.getElementById('defaultFrequency').value,
                targetPrograms: getSelectedPrograms(),
                targetPhases: [] // Will be set based on program
            },
            
            content: getToolContent(),
            
            tracking: {
                measurementType: selectedMeasurement,
                successCriteria: document.getElementById('successCriteria').value.trim(),
                feedbackQuestions: getQuestions(),
                analytics: {
                    timesUsed: 0,
                    averageCompletion: 0,
                    averageRating: 0,
                    successRate: 0
                }
            },
            
            automation: getAutomationSettings()
        };
        
        // Save to Firestore
        const docRef = await db.collection('toolsLibrary').add(toolData);
        
        showNotification('تم حفظ الأداة بنجاح!', 'success');
        
        // Close modal and reload
        document.getElementById('toolCreatorModal').style.display = 'none';
        resetForm();
        loadTools();
        
    } catch (error) {
        console.error('Error saving tool:', error);
        showNotification('خطأ في حفظ الأداة: ' + error.message, 'error');
    } finally {
        showLoading(false);
    }
}

// Validate all steps
function validateAllSteps() {
    const currentStepBackup = currentStep;
    
    for (let i = 1; i <= 3; i++) {
        currentStep = i;
        if (!validateCurrentStep()) {
            updateStepsUI();
            return false;
        }
    }
    
    currentStep = currentStepBackup;
    return true;
}

// Get selected programs
function getSelectedPrograms() {
    if (document.getElementById('targetAll').checked) {
        return ['all'];
    }
    
    const programs = [];
    if (document.getElementById('targetClarity').checked) programs.push('clarity');
    if (document.getElementById('targetDiscovery').checked) programs.push('discovery');
    if (document.getElementById('targetTransformation').checked) programs.push('transformation');
    
    return programs.length > 0 ? programs : ['all'];
}

// Get tool content
function getToolContent() {
    const type = document.getElementById('toolType').value;
    const content = {};
    
    switch (type) {
        case 'practice':
            const steps = [];
            document.querySelectorAll('#practiceSteps .step-item').forEach((step, index) => {
                steps.push({
                    order: index + 1,
                    title: step.querySelector('.step-title-input').value,
                    description: step.querySelector('.step-description').value,
                    duration: parseInt(step.querySelector('.step-duration').value) || 5
                });
            });
            
            content.instructions = {
                text: document.getElementById('practiceInstructions').value,
                steps: steps
            };
            content.tips = document.getElementById('practiceTips').value;
            break;
            
        case 'meditation':
            content.meditation = {
                script: document.getElementById('meditationScript').value,
                audioUrl: '', // Handle file upload separately
                backgroundMusic: document.getElementById('backgroundMusic').value,
                guidedBy: 'الكوتش'
            };
            content.preMeditationGuide = document.getElementById('preMeditationGuide').value;
            break;
            
        case 'game':
            const objectives = [];
            document.querySelectorAll('#gameObjectives input').forEach(input => {
                if (input.value.trim()) {
                    objectives.push(input.value.trim());
                }
            });
            
            const levels = [];
            document.querySelectorAll('#gameLevels .step-item').forEach((level, index) => {
                levels.push({
                    level: index + 1,
                    name: level.querySelector('.level-name').value,
                    requirements: level.querySelector('.level-requirements').value,
                    rewards: level.querySelector('.level-rewards').value
                });
            });
            
            content.game = {
                rules: document.getElementById('gameRules').value,
                objectives: objectives,
                scoringSystem: document.getElementById('scoringSystem').value,
                levels: levels
            };
            break;
            
        case 'challenge':
            const milestones = [];
            document.querySelectorAll('#challengeMilestones .step-item').forEach((milestone, index) => {
                milestones.push({
                    day: index + 1,
                    task: milestone.querySelector('.milestone-task').value,
                    verification: milestone.querySelector('.milestone-verification').value
                });
            });
            
            content.challenge = {
                description: document.getElementById('challengeDescription').value,
                duration: parseInt(document.getElementById('challengeDuration').value),
                milestones: milestones,
                rewards: document.getElementById('challengeRewards').value
            };
            break;
            
        case 'reflection':
            const questions = [];
            document.querySelectorAll('#reflectionQuestions input').forEach(input => {
                if (input.value.trim()) {
                    questions.push(input.value.trim());
                }
            });
            
            content.reflection = {
                intro: document.getElementById('reflectionIntro').value,
                questions: questions,
                guidelines: document.getElementById('writingGuidelines').value,
                minWords: parseInt(document.getElementById('minWords').value) || 0
            };
            break;
            
        case 'voice':
            const topics = [];
            document.querySelectorAll('#voiceTopics input').forEach(input => {
                if (input.value.trim()) {
                    topics.push(input.value.trim());
                }
            });
            
            content.voice = {
                instructions: document.getElementById('voiceInstructions').value,
                recordingDuration: parseInt(document.getElementById('recordingDuration').value),
                suggestedTopics: topics,
                guidingQuestions: document.getElementById('guidingQuestions').value
            };
            break;
    }
    
    return content;
}

// Get questions
function getQuestions() {
    const questions = [];
    
    document.querySelectorAll('#questionsBuilder .question-item').forEach(item => {
        const question = item.querySelector('.question-input').value.trim();
        const type = item.querySelector('.question-type').value;
        
        if (question) {
            questions.push({
                question: question,
                type: type,
                required: true
            });
        }
    });
    
    return questions;
}

// Get automation settings
function getAutomationSettings() {
    const automation = {
        reminders: {
            enabled: document.getElementById('enableReminders').checked,
            timing: 'atTime',
            message: document.getElementById('reminderMessage')?.value || '',
            channel: selectedChannels.join(',')
        },
        
        messages: {
            onAssign: document.getElementById('msgOnAssign').value,
            onComplete: document.getElementById('msgOnComplete').value,
            onSkip: document.getElementById('msgOnSkip').value
        }
    };
    
    if (automation.reminders.enabled) {
        automation.reminders.time = document.getElementById('reminderTime').value;
        automation.reminders.timing = document.getElementById('reminderTiming').value;
        
        if (automation.reminders.timing !== 'exact') {
            automation.reminders.offset = parseInt(document.getElementById('reminderOffset').value);
        }
    }
    
    return automation;
}

// Edit tool
async function editTool(toolId) {
    // Load tool data and populate form
    showNotification('ميزة التعديل قيد التطوير', 'info');
}

// Duplicate tool
async function duplicateTool(toolId) {
    if (!confirm('هل تريد نسخ هذه الأداة؟')) return;
    
    showLoading(true);
    
    try {
        // Get original tool
        const doc = await db.collection('toolsLibrary').doc(toolId).get();
        if (!doc.exists) {
            throw new Error('الأداة غير موجودة');
        }
        
        const toolData = doc.data();
        
        // Create copy
        const copyData = {
            ...toolData,
            basicInfo: {
                ...toolData.basicInfo,
                name: toolData.basicInfo.name + ' (نسخة)',
                createdDate: firebase.firestore.FieldValue.serverTimestamp(),
                lastModified: firebase.firestore.FieldValue.serverTimestamp()
            },
            tracking: {
                ...toolData.tracking,
                analytics: {
                    timesUsed: 0,
                    averageCompletion: 0,
                    averageRating: 0,
                    successRate: 0
                }
            }
        };
        
        await db.collection('toolsLibrary').add(copyData);
        
        showNotification('تم نسخ الأداة بنجاح', 'success');
        loadTools();
        
    } catch (error) {
        console.error('Error duplicating tool:', error);
        showNotification('خطأ في نسخ الأداة', 'error');
    } finally {
        showLoading(false);
    }
}

// View tool stats
function viewToolStats(toolId) {
    showNotification('صفحة الإحصائيات قيد التطوير', 'info');
}

// Delete tool
async function deleteTool(toolId) {
    if (!confirm('هل أنت متأكد من حذف هذه الأداة؟ لا يمكن التراجع عن هذا الإجراء.')) return;
    
    showLoading(true);
    
    try {
        await db.collection('toolsLibrary').doc(toolId).delete();
        
        showNotification('تم حذف الأداة بنجاح', 'success');
        loadTools();
        
    } catch (error) {
        console.error('Error deleting tool:', error);
        showNotification('خطأ في حذف الأداة', 'error');
    } finally {
        showLoading(false);
    }
}

// Create new type
async function createNewType() {
    const name = prompt('أدخل اسم النوع الجديد:');
    if (!name) return;
    
    const icon = prompt('أدخل رمز النوع (emoji):', '📦');
    if (!icon) return;
    
    try {
        await db.collection('toolTypes').add({
            name: name,
            icon: icon,
            isCustom: true,
            createdDate: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        showNotification('تم إضافة النوع الجديد', 'success');
        loadToolTypes();
        
    } catch (error) {
        console.error('Error creating type:', error);
        showNotification('خطأ في إضافة النوع', 'error');
    }
}

// Helper functions for dynamic content
function addObjective() {
    const container = document.getElementById('gameObjectives');
    const html = `
        <div style="margin-bottom: 0.5rem;">
            <input type="text" placeholder="هدف جديد" style="width: calc(100% - 40px);">
            <button onclick="removeObjective(this)" style="width: 30px;">❌</button>
        </div>
    `;
    container.insertAdjacentHTML('beforeend', html);
}

function removeObjective(button) {
    button.parentElement.remove();
}

function addGameLevel() {
    const container = document.getElementById('gameLevels');
    const levelCount = container.querySelectorAll('.step-item').length + 1;
    
    const html = `
        <div class="step-item">
            <h5>المستوى ${levelCount}</h5>
            <input type="text" placeholder="اسم المستوى" class="level-name">
            <textarea placeholder="متطلبات المستوى" rows="2" class="level-requirements"></textarea>
            <input type="text" placeholder="المكافآت" class="level-rewards">
        </div>
    `;
    container.insertAdjacentHTML('beforeend', html);
}

function addMilestone() {
    const container = document.getElementById('challengeMilestones');
    const dayCount = container.querySelectorAll('.step-item').length + 1;
    
    const html = `
        <div class="step-item">
            <div class="step-header">
                <span>اليوم ${dayCount}</span>
                <span class="remove-step" onclick="removeMilestone(this)">❌</span>
            </div>
            <input type="text" placeholder="مهمة اليوم" class="milestone-task">
            <select class="milestone-verification">
                <option value="checkbox">مربع اختيار</option>
                <option value="photo">صورة</option>
                <option value="text">نص</option>
            </select>
        </div>
    `;
    container.insertAdjacentHTML('beforeend', html);
}

function removeMilestone(button) {
    button.closest('.step-item').remove();
    // Update day numbers
    const milestones = document.querySelectorAll('#challengeMilestones .step-item');
    milestones.forEach((milestone, index) => {
        milestone.querySelector('.step-header span:first-child').textContent = `اليوم ${index + 1}`;
    });
}

function addReflectionQuestion() {
    const container = document.getElementById('reflectionQuestions');
    const html = `
        <div style="margin-bottom: 0.5rem;">
            <input type="text" placeholder="سؤال جديد" style="width: calc(100% - 40px);">
            <button onclick="removeReflectionQuestion(this)" style="width: 30px;">❌</button>
        </div>
    `;
    container.insertAdjacentHTML('beforeend', html);
}

function removeReflectionQuestion(button) {
    button.parentElement.remove();
}

function addVoiceTopic() {
    const container = document.getElementById('voiceTopics');
    const html = `
        <div style="margin-bottom: 0.5rem;">
            <input type="text" placeholder="موضوع للحديث عنه" style="width: calc(100% - 40px);">
            <button onclick="removeVoiceTopic(this)" style="width: 30px;">❌</button>
        </div>
    `;
    container.insertAdjacentHTML('beforeend', html);
}

function removeVoiceTopic(button) {
    button.parentElement.remove();
}

// Helper functions
function getFrequencyName(frequency) {
    const names = {
        daily: 'يومياً',
        every2days: 'كل يومين',
        weekly: 'أسبوعياً',
        asneeded: 'حسب الحاجة'
    };
    return names[frequency] || frequency;
}

function getProgramsDisplay(programs) {
    if (!programs || programs.length === 0 || programs.includes('all')) {
        return 'الكل';
    }
    
    const names = {
        clarity: 'وضوح',
        discovery: 'اكتشاف',
        transformation: 'تحول'
    };
    
    return programs.map(p => names[p] || p).join(', ');
}

function getMeasurementName(type) {
    const names = {
        binary: 'تم / لم يتم',
        scale: 'مقياس (1-10)',
        duration: 'المدة الفعلية',
        quality: 'جودة الأداء',
        text: 'نص مفتوح'
    };
    return names[type] || type;
}

function showLoading(show) {
    document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
}

function showNotification(message, type = 'success') {
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    
    const icon = {
        success: '✓',
        error: '✗',
        info: 'ℹ',
        warning: '⚠'
    };
    
    notification.innerHTML = `
        <span>${icon[type] || icon.info}</span>
        <span>${message}</span>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.opacity = '1';
        notification.style.transform = 'translateX(0)';
    }, 10);
    
    setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => notification.remove(), 300);
    }, 3000);
    
    notification.onclick = () => notification.remove();
}

// Event listeners
document.addEventListener('DOMContentLoaded', function() {
    // Close modal when clicking outside
    window.onclick = function(event) {
        if (event.target.classList.contains('modal')) {
            event.target.style.display = 'none';
        }
    }
    
    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            document.querySelectorAll('.modal').forEach(modal => {
                modal.style.display = 'none';
            });
        }
    });
});

// Initialize reminder timing change listener
document.addEventListener('change', function(e) {
    if (e.target.id === 'reminderTiming') {
        const showOffset = e.target.value !== 'exact';
        document.getElementById('reminderOffset').style.display = showOffset ? 'inline-block' : 'none';
        document.getElementById('offsetUnit').style.display = showOffset ? 'inline' : 'none';
    }
});
</script>
</body>
</html>
