<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مصمم رحلات التحول الذكي - محمود فؤاد</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* الألوان الأساسية */
            --primary: #2C5530;
            --secondary: #8B9467;
            --accent: #D4AF37;
            --light: #F5F2E8;
            --dark: #1A1A1A;
            --white: #FFFFFF;
            --gray-light: #F8F9FA;
            --gray: #6C757D;
            --gray-dark: #343A40;
            
            /* ألوان الرحلات */
            --eshraq: #FF6B35;
            --baseera: #4A90E2;
            --sakeena: #27AE60;
            --eshraq-gradient: linear-gradient(135deg, #FF6B35, #FFB347);
            --baseera-gradient: linear-gradient(135deg, #4A90E2, #7BB3F0);
            --sakeena-gradient: linear-gradient(135deg, #27AE60, #5FCF80);
            --mixed-eshraq-baseera: linear-gradient(135deg, #FF6B35, #4A90E2);
            --mixed-baseera-sakeena: linear-gradient(135deg, #4A90E2, #27AE60);
            
            /* الحالات */
            --success: #28A745;
            --danger: #DC3545;
            --warning: #FFC107;
            --info: #17A2B8;
            
            /* الظلال */
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
            --shadow: 0 4px 6px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 15px rgba(0,0,0,0.1);
            
            /* الانتقالات */
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Arial', sans-serif;
            background: #f0f2f5;
            color: var(--dark);
            line-height: 1.6;
            overflow-x: hidden;
        }

        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            opacity: 1;
            transition: opacity 0.3s;
        }

        .loading-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            position: relative;
        }

        .loading-spinner::before,
        .loading-spinner::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 3px solid transparent;
            border-top-color: var(--primary);
            animation: spin 0.8s linear infinite;
        }

        .loading-spinner::after {
            border-top-color: var(--accent);
            animation-delay: 0.4s;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Navigation */
        .admin-nav {
            background: var(--white);
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .nav-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .nav-brand h2 {
            color: var(--primary);
            font-size: 1.5rem;
            font-weight: 600;
        }

        .nav-links {
            display: flex;
            gap: 2rem;
            align-items: center;
        }

        .nav-links a {
            color: var(--gray);
            text-decoration: none;
            font-weight: 500;
            transition: color 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .nav-links a:hover {
            color: var(--primary);
        }

        .nav-links a.active {
            color: var(--primary);
            position: relative;
        }

        .nav-links a.active::after {
            content: '';
            position: absolute;
            bottom: -1rem;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--accent);
        }

        /* Main Container */
        .main-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Page Header */
        .page-header {
            background: var(--white);
            padding: 2rem;
            border-radius: 16px;
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .page-title {
            font-size: 2rem;
            color: var(--primary);
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .page-title .icon {
            font-size: 2.5rem;
        }

        .header-actions {
            display: flex;
            gap: 1rem;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.95rem;
            font-family: inherit;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .btn-primary {
            background: var(--primary);
            color: var(--white);
        }

        .btn-secondary {
            background: var(--gray-light);
            color: var(--dark);
            border: 2px solid var(--gray-light);
        }

        .btn-success {
            background: var(--success);
            color: var(--white);
        }

        .btn-danger {
            background: var(--danger);
            color: var(--white);
        }

        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }

        /* Journey Selector */
        .journey-selector {
            background: var(--white);
            padding: 2rem;
            border-radius: 16px;
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
        }

        .journey-selector h3 {
            color: var(--primary);
            margin-bottom: 1.5rem;
            font-size: 1.5rem;
        }

        .journey-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .journey-card {
            background: var(--gray-light);
            padding: 1.5rem;
            border-radius: 12px;
            cursor: pointer;
            transition: var(--transition);
            text-align: center;
            border: 3px solid transparent;
            position: relative;
            overflow: hidden;
        }

        .journey-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .journey-card.eshraq::before { background: var(--eshraq); }
        .journey-card.baseera::before { background: var(--baseera); }
        .journey-card.sakeena::before { background: var(--sakeena); }
        .journey-card.eshraq-baseera::before { background: var(--mixed-eshraq-baseera); }
        .journey-card.baseera-sakeena::before { background: var(--mixed-baseera-sakeena); }

        .journey-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .journey-card.active {
            border-color: var(--primary);
            background: var(--white);
        }

        .journey-card.active::before {
            opacity: 1;
        }

        .journey-icon {
            font-size: 3rem;
            margin-bottom: 0.5rem;
        }

        .journey-name {
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 0.25rem;
        }

        .journey-desc {
            font-size: 0.875rem;
            color: var(--gray);
        }

        /* Designer Container */
        .designer-container {
            background: var(--white);
            border-radius: 16px;
            box-shadow: var(--shadow);
            padding: 2rem;
            display: none;
        }

        .designer-container.active {
            display: block;
            animation: fadeIn 0.5s;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Timeline View */
        .timeline-view {
            margin-bottom: 2rem;
            overflow-x: auto;
            padding-bottom: 1rem;
        }

        .timeline-container {
            display: flex;
            gap: 2rem;
            position: relative;
            min-width: fit-content;
            padding: 2rem 0;
        }

        .timeline-phase {
            background: var(--gray-light);
            border-radius: 12px;
            padding: 1.5rem;
            min-width: 250px;
            cursor: pointer;
            transition: var(--transition);
            position: relative;
        }

        .timeline-phase:hover {
            background: var(--white);
            box-shadow: var(--shadow);
        }

        .timeline-phase.active {
            background: var(--white);
            box-shadow: var(--shadow-lg);
            border: 2px solid var(--primary);
        }

        .phase-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .phase-title {
            font-weight: 600;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .phase-title .icon {
            font-size: 1.5rem;
        }

        .phase-actions {
            display: flex;
            gap: 0.5rem;
        }

        .phase-action {
            width: 32px;
            height: 32px;
            background: var(--white);
            border: 1px solid var(--gray-light);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
        }

        .phase-action:hover {
            background: var(--primary);
            color: var(--white);
            border-color: var(--primary);
        }

        .phase-stats {
            font-size: 0.875rem;
            color: var(--gray);
        }

        /* Phase Details */
        .phase-details {
            margin-top: 2rem;
            display: none;
        }

        .phase-details.active {
            display: block;
            animation: slideDown 0.3s;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .detail-section {
            background: var(--gray-light);
            padding: 1.5rem;
            border-radius: 12px;
            margin-bottom: 1rem;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .section-title {
            font-weight: 600;
            color: var(--primary);
            font-size: 1.125rem;
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 0.5rem;
            font-size: 0.95rem;
        }

        .form-control {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid var(--gray-light);
            border-radius: 10px;
            font-size: 0.95rem;
            transition: var(--transition);
            font-family: inherit;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(44, 85, 48, 0.1);
        }

        textarea.form-control {
            resize: vertical;
            min-height: 100px;
        }

        /* Sessions List */
        .sessions-list {
            display: grid;
            gap: 1rem;
        }

        .session-item {
            background: var(--white);
            padding: 1.5rem;
            border-radius: 10px;
            border: 2px solid var(--gray-light);
            cursor: move;
            transition: var(--transition);
            position: relative;
        }

        .session-item:hover {
            border-color: var(--primary);
            box-shadow: var(--shadow);
        }

        .session-item.dragging {
            opacity: 0.5;
        }

        .session-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .session-title {
            font-weight: 600;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .session-number {
            background: var(--primary);
            color: var(--white);
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.875rem;
            font-weight: 600;
        }

        .session-info {
            font-size: 0.875rem;
            color: var(--gray);
            margin-bottom: 0.5rem;
        }

        .session-components {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .component-tag {
            background: var(--light);
            color: var(--primary);
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        /* Component Types */
        .component-list {
            display: grid;
            gap: 0.75rem;
        }

        .component-item {
            background: var(--white);
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid var(--gray-light);
            display: flex;
            align-items: center;
            gap: 1rem;
            cursor: move;
            transition: var(--transition);
        }

        .component-item:hover {
            border-color: var(--primary);
            box-shadow: var(--shadow-sm);
        }

        .component-icon {
            width: 40px;
            height: 40px;
            background: var(--gray-light);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }

        .component-icon.tool { background: rgba(52, 152, 219, 0.1); color: #3498db; }
        .component-icon.message { background: rgba(46, 204, 113, 0.1); color: #2ecc71; }
        .component-icon.exercise { background: rgba(231, 76, 60, 0.1); color: #e74c3c; }
        .component-icon.homework { background: rgba(241, 196, 15, 0.1); color: #f1c40f; }
        .component-icon.document { background: rgba(155, 89, 182, 0.1); color: #9b59b6; }

        .component-content {
            flex: 1;
        }

        .component-name {
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 0.25rem;
        }

        .component-desc {
            font-size: 0.875rem;
            color: var(--gray);
        }

        .component-actions {
            display: flex;
            gap: 0.5rem;
        }

        /* Add Component Menu */
        .add-component-menu {
            position: absolute;
            top: 100%;
            left: 0;
            background: var(--white);
            border: 1px solid var(--gray-light);
            border-radius: 10px;
            box-shadow: var(--shadow-lg);
            padding: 0.5rem;
            min-width: 200px;
            z-index: 10;
            display: none;
        }

        .add-component-menu.show {
            display: block;
            animation: slideDown 0.2s;
        }

        .menu-item {
            padding: 0.75rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .menu-item:hover {
            background: var(--gray-light);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            animation: fadeIn 0.3s;
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--white);
            padding: 2rem;
            border-radius: 16px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            animation: slideUp 0.3s;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-title {
            font-size: 1.5rem;
            color: var(--primary);
            font-weight: 600;
        }

        .modal-close {
            width: 36px;
            height: 36px;
            background: var(--gray-light);
            border: none;
            border-radius: 50%;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }

        .modal-close:hover {
            background: var(--danger);
            color: var(--white);
        }

        /* Tools Library */
        .tools-library {
            display: grid;
            gap: 1rem;
            max-height: 400px;
            overflow-y: auto;
            padding: 0.5rem;
        }

        .tool-item {
            background: var(--gray-light);
            padding: 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .tool-item:hover {
            background: var(--light);
            transform: translateX(-4px);
        }

        .tool-item.selected {
            background: var(--primary);
            color: var(--white);
        }

        .tool-item.selected .tool-type,
        .tool-item.selected .tool-desc {
            color: var(--white);
            opacity: 0.9;
        }

        .tool-icon {
            width: 48px;
            height: 48px;
            background: var(--white);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .tool-info {
            flex: 1;
        }

        .tool-name {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .tool-type {
            font-size: 0.75rem;
            color: var(--gray);
            margin-bottom: 0.25rem;
        }

        .tool-desc {
            font-size: 0.875rem;
            color: var(--gray);
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--success);
            color: var(--white);
            padding: 1rem 1.5rem;
            border-radius: 10px;
            box-shadow: var(--shadow-lg);
            animation: slideInRight 0.3s;
            cursor: pointer;
            z-index: 2000;
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .notification.error {
            background: var(--danger);
        }

        .notification.warning {
            background: var(--warning);
            color: var(--dark);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--gray);
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .empty-state-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .empty-state-text {
            font-size: 0.95rem;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .main-container {
                padding: 1rem;
            }

            .journey-cards {
                grid-template-columns: 1fr;
            }

            .timeline-container {
                flex-direction: column;
            }

            .header-content {
                flex-direction: column;
                gap: 1rem;
                align-items: flex-start;
            }

            .header-actions {
                width: 100%;
                justify-content: space-between;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>

    <!-- Navigation -->
    <nav class="admin-nav">
        <div class="nav-container">
            <div class="nav-brand">
                <h2>لوحة تحكم محمود فؤاد</h2>
            </div>
            <div class="nav-links">
                <a href="admin-dashboard.html">
                    <span>🏠</span>
                    <span>الرئيسية</span>
                </a>
                <a href="admin-bookings.html">
                    <span>📅</span>
                    <span>الحجوزات</span>
                </a>
                <a href="central-dashboard.html">
                    <span>🎯</span>
                    <span>الرحلات</span>
                </a>
                <a href="admin-tools.html">
                    <span>🧰</span>
                    <span>مكتبة الأدوات</span>
                </a>
                <a href="admin-journey-tools.html" class="active">
                    <span>🎨</span>
                    <span>مصمم الرحلات</span>
                </a>
                <a href="#" onclick="logout()">
                    <span>🚪</span>
                    <span>خروج</span>
                </a>
            </div>
        </div>
    </nav>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Page Header -->
        <div class="page-header">
            <div class="header-content">
                <h1 class="page-title">
                    <span class="icon">🎨</span>
                    <span>مصمم رحلات التحول الذكي</span>
                </h1>
                <div class="header-actions">
                    <button class="btn btn-secondary" onclick="loadTemplates()">
                        <span>📑</span>
                        <span>القوالب الجاهزة</span>
                    </button>
                    <button class="btn btn-primary" onclick="saveAllDesigns()">
                        <span>💾</span>
                        <span>حفظ جميع التصميمات</span>
                    </button>
                </div>
            </div>
            <p style="color: var(--gray); margin-top: 0.5rem;">
                صمم رحلات مخصصة بمرونة كاملة - أضف مراحل، عدّل الجلسات، اختر الأدوات المناسبة
            </p>
        </div>

        <!-- Journey Selector -->
        <div class="journey-selector">
            <h3>اختر نوع الرحلة للتصميم</h3>
            <div class="journey-cards">
                <div class="journey-card eshraq" onclick="selectJourney('eshraq')" data-journey="eshraq">
                    <div class="journey-icon">🌅</div>
                    <div class="journey-name">رحلة الإشراقة</div>
                    <div class="journey-desc">3 جلسات مركزة</div>
                </div>
                <div class="journey-card baseera" onclick="selectJourney('baseera')" data-journey="baseera">
                    <div class="journey-icon">👁️</div>
                    <div class="journey-name">رحلة البصيرة</div>
                    <div class="journey-desc">8-12 جلسة متعمقة</div>
                </div>
                <div class="journey-card sakeena" onclick="selectJourney('sakeena')" data-journey="sakeena">
                    <div class="journey-icon">🕊️</div>
                    <div class="journey-name">رحلة السكينة</div>
                    <div class="journey-desc">6 أشهر تحول</div>
                </div>
                <div class="journey-card eshraq-baseera" onclick="selectJourney('eshraq-baseera')" data-journey="eshraq-baseera">
                    <div class="journey-icon">🌅→👁️</div>
                    <div class="journey-name">مسار متدرج</div>
                    <div class="journey-desc">إشراقة ثم بصيرة</div>
                </div>
                <div class="journey-card baseera-sakeena" onclick="selectJourney('baseera-sakeena')" data-journey="baseera-sakeena">
                    <div class="journey-icon">👁️→🕊️</div>
                    <div class="journey-name">مسار متدرج</div>
                    <div class="journey-desc">بصيرة ثم سكينة</div>
                </div>
            </div>
        </div>

        <!-- Designer Container -->
        <div class="designer-container" id="designerContainer">
            <!-- Timeline View -->
            <div class="timeline-view">
                <div class="timeline-container" id="timelineContainer">
                    <!-- Phases will be added dynamically -->
                </div>
            </div>

            <!-- Phase Details -->
            <div class="phase-details" id="phaseDetails">
                <!-- Phase details will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Tools Library Modal -->
    <div class="modal" id="toolsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">اختر أداة من المكتبة</h3>
                <button class="modal-close" onclick="closeModal('toolsModal')">×</button>
            </div>
            <div class="tools-library" id="toolsLibrary">
                <!-- Tools will be loaded here -->
            </div>
            <div style="margin-top: 1.5rem; text-align: center;">
                <button class="btn btn-primary" onclick="addSelectedTool()">
                    <span>➕</span>
                    <span>إضافة الأداة المحددة</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Custom Component Modal -->
    <div class="modal" id="componentModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="componentModalTitle">إضافة مكون جديد</h3>
                <button class="modal-close" onclick="closeModal('componentModal')">×</button>
            </div>
            <form id="componentForm">
                <div class="form-group">
                    <label class="form-label">نوع المكون</label>
                    <select class="form-control" id="componentType" onchange="updateComponentForm()">
                        <option value="message">💬 رسالة</option>
                        <option value="exercise">📝 تمرين</option>
                        <option value="homework">📚 واجب</option>
                        <option value="document">📄 مستند</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">العنوان</label>
                    <input type="text" class="form-control" id="componentTitle" required>
                </div>
                <div class="form-group">
                    <label class="form-label">المحتوى</label>
                    <textarea class="form-control" id="componentContent" rows="4" required></textarea>
                </div>
                <div class="form-group" id="timingGroup" style="display: none;">
                    <label class="form-label">التوقيت</label>
                    <select class="form-control" id="componentTiming">
                        <option value="before">قبل الجلسة</option>
                        <option value="during">أثناء الجلسة</option>
                        <option value="after">بعد الجلسة</option>
                    </select>
                </div>
                <div style="text-align: center; margin-top: 2rem;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('componentModal')">
                        إلغاء
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <span>✓</span>
                        <span>إضافة</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js"></script>

    <script>
        // Initialize Firebase
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Global Variables
        let selectedJourney = null;
        let currentPhase = null;
        let currentSession = null;
        let journeyDesigns = {};
        let availableTools = [];
        let selectedToolId = null;

        // Journey Templates
        const defaultTemplates = {
            'eshraq': {
                name: 'رحلة الإشراقة',
                icon: '🌅',
                phases: [
                    {
                        id: 'pre-journey',
                        name: 'ما قبل الرحلة',
                        type: 'preparation',
                        icon: '🚀',
                        components: [
                            {
                                type: 'message',
                                title: 'رسالة ترحيب',
                                content: 'مرحباً بك في رحلة الإشراقة، رحلة من الظلمة إلى النور...'
                            }
                        ]
                    },
                    {
                        id: 'phase-1',
                        name: 'الاستقبال والاحتواء',
                        type: 'journey',
                        icon: '🌅',
                        sessions: [
                            {
                                id: 'session-1',
                                title: 'جلسة الاستقبال',
                                duration: 90,
                                components: []
                            }
                        ]
                    },
                    {
                        id: 'post-journey',
                        name: 'ما بعد الرحلة',
                        type: 'follow-up',
                        icon: '🎯',
                        components: []
                    }
                ]
            },
            'baseera': {
                name: 'رحلة البصيرة',
                icon: '👁️',
                phases: [
                    {
                        id: 'pre-journey',
                        name: 'ما قبل الرحلة',
                        type: 'preparation',
                        icon: '🚀',
                        components: []
                    },
                    {
                        id: 'phase-1',
                        name: 'مرحلة الكشف',
                        type: 'journey',
                        icon: '🔍',
                        sessions: [
                            {
                                id: 'session-1',
                                title: 'العودة للقصة',
                                duration: 90,
                                components: []
                            },
                            {
                                id: 'session-2',
                                title: 'البنية النفسية',
                                duration: 90,
                                components: []
                            }
                        ]
                    },
                    {
                        id: 'phase-2',
                        name: 'مرحلة التعمق',
                        type: 'journey',
                        icon: '💡',
                        sessions: []
                    },
                    {
                        id: 'phase-3',
                        name: 'مرحلة التكامل',
                        type: 'journey',
                        icon: '🌟',
                        sessions: []
                    },
                    {
                        id: 'post-journey',
                        name: 'ما بعد الرحلة',
                        type: 'follow-up',
                        icon: '🎯',
                        components: []
                    }
                ]
            },
            'sakeena': {
                name: 'رحلة السكينة',
                icon: '🕊️',
                phases: [
                    {
                        id: 'pre-journey',
                        name: 'ما قبل الرحلة',
                        type: 'preparation',
                        icon: '🚀',
                        components: []
                    },
                    {
                        id: 'phase-1',
                        name: 'التطهير العميق',
                        type: 'journey',
                        icon: '💧',
                        sessions: []
                    },
                    {
                        id: 'phase-2',
                        name: 'البناء الجديد',
                        type: 'journey',
                        icon: '🏗️',
                        sessions: []
                    },
                    {
                        id: 'phase-3',
                        name: 'الإشعاع والخدمة',
                        type: 'journey',
                        icon: '✨',
                        sessions: []
                    },
                    {
                        id: 'post-journey',
                        name: 'ما بعد الرحلة',
                        type: 'follow-up',
                        icon: '🎯',
                        components: []
                    }
                ]
            },
            'eshraq-baseera': {
                name: 'مسار متدرج: إشراقة → بصيرة',
                icon: '🌅→👁️',
                phases: [
                    {
                        id: 'pre-journey',
                        name: 'ما قبل الرحلة',
                        type: 'preparation',
                        icon: '🚀',
                        components: []
                    },
                    {
                        id: 'phase-eshraq',
                        name: 'مرحلة الإشراقة',
                        type: 'journey',
                        icon: '🌅',
                        sessions: []
                    },
                    {
                        id: 'phase-transition',
                        name: 'مرحلة الانتقال',
                        type: 'transition',
                        icon: '🌉',
                        components: []
                    },
                    {
                        id: 'phase-baseera',
                        name: 'مرحلة البصيرة',
                        type: 'journey',
                        icon: '👁️',
                        sessions: []
                    },
                    {
                        id: 'post-journey',
                        name: 'ما بعد الرحلة',
                        type: 'follow-up',
                        icon: '🎯',
                        components: []
                    }
                ]
            },
            'baseera-sakeena': {
                name: 'مسار متدرج: بصيرة → سكينة',
                icon: '👁️→🕊️',
                phases: [
                    {
                        id: 'pre-journey',
                        name: 'ما قبل الرحلة',
                        type: 'preparation',
                        icon: '🚀',
                        components: []
                    },
                    {
                        id: 'phase-baseera',
                        name: 'مرحلة البصيرة',
                        type: 'journey',
                        icon: '👁️',
                        sessions: []
                    },
                    {
                        id: 'phase-transition',
                        name: 'مرحلة الانتقال',
                        type: 'transition',
                        icon: '🌉',
                        components: []
                    },
                    {
                        id: 'phase-sakeena',
                        name: 'مرحلة السكينة',
                        type: 'journey',
                        icon: '🕊️',
                        sessions: []
                    },
                    {
                        id: 'post-journey',
                        name: 'ما بعد الرحلة',
                        type: 'follow-up',
                        icon: '🎯',
                        components: []
                    }
                ]
            }
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            checkAuth();
            loadTools();
            loadSavedDesigns();
            setupEventListeners();
        });

        // Check Authentication
        function checkAuth() {
            const authToken = sessionStorage.getItem('adminAuth');
            const authTime = sessionStorage.getItem('authTime');
            const oneHour = 60 * 60 * 1000;

            if (!authToken || authToken !== 'true' || 
                !authTime || (Date.now() - parseInt(authTime) > oneHour)) {
                window.location.href = 'admin-dashboard.html';
            }
        }

        // Load Tools from Database
        async function loadTools() {
            showLoading(true);
            try {
                const snapshot = await db.collection('toolsLibrary')
                    .orderBy('basicInfo.createdDate', 'desc')
                    .get();
                
                availableTools = [];
                snapshot.forEach(doc => {
                    availableTools.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });

                console.log('Loaded tools:', availableTools.length);
            } catch (error) {
                console.error('Error loading tools:', error);
                showNotification('خطأ في تحميل الأدوات', 'error');
            } finally {
                showLoading(false);
            }
        }

        // Load Saved Designs
        async function loadSavedDesigns() {
            try {
                const snapshot = await db.collection('journeyDesigns').get();
                
                snapshot.forEach(doc => {
                    journeyDesigns[doc.id] = doc.data().design || defaultTemplates[doc.id];
                });

                // Fill missing designs with defaults
                Object.keys(defaultTemplates).forEach(key => {
                    if (!journeyDesigns[key]) {
                        journeyDesigns[key] = JSON.parse(JSON.stringify(defaultTemplates[key]));
                    }
                });

                console.log('Loaded designs:', Object.keys(journeyDesigns));
            } catch (error) {
                console.error('Error loading designs:', error);
                // Use defaults
                journeyDesigns = JSON.parse(JSON.stringify(defaultTemplates));
            }
        }

        // Select Journey
        function selectJourney(journeyType) {
            selectedJourney = journeyType;
            
            // Update UI
            document.querySelectorAll('.journey-card').forEach(card => {
                card.classList.remove('active');
            });
            document.querySelector(`[data-journey="${journeyType}"]`).classList.add('active');
            
            // Show designer
            document.getElementById('designerContainer').classList.add('active');
            
            // Load journey design
            loadJourneyDesign(journeyType);
        }

        // Load Journey Design
        function loadJourneyDesign(journeyType) {
            const design = journeyDesigns[journeyType] || defaultTemplates[journeyType];
            renderTimeline(design);
        }

        // Render Timeline
        function renderTimeline(design) {
            const container = document.getElementById('timelineContainer');
            container.innerHTML = '';

            design.phases.forEach((phase, index) => {
                const phaseEl = createPhaseElement(phase, index);
                container.appendChild(phaseEl);
            });

            // Add "Add Phase" button
            const addPhaseBtn = document.createElement('div');
            addPhaseBtn.className = 'timeline-phase add-phase';
            addPhaseBtn.innerHTML = `
                <div style="text-align: center; padding: 2rem;">
                    <div style="font-size: 3rem; margin-bottom: 0.5rem;">➕</div>
                    <div style="font-weight: 600;">إضافة مرحلة جديدة</div>
                </div>
            `;
            addPhaseBtn.onclick = () => addNewPhase();
            container.appendChild(addPhaseBtn);
        }

        // Create Phase Element
        function createPhaseElement(phase, index) {
            const phaseEl = document.createElement('div');
            phaseEl.className = 'timeline-phase';
            phaseEl.dataset.phaseId = phase.id;
            phaseEl.dataset.phaseIndex = index;

            let stats = '';
            if (phase.type === 'journey' && phase.sessions) {
                stats = `${phase.sessions.length} جلسة`;
            } else if (phase.components) {
                stats = `${phase.components.length} مكون`;
            }

            phaseEl.innerHTML = `
                <div class="phase-header">
                    <div class="phase-title">
                        <span class="icon">${phase.icon || '📋'}</span>
                        <span>${phase.name}</span>
                    </div>
                    <div class="phase-actions">
                        <button class="phase-action" onclick="editPhase('${phase.id}')" title="تعديل">
                            ✏️
                        </button>
                        <button class="phase-action" onclick="deletePhase('${phase.id}')" title="حذف">
                            🗑️
                        </button>
                    </div>
                </div>
                <div class="phase-stats">${stats}</div>
            `;

            phaseEl.onclick = (e) => {
                if (!e.target.closest('.phase-action')) {
                    selectPhase(phase.id);
                }
            };

            return phaseEl;
        }

        // Select Phase
        function selectPhase(phaseId) {
            currentPhase = phaseId;
            
            // Update UI
            document.querySelectorAll('.timeline-phase').forEach(el => {
                el.classList.remove('active');
            });
            document.querySelector(`[data-phase-id="${phaseId}"]`).classList.add('active');
            
            // Show phase details
            showPhaseDetails(phaseId);
        }

        // Show Phase Details
        function showPhaseDetails(phaseId) {
            const design = journeyDesigns[selectedJourney];
            const phase = design.phases.find(p => p.id === phaseId);
            
            if (!phase) return;

            const detailsEl = document.getElementById('phaseDetails');
            detailsEl.innerHTML = '';
            detailsEl.classList.add('active');

            // Phase Info Section
            const infoSection = document.createElement('div');
            infoSection.className = 'detail-section';
            infoSection.innerHTML = `
                <div class="section-header">
                    <h4 class="section-title">معلومات المرحلة</h4>
                </div>
                <div class="form-group">
                    <label class="form-label">اسم المرحلة</label>
                    <input type="text" class="form-control" id="phaseName" 
                           value="${phase.name}" onchange="updatePhaseName('${phaseId}')">
                </div>
                <div class="form-group">
                    <label class="form-label">وصف المرحلة</label>
                    <textarea class="form-control" id="phaseDesc" 
                              onchange="updatePhaseDesc('${phaseId}')">${phase.description || ''}</textarea>
                </div>
            `;
            detailsEl.appendChild(infoSection);

            // Content Section
            if (phase.type === 'journey') {
                // Sessions Section
                const sessionsSection = document.createElement('div');
                sessionsSection.className = 'detail-section';
                sessionsSection.innerHTML = `
                    <div class="section-header">
                        <h4 class="section-title">الجلسات</h4>
                        <button class="btn btn-sm btn-primary" onclick="addSession('${phaseId}')">
                            <span>➕</span>
                            <span>إضافة جلسة</span>
                        </button>
                    </div>
                    <div class="sessions-list" id="sessionsList">
                        ${phase.sessions && phase.sessions.length > 0 ? '' : 
                          '<div class="empty-state"><div class="empty-state-icon">📝</div><div class="empty-state-text">لا توجد جلسات بعد</div></div>'}
                    </div>
                `;
                detailsEl.appendChild(sessionsSection);

                // Render sessions
                if (phase.sessions && phase.sessions.length > 0) {
                    const sessionsList = sessionsSection.querySelector('#sessionsList');
                    sessionsList.innerHTML = '';
                    phase.sessions.forEach((session, index) => {
                        sessionsList.appendChild(createSessionElement(session, index, phaseId));
                    });
                }
            } else {
                // Components Section for non-journey phases
                const componentsSection = document.createElement('div');
                componentsSection.className = 'detail-section';
                componentsSection.innerHTML = `
                    <div class="section-header">
                        <h4 class="section-title">المكونات</h4>
                        <div style="position: relative;">
                            <button class="btn btn-sm btn-primary" onclick="toggleAddComponentMenu('${phaseId}')">
                                <span>➕</span>
                                <span>إضافة مكون</span>
                            </button>
                            <div class="add-component-menu" id="addComponentMenu-${phaseId}">
                                <div class="menu-item" onclick="showToolsModal('${phaseId}')">
                                    <span>🔧</span>
                                    <span>أداة من المكتبة</span>
                                </div>
                                <div class="menu-item" onclick="showComponentModal('message', '${phaseId}')">
                                    <span>💬</span>
                                    <span>رسالة مخصصة</span>
                                </div>
                                <div class="menu-item" onclick="showComponentModal('exercise', '${phaseId}')">
                                    <span>📝</span>
                                    <span>تمرين</span>
                                </div>
                                <div class="menu-item" onclick="showComponentModal('document', '${phaseId}')">
                                    <span>📄</span>
                                    <span>مستند</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="component-list" id="componentsList">
                        ${phase.components && phase.components.length > 0 ? '' : 
                          '<div class="empty-state"><div class="empty-state-icon">📦</div><div class="empty-state-text">لا توجد مكونات بعد</div></div>'}
                    </div>
                `;
                detailsEl.appendChild(componentsSection);

                // Render components
                if (phase.components && phase.components.length > 0) {
                    const componentsList = componentsSection.querySelector('#componentsList');
                    componentsList.innerHTML = '';
                    phase.components.forEach((component, index) => {
                        componentsList.appendChild(createComponentElement(component, index, phaseId));
                    });
                }
            }
        }

        // Create Session Element
        function createSessionElement(session, index, phaseId) {
            const sessionEl = document.createElement('div');
            sessionEl.className = 'session-item';
            sessionEl.dataset.sessionId = session.id;
            sessionEl.dataset.sessionIndex = index;
            sessionEl.draggable = true;

            const componentsCount = session.components ? session.components.length : 0;

            sessionEl.innerHTML = `
                <div class="session-header">
                    <div class="session-title">
                        <span class="session-number">${index + 1}</span>
                        <span>${session.title}</span>
                    </div>
                    <div class="phase-actions">
                        <button class="phase-action" onclick="editSession('${phaseId}', '${session.id}')" title="تعديل">
                            ✏️
                        </button>
                        <button class="phase-action" onclick="deleteSession('${phaseId}', '${session.id}')" title="حذف">
                            🗑️
                        </button>
                    </div>
                </div>
                <div class="session-info">
                    <span>⏱️ ${session.duration || 90} دقيقة</span>
                    <span>•</span>
                    <span>📦 ${componentsCount} مكون</span>
                </div>
                <div class="session-components">
                    ${renderSessionComponents(session.components)}
                </div>
                <div style="margin-top: 0.75rem;">
                    <button class="btn btn-sm btn-secondary" onclick="manageSessionComponents('${phaseId}', '${session.id}')">
                        <span>⚙️</span>
                        <span>إدارة المكونات</span>
                    </button>
                </div>
            `;

            // Add drag and drop events
            sessionEl.addEventListener('dragstart', handleDragStart);
            sessionEl.addEventListener('dragover', handleDragOver);
            sessionEl.addEventListener('drop', handleDrop);
            sessionEl.addEventListener('dragend', handleDragEnd);

            return sessionEl;
        }

        // Render Session Components
        function renderSessionComponents(components) {
            if (!components || components.length === 0) {
                return '<span class="component-tag">لا توجد مكونات</span>';
            }

            return components.slice(0, 3).map(comp => {
                const icon = getComponentIcon(comp.type);
                return `<span class="component-tag">${icon} ${comp.title || comp.name}</span>`;
            }).join('') + (components.length > 3 ? `<span class="component-tag">+${components.length - 3}</span>` : '');
        }

        // Create Component Element
        function createComponentElement(component, index, parentId) {
            const componentEl = document.createElement('div');
            componentEl.className = 'component-item';
            componentEl.dataset.componentIndex = index;
            componentEl.draggable = true;

            const icon = getComponentIcon(component.type);

            componentEl.innerHTML = `
                <div class="component-icon ${component.type}">${icon}</div>
                <div class="component-content">
                    <div class="component-name">${component.title || component.name}</div>
                    <div class="component-desc">${component.content || component.description || ''}</div>
                </div>
                <div class="component-actions">
                    <button class="phase-action" onclick="editComponent('${parentId}', ${index})" title="تعديل">
                        ✏️
                    </button>
                    <button class="phase-action" onclick="deleteComponent('${parentId}', ${index})" title="حذف">
                        🗑️
                    </button>
                </div>
            `;

            // Add drag and drop events
            componentEl.addEventListener('dragstart', handleDragStart);
            componentEl.addEventListener('dragover', handleDragOver);
            componentEl.addEventListener('drop', handleDrop);
            componentEl.addEventListener('dragend', handleDragEnd);

            return componentEl;
        }

        // Get Component Icon
        function getComponentIcon(type) {
            const icons = {
                tool: '🔧',
                message: '💬',
                exercise: '📝',
                homework: '📚',
                document: '📄',
                video: '🎥',
                audio: '🎵'
            };
            return icons[type] || '📦';
        }

        // Add New Phase
        function addNewPhase() {
            const design = journeyDesigns[selectedJourney];
            const newPhase = {
                id: `phase-${Date.now()}`,
                name: 'مرحلة جديدة',
                type: 'journey',
                icon: '📋',
                sessions: []
            };

            // Insert before the last phase (post-journey)
            const insertIndex = design.phases.length - 1;
            design.phases.splice(insertIndex, 0, newPhase);

            renderTimeline(design);
            selectPhase(newPhase.id);
            saveDesign();
        }

        // Add Session
        function addSession(phaseId) {
            const design = journeyDesigns[selectedJourney];
            const phase = design.phases.find(p => p.id === phaseId);
            
            if (!phase || phase.type !== 'journey') return;

            if (!phase.sessions) phase.sessions = [];

            const newSession = {
                id: `session-${Date.now()}`,
                title: `جلسة ${phase.sessions.length + 1}`,
                duration: 90,
                components: []
            };

            phase.sessions.push(newSession);
            showPhaseDetails(phaseId);
            saveDesign();
        }

        // Delete Phase
        function deletePhase(phaseId) {
            if (!confirm('هل أنت متأكد من حذف هذه المرحلة؟')) return;

            const design = journeyDesigns[selectedJourney];
            const index = design.phases.findIndex(p => p.id === phaseId);
            
            if (index > -1) {
                design.phases.splice(index, 1);
                renderTimeline(design);
                document.getElementById('phaseDetails').innerHTML = '';
                document.getElementById('phaseDetails').classList.remove('active');
                saveDesign();
            }
        }

        // Delete Session
        function deleteSession(phaseId, sessionId) {
            if (!confirm('هل أنت متأكد من حذف هذه الجلسة؟')) return;

            const design = journeyDesigns[selectedJourney];
            const phase = design.phases.find(p => p.id === phaseId);
            
            if (!phase || !phase.sessions) return;

            const index = phase.sessions.findIndex(s => s.id === sessionId);
            if (index > -1) {
                phase.sessions.splice(index, 1);
                showPhaseDetails(phaseId);
                saveDesign();
            }
        }

        // Edit Session
        function editSession(phaseId, sessionId) {
            const design = journeyDesigns[selectedJourney];
            const phase = design.phases.find(p => p.id === phaseId);
            const session = phase.sessions.find(s => s.id === sessionId);
            
            if (!session) return;

            const newTitle = prompt('عنوان الجلسة:', session.title);
            if (newTitle && newTitle !== session.title) {
                session.title = newTitle;
                showPhaseDetails(phaseId);
                saveDesign();
            }

            const newDuration = prompt('مدة الجلسة (بالدقائق):', session.duration);
            if (newDuration && !isNaN(newDuration)) {
                session.duration = parseInt(newDuration);
                showPhaseDetails(phaseId);
                saveDesign();
            }
        }

        // Manage Session Components
        function manageSessionComponents(phaseId, sessionId) {
            currentSession = { phaseId, sessionId };
            showPhaseDetails(phaseId);
            
            // Focus on the session
            const sessionEl = document.querySelector(`[data-session-id="${sessionId}"]`);
            if (sessionEl) {
                sessionEl.style.border = '2px solid var(--primary)';
                sessionEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
}
        }

        // Toggle Add Component Menu
        function toggleAddComponentMenu(parentId) {
            const menu = document.getElementById(`addComponentMenu-${parentId}`);
            if (menu) {
                menu.classList.toggle('show');
            }
            
            // Close other menus
            document.querySelectorAll('.add-component-menu').forEach(m => {
                if (m.id !== `addComponentMenu-${parentId}`) {
                    m.classList.remove('show');
                }
            });
        }

        // Show Tools Modal
        function showToolsModal(parentId) {
            currentPhase = parentId;
            selectedToolId = null;
            
            const modal = document.getElementById('toolsModal');
            const library = document.getElementById('toolsLibrary');
            
            library.innerHTML = '';
            
            if (availableTools.length === 0) {
                library.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">🧰</div>
                        <div class="empty-state-text">لا توجد أدوات في المكتبة</div>
                    </div>
                `;
            } else {
                availableTools.forEach(tool => {
                    const toolEl = createToolElement(tool);
                    library.appendChild(toolEl);
                });
            }
            
            modal.classList.add('show');
            
            // Close menu
            document.querySelectorAll('.add-component-menu').forEach(m => {
                m.classList.remove('show');
            });
        }

        // Create Tool Element
        function createToolElement(tool) {
            const toolEl = document.createElement('div');
            toolEl.className = 'tool-item';
            toolEl.dataset.toolId = tool.id;
            
            const typeNames = {
                practice: 'ممارسة',
                meditation: 'تأمل',
                game: 'لعبة',
                challenge: 'تحدي',
                reflection: 'تأمل كتابي',
                voice: 'تمرين صوتي'
            };
            
            const typeIcons = {
                practice: '💪',
                meditation: '🧘',
                game: '🎮',
                challenge: '🎯',
                reflection: '📝',
                voice: '🎤'
            };
            
            const typeName = typeNames[tool.basicInfo.type] || 'أداة';
            const icon = typeIcons[tool.basicInfo.type] || '🔧';
            
            toolEl.innerHTML = `
                <div class="tool-icon">${icon}</div>
                <div class="tool-info">
                    <div class="tool-name">${tool.basicInfo.name}</div>
                    <div class="tool-type">${typeName} • ${tool.settings.defaultDuration || 15} دقيقة</div>
                    <div class="tool-desc">${tool.basicInfo.description || ''}</div>
                </div>
            `;
            
            toolEl.onclick = () => selectTool(tool.id);
            
            return toolEl;
        }

        // Select Tool
        function selectTool(toolId) {
            selectedToolId = toolId;
            
            document.querySelectorAll('.tool-item').forEach(el => {
                el.classList.remove('selected');
            });
            
            document.querySelector(`[data-tool-id="${toolId}"]`).classList.add('selected');
        }

        // Add Selected Tool
        function addSelectedTool() {
            if (!selectedToolId) {
                showNotification('الرجاء اختيار أداة أولاً', 'warning');
                return;
            }
            
            const tool = availableTools.find(t => t.id === selectedToolId);
            if (!tool) return;
            
            const design = journeyDesigns[selectedJourney];
            const phase = design.phases.find(p => p.id === currentPhase);
            
            if (!phase) return;
            
            const toolComponent = {
                type: 'tool',
                toolId: tool.id,
                title: tool.basicInfo.name,
                description: tool.basicInfo.description,
                duration: tool.settings.defaultDuration,
                frequency: tool.settings.frequency
            };
            
            if (currentSession) {
                // Add to session
                const session = phase.sessions.find(s => s.id === currentSession.sessionId);
                if (session) {
                    if (!session.components) session.components = [];
                    session.components.push(toolComponent);
                }
            } else {
                // Add to phase
                if (!phase.components) phase.components = [];
                phase.components.push(toolComponent);
            }
            
            closeModal('toolsModal');
            showPhaseDetails(currentPhase);
            saveDesign();
            showNotification('تم إضافة الأداة بنجاح', 'success');
        }

        // Show Component Modal
        function showComponentModal(type, parentId) {
            currentPhase = parentId;
            
            const modal = document.getElementById('componentModal');
            const form = document.getElementById('componentForm');
            const typeSelect = document.getElementById('componentType');
            const titleEl = document.getElementById('componentModalTitle');
            
            // Reset form
            form.reset();
            typeSelect.value = type;
            
            // Update title
            const titles = {
                message: 'إضافة رسالة',
                exercise: 'إضافة تمرين',
                homework: 'إضافة واجب',
                document: 'إضافة مستند'
            };
            titleEl.textContent = titles[type] || 'إضافة مكون';
            
            updateComponentForm();
            modal.classList.add('show');
            
            // Close menu
            document.querySelectorAll('.add-component-menu').forEach(m => {
                m.classList.remove('show');
            });
        }

        // Update Component Form
        function updateComponentForm() {
            const type = document.getElementById('componentType').value;
            const timingGroup = document.getElementById('timingGroup');
            
            if (type === 'message') {
                timingGroup.style.display = 'block';
            } else {
                timingGroup.style.display = 'none';
            }
        }

        // Setup Event Listeners
        function setupEventListeners() {
            // Component form submission
            document.getElementById('componentForm').onsubmit = (e) => {
                e.preventDefault();
                
                const type = document.getElementById('componentType').value;
                const title = document.getElementById('componentTitle').value;
                const content = document.getElementById('componentContent').value;
                const timing = document.getElementById('componentTiming').value;
                
                const component = {
                    type: type,
                    title: title,
                    content: content
                };
                
                if (type === 'message') {
                    component.timing = timing;
                }
                
                // Add to current phase or session
                const design = journeyDesigns[selectedJourney];
                const phase = design.phases.find(p => p.id === currentPhase);
                
                if (!phase) return;
                
                if (currentSession) {
                    // Add to session
                    const session = phase.sessions.find(s => s.id === currentSession.sessionId);
                    if (session) {
                        if (!session.components) session.components = [];
                        session.components.push(component);
                    }
                } else {
                    // Add to phase
                    if (!phase.components) phase.components = [];
                    phase.components.push(component);
                }
                
                closeModal('componentModal');
                showPhaseDetails(currentPhase);
                saveDesign();
                showNotification('تم إضافة المكون بنجاح', 'success');
            };
            
            // Click outside to close modals
            window.onclick = (e) => {
                if (e.target.classList.contains('modal')) {
                    e.target.classList.remove('show');
                }
                
                // Close add component menus
                if (!e.target.closest('.add-component-menu') && !e.target.closest('.btn')) {
                    document.querySelectorAll('.add-component-menu').forEach(m => {
                        m.classList.remove('show');
                    });
                }
            };
        }

        // Update Phase Name
        function updatePhaseName(phaseId) {
            const newName = document.getElementById('phaseName').value;
            const design = journeyDesigns[selectedJourney];
            const phase = design.phases.find(p => p.id === phaseId);
            
            if (phase && newName) {
                phase.name = newName;
                renderTimeline(design);
                saveDesign();
            }
        }

        // Update Phase Description
        function updatePhaseDesc(phaseId) {
            const newDesc = document.getElementById('phaseDesc').value;
            const design = journeyDesigns[selectedJourney];
            const phase = design.phases.find(p => p.id === phaseId);
            
            if (phase) {
                phase.description = newDesc;
                saveDesign();
            }
        }

        // Delete Component
        function deleteComponent(parentId, index) {
            if (!confirm('هل أنت متأكد من حذف هذا المكون؟')) return;
            
            const design = journeyDesigns[selectedJourney];
            const phase = design.phases.find(p => p.id === parentId);
            
            if (!phase) return;
            
            if (currentSession) {
                // Delete from session
                const session = phase.sessions.find(s => s.id === currentSession.sessionId);
                if (session && session.components) {
                    session.components.splice(index, 1);
                }
            } else {
                // Delete from phase
                if (phase.components) {
                    phase.components.splice(index, 1);
                }
            }
            
            showPhaseDetails(parentId);
            saveDesign();
        }

        // Edit Component
        function editComponent(parentId, index) {
            const design = journeyDesigns[selectedJourney];
            const phase = design.phases.find(p => p.id === parentId);
            
            if (!phase) return;
            
            let component;
            if (currentSession) {
                const session = phase.sessions.find(s => s.id === currentSession.sessionId);
                if (session && session.components) {
                    component = session.components[index];
                }
            } else {
                if (phase.components) {
                    component = phase.components[index];
                }
            }
            
            if (!component) return;
            
            // Simple edit for now
            const newTitle = prompt('عنوان المكون:', component.title);
            if (newTitle) {
                component.title = newTitle;
                showPhaseDetails(parentId);
                saveDesign();
            }
        }

        // Drag and Drop Functions
        let draggedElement = null;
        let draggedType = null;
        let draggedData = null;

        function handleDragStart(e) {
            draggedElement = e.target;
            draggedType = e.target.classList.contains('session-item') ? 'session' : 'component';
            
            if (draggedType === 'session') {
                draggedData = {
                    phaseId: currentPhase,
                    sessionIndex: parseInt(e.target.dataset.sessionIndex)
                };
            } else {
                draggedData = {
                    parentId: currentPhase,
                    componentIndex: parseInt(e.target.dataset.componentIndex)
                };
            }
            
            e.target.style.opacity = '0.5';
        }

        function handleDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            return false;
        }

        function handleDrop(e) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }
            
            if (!draggedElement || !e.target.closest('.session-item, .component-item')) {
                return false;
            }
            
            const targetElement = e.target.closest('.session-item, .component-item');
            
            if (draggedElement !== targetElement) {
                if (draggedType === 'session' && targetElement.classList.contains('session-item')) {
                    reorderSessions(draggedData, parseInt(targetElement.dataset.sessionIndex));
                } else if (draggedType === 'component' && targetElement.classList.contains('component-item')) {
                    reorderComponents(draggedData, parseInt(targetElement.dataset.componentIndex));
                }
            }
            
            return false;
        }

        function handleDragEnd(e) {
            e.target.style.opacity = '';
            draggedElement = null;
            draggedType = null;
            draggedData = null;
        }

        // Reorder Sessions
        function reorderSessions(dragData, targetIndex) {
            const design = journeyDesigns[selectedJourney];
            const phase = design.phases.find(p => p.id === dragData.phaseId);
            
            if (!phase || !phase.sessions) return;
            
            const fromIndex = dragData.sessionIndex;
            if (fromIndex === targetIndex) return;
            
            const session = phase.sessions.splice(fromIndex, 1)[0];
            phase.sessions.splice(targetIndex, 0, session);
            
            showPhaseDetails(dragData.phaseId);
            saveDesign();
        }

        // Reorder Components
        function reorderComponents(dragData, targetIndex) {
            const design = journeyDesigns[selectedJourney];
            const phase = design.phases.find(p => p.id === dragData.parentId);
            
            if (!phase) return;
            
            let components;
            if (currentSession) {
                const session = phase.sessions.find(s => s.id === currentSession.sessionId);
                if (session) {
                    components = session.components;
                }
            } else {
                components = phase.components;
            }
            
            if (!components) return;
            
            const fromIndex = dragData.componentIndex;
            if (fromIndex === targetIndex) return;
            
            const component = components.splice(fromIndex, 1)[0];
            components.splice(targetIndex, 0, component);
            
            showPhaseDetails(dragData.parentId);
            saveDesign();
        }

        // Save Design
        async function saveDesign() {
            if (!selectedJourney) return;
            
            try {
                await db.collection('journeyDesigns').doc(selectedJourney).set({
                    journeyType: selectedJourney,
                    design: journeyDesigns[selectedJourney],
                    lastModified: firebase.firestore.FieldValue.serverTimestamp(),
                    modifiedBy: auth.currentUser?.uid || 'admin'
                });
                
                console.log('Design saved successfully');
            } catch (error) {
                console.error('Error saving design:', error);
                showNotification('خطأ في حفظ التصميم', 'error');
            }
        }

        // Save All Designs
        async function saveAllDesigns() {
            showLoading(true);
            
            try {
                const batch = db.batch();
                
                Object.keys(journeyDesigns).forEach(journeyType => {
                    const docRef = db.collection('journeyDesigns').doc(journeyType);
                    batch.set(docRef, {
                        journeyType: journeyType,
                        design: journeyDesigns[journeyType],
                        lastModified: firebase.firestore.FieldValue.serverTimestamp(),
                        modifiedBy: auth.currentUser?.uid || 'admin'
                    });
                });
                
                await batch.commit();
                showNotification('تم حفظ جميع التصميمات بنجاح', 'success');
            } catch (error) {
                console.error('Error saving all designs:', error);
                showNotification('خطأ في حفظ التصميمات', 'error');
            } finally {
                showLoading(false);
            }
        }

        // Load Templates
        function loadTemplates() {
            showNotification('قوالب جاهزة قيد التطوير', 'info');
        }

        // Close Modal
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }

        // Show Loading
        function showLoading(show) {
            const overlay = document.getElementById('loadingOverlay');
            if (show) {
                overlay.classList.remove('hidden');
            } else {
                overlay.classList.add('hidden');
            }
        }

        // Show Notification
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <span>${message}</span>
            `;
            
            document.body.appendChild(notification);
            
            // Remove after 3 seconds
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => {
                    notification.remove();
                }, 300);
            }, 3000);
            
            // Click to dismiss
            notification.onclick = () => {
                notification.remove();
            };
        }

        // Logout
        function logout() {
            if (confirm('هل تريد تسجيل الخروج؟')) {
                sessionStorage.clear();
                window.location.href = 'admin-dashboard.html';
            }
        }

        // Initialize on load
        window.addEventListener('load', () => {
            setTimeout(() => {
                showLoading(false);
            }, 500);
        });
    </script>
</body>
</html>
