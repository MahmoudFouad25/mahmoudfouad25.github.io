// أضف هذا الكود في booking.html بعد حفظ البيانات في Firestore

// بعد السطر:
const docRef = await db.collection('bookings').add(finalData);

// أضف هذا الكود:
// إنشاء حساب للعميل إذا لم يكن موجوداً
try {
    // توليد كلمة مرور عشوائية
    const temporaryPassword = generatePassword();
    
    // محاولة إنشاء حساب جديد
    const userCredential = await auth.createUserWithEmailAndPassword(
        formData.email, 
        temporaryPassword
    );
    
    // حفظ بيانات المستخدم في Firestore
    await db.collection('users').doc(userCredential.user.uid).set({
        name: formData.name,
        email: formData.email,
        phone: formData.phone,
        program: formData.program,
        bookingId: docRef.id,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        firstLogin: false,
        temporaryPassword: true // علامة أن كلمة المرور مؤقتة
    });
    
    // إرسال كلمة المرور للعميل عبر الإيميل
    // يمكنك استخدام EmailJS أو Cloud Functions
    sendPasswordEmail(formData.email, formData.name, temporaryPassword);
    
    console.log('تم إنشاء حساب جديد للعميل');
    
} catch (error) {
    if (error.code === 'auth/email-already-in-use') {
        // العميل له حساب بالفعل - لا مشكلة
        console.log('العميل له حساب موجود');
        
        // تحديث بيانات المستخدم بالحجز الجديد
        const existingUser = await auth.getUserByEmail(formData.email);
        if (existingUser) {
            await db.collection('users').doc(existingUser.uid).update({
                lastBooking: docRef.id,
                lastBookingDate: firebase.firestore.FieldValue.serverTimestamp()
            });
        }
    } else {
        console.error('خطأ في إنشاء الحساب:', error);
        // لا نوقف عملية الحجز - فقط نسجل الخطأ
    }
}

// دالة توليد كلمة مرور آمنة
function generatePassword() {
    const length = 8;
    const charset = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%";
    let password = "";
    for (let i = 0; i < length; i++) {
        password += charset.charAt(Math.floor(Math.random() * charset.length));
    }
    return password;
}

// دالة إرسال كلمة المرور بالإيميل
function sendPasswordEmail(email, name, password) {
    // الطريقة 1: استخدام EmailJS (مجاني وسهل)
    // سجل في https://www.emailjs.com وأضف:
    
    /*
    emailjs.send('YOUR_SERVICE_ID', 'YOUR_TEMPLATE_ID', {
        to_email: email,
        to_name: name,
        password: password,
        login_link: 'https://mahmoudfouad25.github.io/login.html'
    });
    */
    
    // الطريقة 2: عرض كلمة المرور مؤقتاً (للتجربة)
    // يمكن إضافة هذا في رسالة النجاح
    const successMessage = document.getElementById('successMessage');
    successMessage.innerHTML += `
        <div style="background: #e8f5e9; padding: 20px; border-radius: 10px; margin-top: 20px;">
            <h3>بيانات دخولك للوحة التحكم:</h3>
            <p><strong>البريد الإلكتروني:</strong> ${email}</p>
            <p><strong>كلمة المرور المؤقتة:</strong> ${password}</p>
            <p style="color: #d32f2f; margin-top: 10px;">
                ⚠️ احفظ هذه البيانات! سيتم إرسالها أيضاً لبريدك الإلكتروني.
            </p>
            <a href="login.html" class="btn btn-primary" style="margin-top: 10px;">
                دخول لوحة التحكم
            </a>
        </div>
    `;
    
    // الطريقة 3: إرسال عبر WhatsApp API (إضافي)
    const whatsappPasswordMsg = `
مرحباً ${name} 👋

بيانات دخولك لمنصة محمود فؤاد:

📧 البريد: ${email}
🔐 كلمة المرور: ${password}

🔗 رابط الدخول:
https://mahmoudfouad25.github.io/login.html

⚠️ نصيحة: غيّر كلمة المرور بعد أول دخول

مع تحياتي،
محمود فؤاد
    `;
    
    // فتح واتساب بالرسالة (اختياري)
    // window.open(`https://wa.me/${formData.phone}?text=${encodeURIComponent(whatsappPasswordMsg)}`, '_blank');
}
