// ุฃุถู ูุฐุง ุงูููุฏ ูู booking.html ุจุนุฏ ุญูุธ ุงูุจูุงูุงุช ูู Firestore

// ุจุนุฏ ุงูุณุทุฑ:
const docRef = await db.collection('bookings').add(finalData);

// ุฃุถู ูุฐุง ุงูููุฏ:
// ุฅูุดุงุก ุญุณุงุจ ููุนููู ุฅุฐุง ูู ููู ููุฌูุฏุงู
try {
    // ุชูููุฏ ูููุฉ ูุฑูุฑ ุนุดูุงุฆูุฉ
    const temporaryPassword = generatePassword();
    
    // ูุญุงููุฉ ุฅูุดุงุก ุญุณุงุจ ุฌุฏูุฏ
    const userCredential = await auth.createUserWithEmailAndPassword(
        formData.email, 
        temporaryPassword
    );
    
    // ุญูุธ ุจูุงูุงุช ุงููุณุชุฎุฏู ูู Firestore
    await db.collection('users').doc(userCredential.user.uid).set({
        name: formData.name,
        email: formData.email,
        phone: formData.phone,
        program: formData.program,
        bookingId: docRef.id,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        firstLogin: false,
        temporaryPassword: true // ุนูุงูุฉ ุฃู ูููุฉ ุงููุฑูุฑ ูุคูุชุฉ
    });
    
    // ุฅุฑุณุงู ูููุฉ ุงููุฑูุฑ ููุนููู ุนุจุฑ ุงูุฅูููู
    // ููููู ุงุณุชุฎุฏุงู EmailJS ุฃู Cloud Functions
    sendPasswordEmail(formData.email, formData.name, temporaryPassword);
    
    console.log('ุชู ุฅูุดุงุก ุญุณุงุจ ุฌุฏูุฏ ููุนููู');
    
} catch (error) {
    if (error.code === 'auth/email-already-in-use') {
        // ุงูุนููู ูู ุญุณุงุจ ุจุงููุนู - ูุง ูุดููุฉ
        console.log('ุงูุนููู ูู ุญุณุงุจ ููุฌูุฏ');
        
        // ุชุญุฏูุซ ุจูุงูุงุช ุงููุณุชุฎุฏู ุจุงูุญุฌุฒ ุงูุฌุฏูุฏ
        const existingUser = await auth.getUserByEmail(formData.email);
        if (existingUser) {
            await db.collection('users').doc(existingUser.uid).update({
                lastBooking: docRef.id,
                lastBookingDate: firebase.firestore.FieldValue.serverTimestamp()
            });
        }
    } else {
        console.error('ุฎุทุฃ ูู ุฅูุดุงุก ุงูุญุณุงุจ:', error);
        // ูุง ูููู ุนูููุฉ ุงูุญุฌุฒ - ููุท ูุณุฌู ุงูุฎุทุฃ
    }
}

// ุฏุงูุฉ ุชูููุฏ ูููุฉ ูุฑูุฑ ุขููุฉ
function generatePassword() {
    const length = 8;
    const charset = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%";
    let password = "";
    for (let i = 0; i < length; i++) {
        password += charset.charAt(Math.floor(Math.random() * charset.length));
    }
    return password;
}

// ุฏุงูุฉ ุฅุฑุณุงู ูููุฉ ุงููุฑูุฑ ุจุงูุฅูููู
function sendPasswordEmail(email, name, password) {
    // ุงูุทุฑููุฉ 1: ุงุณุชุฎุฏุงู EmailJS (ูุฌุงูู ูุณูู)
    // ุณุฌู ูู https://www.emailjs.com ูุฃุถู:
    
    /*
    emailjs.send('YOUR_SERVICE_ID', 'YOUR_TEMPLATE_ID', {
        to_email: email,
        to_name: name,
        password: password,
        login_link: 'https://mahmoudfouad25.github.io/login.html'
    });
    */
    
    // ุงูุทุฑููุฉ 2: ุนุฑุถ ูููุฉ ุงููุฑูุฑ ูุคูุชุงู (ููุชุฌุฑุจุฉ)
    // ูููู ุฅุถุงูุฉ ูุฐุง ูู ุฑุณุงูุฉ ุงููุฌุงุญ
    const successMessage = document.getElementById('successMessage');
    successMessage.innerHTML += `
        <div style="background: #e8f5e9; padding: 20px; border-radius: 10px; margin-top: 20px;">
            <h3>ุจูุงูุงุช ุฏุฎููู ูููุญุฉ ุงูุชุญูู:</h3>
            <p><strong>ุงูุจุฑูุฏ ุงูุฅููุชุฑููู:</strong> ${email}</p>
            <p><strong>ูููุฉ ุงููุฑูุฑ ุงููุคูุชุฉ:</strong> ${password}</p>
            <p style="color: #d32f2f; margin-top: 10px;">
                โ๏ธ ุงุญูุธ ูุฐู ุงูุจูุงูุงุช! ุณูุชู ุฅุฑุณุงููุง ุฃูุถุงู ูุจุฑูุฏู ุงูุฅููุชุฑููู.
            </p>
            <a href="login.html" class="btn btn-primary" style="margin-top: 10px;">
                ุฏุฎูู ููุญุฉ ุงูุชุญูู
            </a>
        </div>
    `;
    
    // ุงูุทุฑููุฉ 3: ุฅุฑุณุงู ุนุจุฑ WhatsApp API (ุฅุถุงูู)
    const whatsappPasswordMsg = `
ูุฑุญุจุงู ${name} ๐

ุจูุงูุงุช ุฏุฎููู ูููุตุฉ ูุญููุฏ ูุคุงุฏ:

๐ง ุงูุจุฑูุฏ: ${email}
๐ ูููุฉ ุงููุฑูุฑ: ${password}

๐ ุฑุงุจุท ุงูุฏุฎูู:
https://mahmoudfouad25.github.io/login.html

โ๏ธ ูุตูุญุฉ: ุบููุฑ ูููุฉ ุงููุฑูุฑ ุจุนุฏ ุฃูู ุฏุฎูู

ูุน ุชุญูุงุชูุ
ูุญููุฏ ูุคุงุฏ
    `;
    
    // ูุชุญ ูุงุชุณุงุจ ุจุงูุฑุณุงูุฉ (ุงุฎุชูุงุฑู)
    // window.open(`https://wa.me/${formData.phone}?text=${encodeURIComponent(whatsappPasswordMsg)}`, '_blank');
}
