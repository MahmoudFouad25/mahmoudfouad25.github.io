<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>إدارة الحجوزات - محمود فؤاد</title>
<style>
* {
margin: 0;
padding: 0;
box-sizing: border-box;
}
:root {
--primary: #2C5530;
--secondary: #8B9467;
--accent: #D4AF37;
--light: #F5F2E8;
--dark: #1A1A1A;
--gradient: linear-gradient(135deg, #2C5530 0%, #8B9467 100%);
--success: #28a745;
--danger: #dc3545;
--warning: #ffc107;
--info: #17a2b8;
}
body {
font-family: 'Segoe UI', Tahoma, Arial, sans-serif;
background: #f5f5f5;
color: var(--dark);
min-height: 100vh;
}
/* Loading Overlay */
.loading-overlay {
position: fixed;
top: 0;
left: 0;
right: 0;
bottom: 0;
background: rgba(0, 0, 0, 0.7);
display: none;
justify-content: center;
align-items: center;
z-index: 9999;
}
.loading-spinner {
width: 50px;
height: 50px;
border: 5px solid #f3f3f3;
border-top: 5px solid var(--primary);
border-radius: 50%;
animation: spin 1s linear infinite;
}
@keyframes spin {
0% { transform: rotate(0deg); }
100% { transform: rotate(360deg); }
}
/* Login Check Container */
.auth-check {
display: flex;
justify-content: center;
align-items: center;
min-height: 100vh;
background: var(--gradient);
}
.auth-message {
background: white;
padding: 3rem;
border-radius: 15px;
box-shadow: 0 10px 40px rgba(0,0,0,0.2);
text-align: center;
}
.auth-message h2 {
color: var(--primary);
margin-bottom: 1rem;
}
.auth-message p {
color: #666;
margin-bottom: 2rem;
}
.auth-message button {
padding: 1rem 2rem;
background: var(--gradient);
color: white;
border: none;
border-radius: 8px;
font-size: 1rem;
font-weight: bold;
cursor: pointer;
}
/* Navigation */
.admin-nav {
background: white;
box-shadow: 0 2px 10px rgba(0,0,0,0.1);
padding: 1rem 2rem;
position: sticky;
top: 0;
z-index: 1000;
}
.nav-container {
max-width: 1400px;
margin: 0 auto;
display: flex;
justify-content: space-between;
align-items: center;
}
.nav-brand h2 {
color: var(--primary);
font-size: 1.5rem;
}
.nav-links {
display: flex;
gap: 2rem;
align-items: center;
}
.nav-links a {
color: var(--dark);
text-decoration: none;
font-weight: 500;
position: relative;
transition: color 0.3s;
}
.nav-links a:hover {
color: var(--primary);
}
.nav-links a.active {
color: var(--primary);
}
.nav-links a.active::after {
content: '';
position: absolute;
bottom: -5px;
left: 0;
right: 0;
height: 3px;
background: var(--accent);
}
.badge {
background: var(--danger);
color: white;
padding: 2px 6px;
border-radius: 10px;
font-size: 0.75rem;
margin-right: 5px;
display: inline-block;
min-width: 20px;
text-align: center;
}
/* Main Container */
.bookings-container {
max-width: 1400px;
margin: 0 auto;
padding: 2rem;
}
/* Header Section */
.page-header {
background: white;
padding: 2rem;
border-radius: 15px;
box-shadow: 0 5px 20px rgba(0,0,0,0.1);
margin-bottom: 2rem;
}
.page-header h1 {
color: var(--primary);
font-size: 2rem;
margin-bottom: 0.5rem;
}
.page-header p {
color: #666;
}
/* Stats Cards */
.stats-row {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
gap: 1rem;
margin-bottom: 2rem;
}
.stat-card {
background: white;
padding: 1.5rem;
border-radius: 10px;
box-shadow: 0 3px 15px rgba(0,0,0,0.1);
text-align: center;
}
.stat-card h3 {
color: #666;
font-size: 0.9rem;
margin-bottom: 0.5rem;
}
.stat-card .number {
font-size: 2rem;
font-weight: bold;
color: var(--primary);
}
/* Filters Section */
.filters-section {
background: white;
padding: 1.5rem;
border-radius: 10px;
box-shadow: 0 3px 15px rgba(0,0,0,0.1);
margin-bottom: 2rem;
}
.filters-grid {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
gap: 1rem;
align-items: end;
}
.filter-group {
display: flex;
flex-direction: column;
gap: 0.5rem;
}
.filter-group label {
color: var(--primary);
font-weight: 500;
font-size: 0.9rem;
}
.filter-group input,
.filter-group select {
padding: 0.75rem;
border: 2px solid #ddd;
border-radius: 8px;
font-size: 1rem;
}
.filter-group input:focus,
.filter-group select:focus {
outline: none;
border-color: var(--primary);
}
.filter-actions {
display: flex;
gap: 0.5rem;
align-items: end;
}
/* Action Buttons Section */
.action-buttons {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 1rem;
flex-wrap: wrap;
gap: 1rem;
}
.action-buttons-left {
display: flex;
gap: 0.5rem;
flex-wrap: wrap;
}
.action-buttons-right {
display: flex;
gap: 0.5rem;
}
/* Bookings Table */
.bookings-section {
background: white;
border-radius: 10px;
box-shadow: 0 3px 15px rgba(0,0,0,0.1);
overflow: hidden;
}
.table-header {
padding: 1.5rem;
border-bottom: 2px solid #f0f0f0;
}
.table-header h2 {
color: var(--primary);
font-size: 1.3rem;
}
.table-container {
overflow-x: auto;
}
table {
width: 100%;
border-collapse: collapse;
}
th {
background: #f8f9fa;
padding: 1rem;
text-align: right;
font-weight: 600;
color: var(--primary);
border-bottom: 2px solid #e9ecef;
white-space: nowrap;
}
td {
padding: 1rem;
border-bottom: 1px solid #f0f0f0;
}
tr:hover {
background: #f8f9fa;
}
/* Category Headers */
.category-header td {
font-weight: bold;
padding: 10px;
border: none;
}
/* Type Badges */
.type-badge {
padding: 4px 10px;
border-radius: 20px;
font-size: 0.85rem;
font-weight: 600;
display: inline-block;
}
.type-badge.challenge-work {
background: #d4edda;
color: #155724;
}
.type-badge.challenge-relationships {
background: #d1ecf1;
color: #0c5460;
}
.type-badge.challenge-self {
background: #fff3cd;
color: #856404;
}
.type-badge.challenge-decision {
background: #f8d7da;
color: #721c24;
}
.type-badge.challenge-default {
background: #e2e3e5;
color: #383d41;
}
/* Journey Badges */
.journey-badge {
padding: 4px 10px;
border-radius: 5px;
font-size: 0.85rem;
font-weight: 600;
display: inline-block;
}
.journey-badge.eshraq {
background: #fff3cd;
color: #856404;
}
.journey-badge.baseera {
background: #d1ecf1;
color: #0c5460;
}
.journey-badge.sakeena {
background: #d4edda;
color: #155724;
}
.journey-badge.eshraq-baseera,
.journey-badge.baseera-sakeena {
background: linear-gradient(45deg, #fff3cd, #d1ecf1);
color: #333;
}
.recommended-note {
display: block;
font-size: 0.75rem;
color: #6c757d;
font-style: italic;
margin-top: 2px;
}
.match-icon {
font-size: 1.2rem;
font-weight: bold;
}
.match-icon.yes {
color: #28a745;
}
.match-icon.no {
color: #ffc107;
}
.urgency-level {
padding: 4px 8px;
border-radius: 4px;
font-weight: bold;
font-size: 0.85rem;
}
.urgency-level.urgent {
background: #f8d7da;
color: #721c24;
}
.urgency-level.moderate {
background: #fff3cd;
color: #856404;
}
.urgency-level.low {
background: #d4edda;
color: #155724;
}
/* Status Badges */
.status-badge {
padding: 4px 12px;
border-radius: 5px;
font-size: 0.85rem;
font-weight: 600;
display: inline-block;
}
.status-badge.pending {
background: #fff3cd;
color: #856404;
}
.status-badge.confirming {
background: #d1ecf1;
color: #0c5460;
}
.status-badge.confirmed {
background: #d4edda;
color: #155724;
}
.status-badge.completed,
.status-badge.converted {
background: #cce5ff;
color: #004085;
}
.status-badge.cancelled {
background: #f8d7da;
color: #721c24;
}
/* Action Buttons */
.actions-cell {
display: flex;
gap: 0.5rem;
flex-wrap: wrap;
}
.btn {
padding: 0.4rem 0.8rem;
border: none;
border-radius: 6px;
font-weight: 500;
cursor: pointer;
transition: all 0.3s;
font-size: 0.85rem;
white-space: nowrap;
}
.btn:hover {
transform: translateY(-2px);
box-shadow: 0 2px 8px rgba(0,0,0,0.15);
}
.btn:disabled {
opacity: 0.5;
cursor: not-allowed;
transform: none !important;
}
.btn-primary {
background: var(--primary);
color: white;
}
.btn-success {
background: var(--success);
color: white;
}
.btn-info {
background: var(--info);
color: white;
}
.btn-warning {
background: var(--warning);
color: #212529;
}
.btn-danger {
background: var(--danger);
color: white;
}
.btn-whatsapp {
background: #25d366;
color: white;
}
.btn-secondary {
background: #6c757d;
color: white;
}
.btn-sm {
padding: 0.3rem 0.6rem;
font-size: 0.8rem;
}
/* Client Info */
.client-info {
display: flex;
flex-direction: column;
gap: 0.2rem;
}
.client-name {
font-weight: 600;
color: var(--primary);
}
.client-contact {
font-size: 0.85rem;
color: #666;
}
/* Empty State */
.empty-state {
text-align: center;
padding: 4rem 2rem;
color: #999;
}
.empty-state-icon {
font-size: 4rem;
margin-bottom: 1rem;
opacity: 0.5;
}
/* Modals */
.modal {
display: none;
position: fixed;
z-index: 2000;
left: 0;
top: 0;
width: 100%;
height: 100%;
background-color: rgba(0,0,0,0.5);
animation: fadeIn 0.3s;
}
@keyframes fadeIn {
from { opacity: 0; }
to { opacity: 1; }
}
.modal-content {
background-color: white;
margin: 2% auto;
padding: 2rem;
border-radius: 15px;
width: 90%;
max-width: 600px;
max-height: 90vh;
overflow-y: auto;
animation: slideIn 0.3s;
}
@keyframes slideIn {
from { transform: translateY(-50px); opacity: 0; }
to { transform: translateY(0); opacity: 1; }
}
.modal-header {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 1.5rem;
}
.modal-header h2 {
color: var(--primary);
}
.close {
color: #aaa;
font-size: 28px;
font-weight: bold;
cursor: pointer;
transition: color 0.3s;
}
.close:hover {
color: #000;
}
.form-group {
margin-bottom: 1.5rem;
}
.form-group label {
display: block;
margin-bottom: 0.5rem;
color: var(--primary);
font-weight: 600;
}
.form-group input,
.form-group textarea,
.form-group select {
width: 100%;
padding: 0.75rem;
border: 2px solid #ddd;
border-radius: 8px;
font-size: 1rem;
}
.form-group textarea {
resize: vertical;
min-height: 100px;
}
.form-group input:focus,
.form-group textarea:focus,
.form-group select:focus {
outline: none;
border-color: var(--primary);
}
.modal-actions {
display: flex;
gap: 1rem;
justify-content: flex-end;
margin-top: 2rem;
}
/* Appointment Slots */
.slots-container {
display: grid;
gap: 0.5rem;
margin: 1rem 0;
}
.slot-item {
padding: 0.75rem;
border: 2px solid #ddd;
border-radius: 8px;
cursor: pointer;
transition: all 0.3s;
display: flex;
align-items: center;
gap: 0.5rem;
}
.slot-item:hover {
border-color: var(--primary);
background: #f8f9fa;
}
.slot-item.selected {
border-color: var(--primary);
background: var(--light);
}
.slot-item input[type="checkbox"] {
width: auto;
}
/* Info Boxes */
.info-box {
background: #f8f9fa;
padding: 1rem;
border-radius: 8px;
margin-bottom: 1rem;
border-right: 4px solid var(--primary);
}
.info-box h4 {
color: var(--primary);
margin-bottom: 0.5rem;
}
.info-box p {
color: #666;
font-size: 0.9rem;
margin: 0.3rem 0;
}
/* Journey Info */
.journey-info {
display: flex;
flex-direction: column;
gap: 0.2rem;
}
/* Notification */
.notification {
position: fixed;
top: 20px;
right: 20px;
padding: 15px 25px;
border-radius: 8px;
box-shadow: 0 5px 20px rgba(0,0,0,0.2);
z-index: 10000;
animation: slideInNotification 0.3s;
cursor: pointer;
}
@keyframes slideInNotification {
from {
transform: translateX(100%);
opacity: 0;
}
to {
transform: translateX(0);
opacity: 1;
}
}
.notification.success {
background: var(--success);
color: white;
}
.notification.error {
background: var(--danger);
color: white;
}
.notification.info {
background: var(--info);
color: white;
}
/* Responsive */
@media (max-width: 768px) {
.bookings-container {
padding: 1rem;
}
.nav-links {
gap: 1rem;
font-size: 0.9rem;
}
.stats-row {
grid-template-columns: repeat(2, 1fr);
}
.filters-grid {
grid-template-columns: 1fr;
}
.table-container {
overflow-x: scroll;
}
table {
min-width: 800px;
}
.actions-cell {
flex-direction: column;
}
.btn {
width: 100%;
}
}
</style>
</head>
<body>
<!-- Loading Overlay -->
<div class="loading-overlay">
<div class="loading-spinner"></div>
</div>
<!-- Auth Check -->
<div id="authCheck" class="auth-check" style="display: none;">
<div class="auth-message">
<h2>غير مصرح</h2>
<p>يجب تسجيل الدخول أولاً للوصول لهذه الصفحة</p>
<button onclick="window.location.href='admin-dashboard.html'">
الذهاب لصفحة الدخول
</button>
</div>
</div>

<!-- Main Content -->
<div id="mainContent" style="display: none;">
<!-- Navigation -->
<nav class="admin-nav">
<div class="nav-container">
<div class="nav-brand">
<h2>لوحة تحكم محمود فؤاد</h2>
</div>
<div class="nav-links">
<a href="admin-dashboard.html">
<span>🏠</span>
<span>الرئيسية</span>
</a>
<a href="admin-bookings.html" class="active">
<span>📅</span>
<span>الحجوزات</span>
</a>
<a href="central-dashboard.html">
<span>🚀</span>
<span>الرحلات</span>
</a>
<a href="admin-tools.html">
<span>🛠️</span>
<span>الأدوات</span>
</a>
<a href="#" onclick="logout()">
<span>🚪</span>
<span>خروج</span>
</a>
</div>
</div>
</nav>
<!-- Bookings Container -->
<div class="bookings-container">
<!-- Page Header -->
<div class="page-header">
<h1>إدارة الحجوزات والطلبات</h1>
<p>استقبال ومعالجة طلبات الحجز وتحويلها لرحلات</p>
</div>
<!-- Stats Row -->
<div class="stats-row">
<div class="stat-card">
<h3>طلبات جديدة</h3>
<div class="number" id="pendingCount">0</div>
</div>
<div class="stat-card">
<h3>في انتظار التأكيد</h3>
<div class="number" id="confirmingCount">0</div>
</div>
<div class="stat-card">
<h3>مؤكدة</h3>
<div class="number" id="confirmedCount">0</div>
</div>
<div class="stat-card">
<h3>مكتملة/محولة</h3>
<div class="number" id="completedCount">0</div>
</div>
</div>
<!-- Filters Section -->
<div class="filters-section">
<div class="filters-grid">
<div class="filter-group">
<label>البحث</label>
<input type="text" id="searchInput" placeholder="بحث بالاسم أو البريد أو الهاتف..."
onkeyup="applyFilters()">
</div>
<div class="filter-group">
<label>نوع الرحلة</label>
<select id="journeyFilter" onchange="applyFilters()">
<option value="">جميع الرحلات</option>
<option value="eshraq">الإشراقة</option>
<option value="baseera">البصيرة</option>
<option value="sakeena">السكينة</option>
<option value="multi">المسارات المتدرجة</option>
</select>
</div>
<div class="filter-group">
<label>نوع التحدي</label>
<select id="challengeFilter" onchange="applyFilters()">
<option value="">جميع التحديات</option>
<option value="work">تحدي العمل</option>
<option value="relationships">تحدي العلاقات</option>
<option value="self">تحدي الذات</option>
<option value="decision">اتخاذ قرار</option>
</select>
</div>
<div class="filter-group">
<label>الحالة</label>
<select id="statusFilter" onchange="applyFilters()">
<option value="">جميع الحالات</option>
<option value="pending">في الانتظار</option>
<option value="confirming">قيد التأكيد</option>
<option value="confirmed">مؤكد</option>
<option value="completed">مكتمل</option>
<option value="converted">تم التحويل</option>
<option value="cancelled">ملغي</option>
</select>
</div>
<div class="filter-group filter-actions">
<button class="btn btn-info" onclick="resetFilters()">
إعادة تعيين
</button>
<button class="btn btn-success" onclick="refreshData()">
تحديث
</button>
</div>
</div>
</div>

<!-- Bookings Table -->
<div class="bookings-section">
<div class="table-header">
<h2>قائمة الحجوزات</h2>
<div class="action-buttons">
<div class="action-buttons-left">
<button class="btn btn-secondary" onclick="showSlotsManager()">
<span>📅</span> إدارة المواعيد
</button>
</div>
<div class="action-buttons-right">
<button class="btn btn-primary" onclick="exportToExcel()">
تصدير Excel
</button>
</div>
</div>
</div>
<div class="table-container">
<table id="bookingsTable">
<thead>
<tr>
<th>التاريخ</th>
<th>العميل</th>
<th>نوع التحدي</th>
<th>الرحلة المطلوبة</th>
<th>التوافق</th>
<th>مستوى الإلحاح</th>
<th>الحالة</th>
<th>الإجراءات</th>
</tr>
</thead>
<tbody id="bookingsTableBody">
<!-- سيتم ملؤها بواسطة JavaScript -->
</tbody>
</table>
</div>
</div>
</div>
</div>
<!-- Modals -->
<!-- Slots Manager Modal -->
<div id="slotsModal" class="modal">
<div class="modal-content">
<div class="modal-header">
<h2>إدارة المواعيد المتاحة</h2>
<span class="close" onclick="closeModal('slotsModal')">&times;</span>
</div>
<div class="form-group">
<label>أضف موعد جديد:</label>
<div style="display: flex; gap: 10px;">
<input type="date" id="slotDate" min="">
<input type="time" id="slotTime">
<button class="btn btn-success" onclick="addSlot()">إضافة</button>
</div>
</div>
<div class="form-group">
<label>أضف مواعيد متعددة:</label>
<input type="date" id="bulkStartDate" min="" placeholder="من تاريخ">
<input type="date" id="bulkEndDate" min="" placeholder="إلى تاريخ">
<select id="bulkTimes" multiple style="height: 150px; width: 100%; margin: 10px 0;">
<option value="09:00">9:00 ص</option>
<option value="10:00">10:00 ص</option>
<option value="11:00">11:00 ص</option>
<option value="12:00">12:00 م</option>
<option value="14:00">2:00 م</option>
<option value="15:00">3:00 م</option>
<option value="16:00">4:00 م</option>
<option value="17:00">5:00 م</option>
<option value="18:00">6:00 م</option>
<option value="19:00">7:00 م</option>
<option value="20:00">8:00 م</option>
</select>
<button class="btn btn-primary" onclick="addBulkSlots()">إضافة جماعية</button>
</div>
<h3>المواعيد المحفوظة:</h3>
<div id="slotsList" style="max-height: 300px; overflow-y: auto;">
<!-- سيتم ملؤها بواسطة JavaScript -->
</div>
</div>
</div>
<!-- Send Appointments Modal -->
<div id="appointmentsModal" class="modal">
<div class="modal-content">
<div class="modal-header">
<h2>إرسال مواعيد مقترحة</h2>
<span class="close" onclick="closeModal('appointmentsModal')">&times;</span>
</div>
<div class="info-box">
<h4>تعليمات:</h4>
<p>• اختر 3-5 مواعيد مناسبة للعميل</p>
<p>• تأكد من توفر المواعيد في جدولك</p>
<p>• يمكنك إضافة رسالة شخصية</p>
</div>
<div class="form-group">
<label>المواعيد المتاحة:</label>
<div class="slots-container" id="slotsContainer">
<!-- سيتم ملؤها ديناميكياً -->
</div>
</div>
<div class="form-group">
<label>رسالة مخصصة (اختياري):</label>
<textarea id="customMessage" placeholder="أضف رسالة شخصية للعميل..."></textarea>
</div>
<div class="modal-actions">
<button class="btn btn-secondary" onclick="closeModal('appointmentsModal')">إلغاء</button>
<button class="btn btn-success" onclick="sendAppointments()">إرسال المواعيد</button>
</div>
</div>
</div>
<!-- Confirm Appointment Modal -->
<div id="confirmModal" class="modal">
<div class="modal-content">
<div class="modal-header">
<h2>تأكيد الموعد</h2>
<span class="close" onclick="closeModal('confirmModal')">&times;</span>
</div>
<div class="form-group">
<label>التاريخ:</label>
<input type="date" id="appointmentDate" min="">
</div>
<div class="form-group">
<label>الوقت:</label>
<input type="time" id="appointmentTime">
</div>
<div class="form-group">
<label>نوع الجلسة:</label>
<select id="sessionType">
<option value="online">أونلاين (Zoom)</option>
<option value="phone">مكالمة هاتفية</option>
<option value="inperson">حضوري</option>
</select>
</div>
<div class="form-group">
<label>رابط الجلسة (للأونلاين):</label>
<input type="text" id="sessionLink" placeholder="https://zoom.us/j/...">
</div>
<div class="modal-actions">
<button class="btn btn-secondary" onclick="closeModal('confirmModal')">إلغاء</button>
<button class="btn btn-success" onclick="confirmAppointment()">تأكيد الموعد</button>
</div>
</div>
</div>
<!-- Notes Modal -->
<div id="notesModal" class="modal">
<div class="modal-content">
<div class="modal-header">
<h2>ملاحظات الحجز</h2>
<span class="close" onclick="closeModal('notesModal')">&times;</span>
</div>
<div class="info-box" id="bookingInfoBox">
<!-- سيتم ملؤها ديناميكياً -->
</div>
<div class="form-group">
<label>الملاحظات:</label>
<textarea id="notesTextarea" rows="5" placeholder="اكتب ملاحظاتك هنا..."></textarea>
</div>
<div class="modal-actions">
<button class="btn btn-secondary" onclick="closeModal('notesModal')">إلغاء</button>
<button class="btn btn-primary" onclick="saveNotes()">حفظ الملاحظات</button>
</div>
</div>
</div>
<!-- Booking Details Modal -->
<div id="detailsModal" class="modal">
<div class="modal-content">
<div class="modal-header">
<h2>تفاصيل الحجز</h2>
<span class="close" onclick="closeModal('detailsModal')">&times;</span>
</div>
<div id="bookingDetailsContent">
<!-- سيتم ملؤها ديناميكياً -->
</div>
<div class="modal-actions">
<button class="btn btn-primary" onclick="closeModal('detailsModal')">إغلاق</button>
</div>
</div>
</div>
<!-- Firebase Scripts -->
<script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
<script src="firebase-config.js"></script>
<script>
// Initialize
const auth = firebase.auth();
const db = firebase.firestore();
let allBookings = [];
let filteredBookings = [];
let currentBookingId = null;
let availableSlots = JSON.parse(localStorage.getItem('availableSlots') || '[]');
let cachedBookings = null;
let cacheTime = null;
// Helper functions - MUST BE DEFINED FIRST
function showLoading(show) {
    const loadingOverlay = document.querySelector('.loading-overlay');
    if (loadingOverlay) {
        loadingOverlay.style.display = show ? 'flex' : 'none';
    }
}

function showNotification(message, type = 'success') {
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.textContent = message;
    notification.onclick = () => notification.remove();
    document.body.appendChild(notification);
    setTimeout(() => {
        notification.remove();
    }, 5000);
}

function openModal(modalId) {
    document.getElementById(modalId).style.display = 'block';
}

function closeModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
}

function formatDate(date) {
    if (!date) return '';
    return date.toLocaleDateString('ar-EG', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
}

function getStatusName(status) {
    const names = {
        pending: 'في الانتظار',
        confirming: 'قيد التأكيد',
        confirmed: 'مؤكد',
        completed: 'مكتمل',
        converted: 'تم التحويل',
        cancelled: 'ملغي'
    };
    return names[status] || 'في الانتظار';
}

function getJourneyDisplayName(journeyType) {
    const names = {
        'eshraq': 'رحلة الإشراقة',
        'baseera': 'رحلة البصيرة',
        'sakeena': 'رحلة السكينة',
        'eshraq-baseera': 'مسار متدرج (إشراقة ← بصيرة)',
        'baseera-sakeena': 'مسار متدرج (بصيرة ← سكينة)'
    };
    return names[journeyType] || journeyType || 'غير محدد';
}

function getChallengeDisplayName(challengeType) {
    const types = {
        'work': 'تحدي في العمل',
        'relationships': 'تحدي في العلاقات',
        'self': 'تحدي مع الذات',
        'decision': 'اتخاذ قرار مهم',
        'emptiness': 'شعور بالفراغ',
        'patterns': 'أنماط متكررة',
        'passion': 'فقدان الشغف',
        'misplaced': 'عدم الانتماء',
        'clear-vision': 'رؤية واضحة تحتاج تنفيذ',
        'need-change': 'حاجة لتغيير جذري',
        'awakening': 'يقظة روحية',
        'enough': 'وصول لنقطة التحول'
    };
    return types[challengeType] || challengeType || 'غير محدد';
}

function getChallengeClass(challengeType) {
    const classes = {
        'work': 'challenge-work',
        'relationships': 'challenge-relationships',
        'self': 'challenge-self',
        'decision': 'challenge-decision'
    };
    return classes[challengeType] || 'challenge-default';
}

function getSessionTypeName(type) {
    const names = {
        online: 'أونلاين',
        phone: 'هاتفي',
        inperson: 'حضوري'
    };
    return names[type] || 'أونلاين';
}

function getExperienceText(experience) {
    const experiences = {
        'therapy': 'علاج نفسي تقليدي',
        'coaching': 'كوتشينج حياة',
        'workshops': 'ورش تطوير ذات',
        'meditation': 'ممارسات تأملية/يوغا',
        'reading': 'قراءات في علم النفس/التنمية',
        'spiritual': 'رحلة روحية/دينية عميقة',
        'none': 'لا شيء مما سبق'
    };
    return experiences[experience] || experience;
}

function getSupportText(support) {
    const supports = {
        'family': 'عائلة داعمة',
        'friends': 'أصدقاء واعون',
        'spiritual': 'ممارسة روحية/دينية',
        'learning': 'قراءة وتعلم ذاتي',
        'physical': 'رياضة أو ممارسة جسدية',
        'work': 'عمل يحبه',
        'hobby': 'هواية أو شغف',
        'none': 'لا شيء مما سبق'
    };
    return supports[support] || support;
}

function getAnswerText(question, answer) {
    const answerTexts = {
        q1: {
            a: 'يواجه تحدياً محدداً يريد حلاً له',
            b: 'يشعر بأن شيئاً ما "ليس صحيحاً" في حياته',
            c: 'يريد أن يفهم نفسه بشكل أعمق',
            d: 'مستعد لتحول جذري في حياته'
        },
        q2: {
            a: '"كيف أحل هذه المشكلة بسرعة؟"',
            b: '"لماذا يحدث لي هذا دائماً؟"',
            c: '"ما الرسالة التي تحملها هذه التجربة؟"',
            d: '"هذا امتحان/فرصة للنمو"'
        },
        q4: {
            a: 'لا، كل موقف مختلف تماماً',
            b: 'نعم، يلاحظ بعض التشابه',
            c: 'نعم، هناك نمط واضح يراه',
            d: 'الآن بعد السؤال، بدأ يلاحظ...'
        },
        q6: {
            a: 'مستعد تماماً - يريد الحقيقة مهما كانت',
            b: 'مستعد بحذر - يريد التدرج',
            c: 'قلق لكن مستعد - يحتاج دعماً كبيراً',
            d: 'غير متأكد - يريد البدء بهدوء'
        },
        q8: {
            a: 'أنه ليس بالقوة التي يظنها',
            b: 'أنه السبب في معظم مشاكله',
            c: 'أنه يحتاج تغييراً جذرياً',
            d: 'أنه بخير كما هو ولا يحتاج كل هذا',
            e: 'يفضل عدم التفكير في هذا'
        },
        q9: {
            a: 'محدود جداً - ساعة أسبوعياً أو أقل',
            b: 'متوسط - 2-3 ساعات أسبوعياً',
            c: 'جيد - 3-5 ساعات أسبوعياً',
            d: 'ملتزم تماماً - أكثر من 5 ساعات'
        }
    };
    return answerTexts[question]?.[answer] || answer;
}

function getSubAnswerText(question, mainAnswer, subAnswer) {
    const subAnswerTexts = {
        q1: {
            a: {
                'work': 'التحدي في العمل/المهنة',
                'relationships': 'التحدي في العلاقات',
                'self': 'التحدي مع نفسه',
                'decision': 'التحدي في اتخاذ قرار مهم'
            },
            b: {
                'emptiness': 'شعور بالفراغ رغم الإنجازات',
                'patterns': 'تكرار نفس الأنماط المؤلمة',
                'passion': 'فقدان الشغف والمعنى',
                'misplaced': 'إحساس بأنه ليس في مكانه الصحيح'
            },
            c: {
                'why-behavior': 'لماذا يتصرف بالطريقة التي يتصرف بها؟',
                'true-self': 'من هو حقاً خلف كل الأقنعة؟',
                'life-role': 'ما هو دوره الحقيقي في الحياة؟',
                'potential': 'كيف يحقق إمكانياته الكامنة؟'
            },
            d: {
                'clear-vision': 'لديه رؤية واضحة ويحتاج دعماً للتنفيذ',
                'need-change': 'يعرف أنه يحتاج تغييراً جذرياً لكن لا يعرف كيف',
                'awakening': 'مر بتجربة أيقظته ويريد البناء عليها',
                'enough': 'وصل لمرحلة "كفى" ويريد حياة مختلفة'
            }
        }
    };
    return subAnswerTexts[question]?.[mainAnswer]?.[subAnswer] || subAnswer;
}

function getPatternText(pattern) {
    const patterns = {
        'people': 'نفس نوع الأشخاص يسبب له المشاكل',
        'mistakes': 'يكرر نفس الأخطاء',
        'situations': 'يجد نفسه في نفس المواقف',
        'reactions': 'ردود أفعاله متشابهة'
    };
    return patterns[pattern] || pattern;
}
    
// Check authentication on load
window.onload = function() {
checkAuth();
setMinDates();
};

// Check authentication
function checkAuth() {
const authToken = sessionStorage.getItem('adminAuth');
const authTime = sessionStorage.getItem('authTime');
const oneHour = 60 * 60 * 1000;
if (authToken === 'true' && authTime && (Date.now() - parseInt(authTime) < oneHour)) {
document.getElementById('authCheck').style.display = 'none';
document.getElementById('mainContent').style.display = 'block';
loadBookings();
// Refresh every 30 seconds
setInterval(() => loadBookings(true), 30000);
} else {
document.getElementById('authCheck').style.display = 'flex';
document.getElementById('mainContent').style.display = 'none';
}
}

// Logout
function logout() {
if (confirm('هل تريد تسجيل الخروج؟')) {
sessionStorage.clear();
window.location.href = 'admin-dashboard.html';
}
}

// Set minimum dates for date inputs
function setMinDates() {
const today = new Date().toISOString().split('T')[0];
document.querySelectorAll('input[type="date"]').forEach(input => {
input.min = today;
});
}



async function loadBookings(forceRefresh = false) {
    // Check cache first
    if (!forceRefresh && cachedBookings && cacheTime &&
        (Date.now() - cacheTime < 5 * 60 * 1000)) {
        allBookings = cachedBookings;
        filteredBookings = allBookings;
        displayBookingsByCategory();
        updateStats();
        return;
    }
    
    showLoading(true);
    try {
        // Get all bookings without filter
        const snapshot = await db.collection('bookings')
            .orderBy('createdAt', 'desc')
            .get();
        
        allBookings = [];
        
        snapshot.forEach(doc => {
            const data = doc.data();
            const booking = {
                id: doc.id,
                ...data,
                // تأكد من وجود الحقول المطلوبة
                name: data.name || data.basicInfo?.name || 'غير محدد',
                email: data.email || data.basicInfo?.email || '',
                phone: data.phone || data.basicInfo?.phone || '',
                journeyType: data.journeyType || data.selectedJourney || '',
                createdAt: data.createdAt?.toDate ? data.createdAt.toDate() : new Date()
            };
            allBookings.push(booking);
        });
        
        // Cache the data
        cachedBookings = allBookings;
        cacheTime = Date.now();
        
        // Update stats
        updateStats();
        
        // Apply filters
        applyFilters();
        
        showNotification(`تم تحميل ${allBookings.length} حجز`, 'success');
    } catch (error) {
        console.error('Error loading bookings:', error);
        showNotification('خطأ في تحميل البيانات', 'error');
        
        // عرض رسالة خطأ واضحة في الجدول
        const tbody = document.getElementById('bookingsTableBody');
        if (tbody) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="8" style="text-align: center; padding: 50px;">
                        <div class="empty-state">
                            <div class="empty-state-icon">⚠️</div>
                            <h3>خطأ في تحميل البيانات</h3>
                            <p style="color: #666; margin: 10px 0;">تأكد من الاتصال بالإنترنت</p>
                            <button class="btn btn-primary" onclick="loadBookings(true)">
                                إعادة المحاولة
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        }
    } finally {
        showLoading(false);
    }
}

// Update stats
function updateStats() {
const stats = {
pending: 0,
confirming: 0,
confirmed: 0,
completed: 0,
converted: 0,
cancelled: 0
};
allBookings.forEach(booking => {
const status = booking.status || 'pending';
if (stats.hasOwnProperty(status)) {
stats[status]++;
}
});
document.getElementById('pendingCount').textContent = stats.pending;
document.getElementById('confirmingCount').textContent = stats.confirming;
document.getElementById('confirmedCount').textContent = stats.confirmed;
document.getElementById('completedCount').textContent = stats.completed + stats.converted;
}

// Apply filters
function applyFilters() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const journeyFilter = document.getElementById('journeyFilter').value;
    const challengeFilter = document.getElementById('challengeFilter').value;
    const statusFilter = document.getElementById('statusFilter').value;
    
    filteredBookings = allBookings.filter(booking => {
        // Search filter
        if (searchTerm) {
            const searchableText = [
                booking.name,
                booking.email,
                booking.phone,
                booking.message
            ].filter(Boolean).join(' ').toLowerCase();
            
            if (!searchableText.includes(searchTerm)) {
                return false;
            }
        }
        
        // Journey filter - تعديل للتعامل مع الحقول الجديدة
        if (journeyFilter) {
            const bookingJourney = booking.selectedJourney || booking.journeyType;
            if (journeyFilter === 'multi') {
                if (!bookingJourney || !bookingJourney.includes('-')) {
                    return false;
                }
            } else if (!bookingJourney || bookingJourney !== journeyFilter) {
                return false;
            }
        }
        
        // Challenge filter
        if (challengeFilter && booking.challengeType !== challengeFilter) {
            return false;
        }
        
        // Status filter
        if (statusFilter && (booking.status || 'pending') !== statusFilter) {
            return false;
        }
        
        return true;
    });
    
    displayBookingsByCategory();
}

// Display bookings by category
function displayBookingsByCategory() {
const tbody = document.getElementById('bookingsTableBody');
let html = '';
// Categorize filtered bookings
const newBookings = [];
const processingBookings = [];
const completedBookings = [];
const cancelledBookings = [];
filteredBookings.forEach(booking => {
switch(booking.status) {
case 'pending':
newBookings.push(booking);
break;
case 'confirming':
case 'confirmed':
processingBookings.push(booking);
break;
case 'completed':
case 'converted':
completedBookings.push(booking);
break;
case 'cancelled':
cancelledBookings.push(booking);
break;
default:
newBookings.push(booking);
}
});
// Sort by urgency level
newBookings.sort((a, b) => (b.urgencyLevel || 0) - (a.urgencyLevel || 0));
// Display new bookings first
if (newBookings.length > 0) {
html += `
<tr class="category-header">
<td colspan="8" style="background: #fff3cd; color: #856404; font-weight: bold; padding: 10px;">
طلبات جديدة (${newBookings.length})
</td>
</tr>
`;
newBookings.forEach(booking => {
html += generateBookingRow(booking);
});
}
// Display processing bookings
if (processingBookings.length > 0) {
html += `
<tr class="category-header">
<td colspan="8" style="background: #d1ecf1; color: #0c5460; font-weight: bold; padding: 10px;">
قيد المعالجة (${processingBookings.length})
</td>
</tr>
`;
processingBookings.forEach(booking => {
html += generateBookingRow(booking);
});
}
// Display completed bookings
if (completedBookings.length > 0) {
html += `
<tr class="category-header">
<td colspan="8" style="background: #d4edda; color: #155724; font-weight: bold; padding: 10px;">
مكتملة/محولة (${completedBookings.length})
</td>
</tr>
`;
completedBookings.forEach(booking => {
html += generateBookingRow(booking);
});
}
// Display cancelled bookings
if (cancelledBookings.length > 0) {
html += `
<tr class="category-header">
<td colspan="8" style="background: #f8d7da; color: #721c24; font-weight: bold; padding: 10px;">
ملغية (${cancelledBookings.length})
</td>
</tr>
`;
cancelledBookings.forEach(booking => {
html += generateBookingRow(booking);
});
}
if (html === '') {
html = `
<tr>
<td colspan="8" class="empty-state">
<div class="empty-state-icon">📭</div>
<p>لا توجد حجوزات</p>
</td>
</tr>
`;
}
tbody.innerHTML = html;
}

// Generate booking row
function generateBookingRow(booking) {
    const date = booking.createdAt;
    const journeyName = getJourneyDisplayName(booking.selectedJourney || booking.journeyType);
    const recommendedName = getJourneyDisplayName(booking.recommendedJourney);
    const isMatched = booking.matchedRecommendation;
    const urgencyClass = booking.urgencyLevel >= 8 ? 'urgent' : 
                        booking.urgencyLevel >= 5 ? 'moderate' : 'low';
    
    return `
        <tr>
            <td>${formatDate(date)}</td>
            <td>
                <div class="client-info">
                    <span class="client-name">${booking.name || 'غير محدد'}</span>
                    <span class="client-contact">${booking.email || ''}</span>
                    <span class="client-contact">${booking.phone || ''}</span>
                </div>
            </td>
            <td>
                <span class="type-badge ${getChallengeClass(booking.challengeType)}">
                    ${getChallengeDisplayName(booking.challengeType)}
                </span>
            </td>
            <td>
                <div class="journey-info">
                    <span class="journey-badge ${booking.selectedJourney || booking.journeyType || ''}">
                        ${journeyName}
                    </span>
                    ${booking.selectedJourney !== booking.recommendedJourney ? 
                        `<small class="recommended-note">
                            (موصى به: ${recommendedName})
                        </small>` : ''}
                </div>
            </td>
            <td>
                ${isMatched ? 
                    '<span class="match-icon yes">✓</span>' : 
                    '<span class="match-icon no">✗</span>'}
            </td>
            <td>
                <span class="urgency-level ${urgencyClass}">
                    ${booking.urgencyLevel || '-'}/10
                </span>
            </td>
            <td>
                <span class="status-badge ${booking.status || 'pending'}">
                    ${getStatusName(booking.status)}
                </span>
            </td>
            <td>
                <div class="actions-cell">
                    ${generateActions(booking)}
                </div>
            </td>
        </tr>
    `;
}

// Generate action buttons
function generateActions(booking) {
// تأكد من وجود booking.id
if (!booking || !booking.id) {
console.error('Booking ID is missing:', booking);
return '<span style="color: red;">خطأ في البيانات</span>';
}
// تأكد من وجود رقم الهاتف
const phone = booking.phone || '';
const name = booking.name || 'عميل';
let html = '';
// زر WhatsApp - مع التحقق من وجود الهاتف
if (phone) {
html += `<button class="btn btn-whatsapp" onclick="openWhatsApp('${phone}', '${name}')">واتساب</button>`;
} else {
html += `<button class="btn btn-whatsapp" disabled title="لا يوجد رقم هاتف">واتساب</button>`;
}
// زر الملاحظات
html += `<button class="btn btn-info" onclick="showNotes('${booking.id}')">ملاحظات</button>`;
// Send login credentials button for users with accounts
if (booking.accountCreated && booking.userId) {
html += `<button class="btn btn-success" onclick="sendLoginCredentials('${booking.id}')">إرسال بيانات الدخول</button>`;
}
// Status-specific actions
const status = booking.status || 'pending';
if (status === 'pending') {
html += `<button class="btn btn-primary" onclick="showAppointmentsModal('${booking.id}')">إرسال مواعيد</button>`;
} else if (status === 'confirming') {
html += `<button class="btn btn-success" onclick="showConfirmModal('${booking.id}')">تأكيد الموعد</button>`;
} else if (status === 'confirmed') {
html += `<button class="btn btn-warning" onclick="convertToJourney('${booking.id}')">تحويل لرحلة</button>`;
}
// زر إلغاء الحجز
if (status !== 'cancelled' && status !== 'completed' && status !== 'converted') {
html += `<button class="btn btn-danger btn-sm" onclick="cancelBooking('${booking.id}')">إلغاء</button>`;
}
// View details - always show
html += `<button class="btn btn-secondary" onclick="viewDetails('${booking.id}')">تفاصيل</button>`;
return html;
}



// Reset filters
function resetFilters() {
document.getElementById('searchInput').value = '';
document.getElementById('journeyFilter').value = '';
document.getElementById('challengeFilter').value = '';
document.getElementById('statusFilter').value = '';
applyFilters();
}

// Refresh data
function refreshData() {
loadBookings(true);
}

// Open WhatsApp
function openWhatsApp(phone, name, customMessage = null) {
// تأكد من وجود رقم الهاتف
if (!phone || phone === 'undefined' || phone === undefined) {
console.error('Phone number is missing:', phone);
alert('رقم الهاتف غير موجود');
return;
}
// تنظيف رقم الهاتف
const phoneStr = String(phone);
const cleanPhone = phoneStr.replace(/\D/g, '');
if (!cleanPhone) {
alert('رقم الهاتف غير صحيح');
return;
}
const fullPhone = cleanPhone.startsWith('2') ? cleanPhone : '2' + cleanPhone;
// استخدم الرسالة المخصصة إذا كانت موجودة، وإلا استخدم الرسالة الافتراضية
const message = customMessage || `مرحباً ${name || 'عميلنا العزيز'}، معك محمود فؤاد...`;
const whatsappUrl = `https://wa.me/${fullPhone}?text=${encodeURIComponent(message)}`;
window.open(whatsappUrl, '_blank');
}

// Show notes modal
async function showNotes(bookingId) {
currentBookingId = bookingId;
const booking = allBookings.find(b => b.id === bookingId);
if (!booking) return;
// Update info box
document.getElementById('bookingInfoBox').innerHTML = `
<h4>معلومات الحجز:</h4>
<p><strong>الاسم:</strong> ${booking.name || 'غير محدد'}</p>
<p><strong>البرنامج:</strong> ${getJourneyDisplayName(booking.journeyType)}</p>
<p><strong>التاريخ:</strong> ${formatDate(booking.createdAt)}</p>
`;
// Load existing notes
document.getElementById('notesTextarea').value = booking.notes || '';
openModal('notesModal');
}

// Save notes
async function saveNotes() {
const notes = document.getElementById('notesTextarea').value;
if (!currentBookingId) return;
showLoading(true);
try {
await db.collection('bookings').doc(currentBookingId).update({
notes: notes,
notesUpdatedAt: firebase.firestore.FieldValue.serverTimestamp()
});
showNotification('تم حفظ الملاحظات بنجاح', 'success');
closeModal('notesModal');
loadBookings(true);
} catch (error) {
console.error('Error saving notes:', error);
showNotification('خطأ في حفظ الملاحظات', 'error');
} finally {
showLoading(false);
}
}

// Send login credentials
function sendLoginCredentials(bookingId) {
const booking = allBookings.find(b => b.id === bookingId);
if (!booking) return;
if (!booking.accountCreated) {
showNotification('لم يتم إنشاء حساب لهذا العميل بعد', 'error');
return;
}
let message = `مرحباً ${booking.name}!\n\n`;
message += `تم تفعيل حسابك بنجاح! 🎉\n\n`;
message += `بيانات الدخول لمساحتك الخاصة:\n`;
message += `البريد: ${booking.email}\n`;
if (booking.authProvider === 'google') {
message += `تسجيل الدخول: باستخدام Google\n\n`;
} else if (booking.temporaryPassword) {
message += `كلمة المرور المؤقتة: ${booking.temporaryPassword}\n`;
message += `يُنصح بتغيير كلمة المرور بعد تسجيل الدخول\n\n`;
} else {
message += `كلمة المرور: التي قمت بإنشائها عند التسجيل\n\n`;
}
message += `رابط الدخول:\n`;
message += `https://mahmoudfouad25.github.io/portal.html\n\n`;
message += `نصيحة: احفظ هذه الرسالة للرجوع إليها\n`;
message += `إذا نسيت كلمة المرور، يمكنك استعادتها من صفحة تسجيل الدخول`;
// إرسال عبر WhatsApp
openWhatsApp(booking.phone, booking.name, message);
showNotification('تم فتح واتساب لإرسال بيانات الدخول', 'success');
}

// Slots Management Functions
function showSlotsManager() {
updateSlotsList();
document.getElementById('slotsModal').style.display = 'block';
}

function updateSlotsList() {
const list = document.getElementById('slotsList');
list.innerHTML = '';
if (availableSlots.length === 0) {
list.innerHTML = '<p style="color: #999; text-align: center;">لا توجد مواعيد محفوظة</p>';
} else {
availableSlots.forEach((slot, i) => {
list.innerHTML += `
<div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #f0f0f0; margin: 5px 0; border-radius: 5px;">
<span>${slot}</span>
<button class="btn btn-danger btn-sm" onclick="removeSlot(${i})">حذف</button>
</div>
`;
});
}
}

function addSlot() {
const date = document.getElementById('slotDate').value;
const time = document.getElementById('slotTime').value;
if (!date || !time) {
showNotification('من فضلك أدخل التاريخ والوقت', 'error');
return;
}
const dateObj = new Date(date);
const dateStr = dateObj.toLocaleDateString('ar-EG', {
weekday: 'long',
year: 'numeric',
month: 'long',
day: 'numeric'
});
const slotStr = `${dateStr} - ${time}`;
if (availableSlots.includes(slotStr)) {
showNotification('هذا الموعد موجود بالفعل', 'error');
return;
}
availableSlots.push(slotStr);
availableSlots.sort();
localStorage.setItem('availableSlots', JSON.stringify(availableSlots));
document.getElementById('slotDate').value = '';
document.getElementById('slotTime').value = '';
showNotification('تم إضافة الموعد بنجاح', 'success');
updateSlotsList();
}

function addBulkSlots() {
const startDate = document.getElementById('bulkStartDate').value;
const endDate = document.getElementById('bulkEndDate').value;
const times = Array.from(document.getElementById('bulkTimes').selectedOptions).map(o => o.value);
if (!startDate || !endDate || times.length === 0) {
showNotification('من فضلك أكمل جميع الحقول', 'error');
return;
}
const start = new Date(startDate);
const end = new Date(endDate);
let count = 0;
for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
const dateStr = new Date(d).toLocaleDateString('ar-EG', {
weekday: 'long',
year: 'numeric',
month: 'long',
day: 'numeric'
});
times.forEach(time => {
const slotStr = `${dateStr} - ${time}`;
if (!availableSlots.includes(slotStr)) {
availableSlots.push(slotStr);
count++;
}
});
}
availableSlots.sort();
localStorage.setItem('availableSlots', JSON.stringify(availableSlots));
showNotification(`تم إضافة ${count} موعد`, 'success');
updateSlotsList();
// Clear form
document.getElementById('bulkStartDate').value = '';
document.getElementById('bulkEndDate').value = '';
document.getElementById('bulkTimes').selectedIndex = -1;
}

function removeSlot(index) {
if (confirm('هل تريد حذف هذا الموعد؟')) {
availableSlots.splice(index, 1);
localStorage.setItem('availableSlots', JSON.stringify(availableSlots));
showNotification('تم حذف الموعد', 'success');
updateSlotsList();
}
}

// Show appointments modal
function showAppointmentsModal(bookingId) {
currentBookingId = bookingId;
const container = document.getElementById('slotsContainer');
// Display available slots
let html = '';
if (availableSlots.length === 0) {
html = '<p>لا توجد مواعيد متاحة. يرجى إضافة مواعيد من "إدارة المواعيد"</p>';
} else {
availableSlots.forEach((slot, index) => {
html += `
<div class="slot-item" onclick="toggleSlot(this, ${index})">
<input type="checkbox" id="slot_${index}" value="${index}">
<label for="slot_${index}">
${slot}
</label>
</div>
`;
});
}
container.innerHTML = html;
document.getElementById('customMessage').value = '';
openModal('appointmentsModal');
}

// Toggle slot selection
function toggleSlot(element, index) {
element.classList.toggle('selected');
const checkbox = element.querySelector('input[type="checkbox"]');
checkbox.checked = !checkbox.checked;
}

// Send appointments
async function sendAppointments() {
const selectedSlots = [];
document.querySelectorAll('#slotsContainer input[type="checkbox"]:checked').forEach(input => {
const index = parseInt(input.value);
selectedSlots.push(availableSlots[index]);
});
if (selectedSlots.length === 0) {
showNotification('من فضلك اختر موعد واحد على الأقل', 'error');
return;
}
if (selectedSlots.length > 5) {
showNotification('من فضلك اختر 5 مواعيد كحد أقصى', 'error');
return;
}
const booking = allBookings.find(b => b.id === currentBookingId);
if (!booking) return;
const customMessage = document.getElementById('customMessage').value;
// بناء رسالة WhatsApp
let message = `مرحباً ${booking.name}،\n\n`;
if (customMessage) {
message += customMessage + '\n\n';
}
message += 'المواعيد المتاحة لجلستك:\n\n';
selectedSlots.forEach((slot, index) => {
message += `${index + 1}. ${slot}\n`;
});
message += '\nمن فضلك اختر الموعد المناسب لك بالرقم.';
// إرسال الرسالة عبر WhatsApp
openWhatsApp(booking.phone, booking.name, message);
// تحديث حالة الحجز
try {
await db.collection('bookings').doc(currentBookingId).update({
status: 'confirming',
proposedSlots: selectedSlots,
lastContactAt: firebase.firestore.FieldValue.serverTimestamp()
});
showNotification('تم إرسال المواعيد بنجاح', 'success');
closeModal('appointmentsModal');
loadBookings(true);
} catch (error) {
console.error('Error updating booking:', error);
showNotification('خطأ في تحديث الحجز', 'error');
}
}

// Show confirm modal
function showConfirmModal(bookingId) {
currentBookingId = bookingId;
const booking = allBookings.find(b => b.id === bookingId);
if (!booking) return;
// Pre-fill if editing
if (booking.appointmentDate) {
const date = booking.appointmentDate.toDate ?
booking.appointmentDate.toDate() : new Date(booking.appointmentDate);
document.getElementById('appointmentDate').value = date.toISOString().split('T')[0];
}
document.getElementById('appointmentTime').value = booking.appointmentTime || '';
document.getElementById('sessionType').value = booking.sessionType || 'online';
document.getElementById('sessionLink').value = booking.sessionLink || '';
openModal('confirmModal');
}

// Confirm appointment
async function confirmAppointment() {
const date = document.getElementById('appointmentDate').value;
const time = document.getElementById('appointmentTime').value;
const sessionType = document.getElementById('sessionType').value;
const sessionLink = document.getElementById('sessionLink').value;
if (!date || !time) {
showNotification('من فضلك أدخل التاريخ والوقت', 'error');
return;
}
if (sessionType === 'online' && !sessionLink) {
showNotification('من فضلك أدخل رابط الجلسة للجلسات الأونلاين', 'error');
return;
}
showLoading(true);
try {
await db.collection('bookings').doc(currentBookingId).update({
status: 'confirmed',
appointmentDate: new Date(date),
appointmentTime: time,
sessionType: sessionType,
sessionLink: sessionLink,
confirmedAt: firebase.firestore.FieldValue.serverTimestamp()
});
// إعداد رسالة التأكيد
const booking = allBookings.find(b => b.id === currentBookingId);
if (booking) {
const dateObj = new Date(date);
const dateStr = dateObj.toLocaleDateString('ar-EG', {
weekday: 'long',
year: 'numeric',
month: 'long',
day: 'numeric'
});
let message = `تأكيد موعد جلستك\n\n`;
message += `التاريخ: ${dateStr}\n`;
message += `الوقت: ${time}\n`;
message += `نوع الجلسة: ${getSessionTypeName(sessionType)}\n`;
if (sessionType === 'online' && sessionLink) {
message += `رابط الجلسة: ${sessionLink}\n`;
}
message += '\nأراك في الموعد بإذن الله.';
// نسخ الرسالة
navigator.clipboard.writeText(message).then(() => {
showNotification('تم نسخ رسالة التأكيد', 'success');
});
// إرسال عبر WhatsApp
openWhatsApp(booking.phone, booking.name, message);
}
showNotification('تم تأكيد الموعد بنجاح', 'success');
closeModal('confirmModal');
loadBookings(true);
} catch (error) {
console.error('Error confirming appointment:', error);
showNotification('خطأ في تأكيد الموعد', 'error');
} finally {
showLoading(false);
}
}

// Convert to journey
async function convertToJourney(bookingId) {
const booking = allBookings.find(b => b.id === bookingId);
if (!booking) return;
// التعامل مع المسارات المزدوجة
let journeyType = booking.journeyType;
let isMultiPath = false;
if (journeyType === 'eshraq-baseera' || journeyType === 'baseera-sakeena') {
isMultiPath = true;
// للمسار المزدوج، نبدأ بالرحلة الأولى
journeyType = journeyType.split('-')[0];
}
try {
showLoading(true);
// التحقق من وجود رحلة نشطة للعميل
const existingJourney = await db.collection('journeys')
.where('clientEmail', '==', booking.email)
.where('status', '==', 'active')
.limit(1)
.get();
if (!existingJourney.empty) {
// العميل لديه رحلة نشطة
const journeyId = existingJourney.docs[0].id;
if (confirm(`${booking.name} لديه رحلة نشطة بالفعل. هل تريد إضافة هذه الجلسة للرحلة الموجودة؟`)) {
// إضافة الجلسة للرحلة الموجودة
await addSessionToJourney(journeyId, booking);
// فتح صفحة إدارة الرحلة
window.location.href = `admin-journey-management.html?clientId=${booking.userId}&journeyId=${journeyId}&bookingId=${booking.id}`;
}
} else {
// إنشاء رحلة جديدة
const newJourney = await createNewJourney(booking);
// إنشاء الجلسة الأولى مباشرة
await db.collection('sessions').add({
journeyId: newJourney.id,
sessionNumber: 1,
type: booking.sessionType,
status: 'scheduled',
scheduledDate: booking.appointmentDate,
scheduledTime: booking.appointmentTime || '10:00 AM',
duration: 90,
clientName: booking.name,
clientPhone: booking.phone,
phase: 1,
createdAt: firebase.firestore.FieldValue.serverTimestamp()
});
// فتح صفحة إدارة الرحلة الجديدة
window.location.href = `admin-journey-management.html?clientId=${booking.userId}&journeyId=${newJourney.id}&bookingId=${booking.id}`;
}
} catch (error) {
console.error('Error converting to journey:', error);
showNotification('خطأ في تحويل الحجز لرحلة', 'error');
} finally {
showLoading(false);
}
}

// Create new journey
async function createNewJourney(booking) {
// التعامل مع أنواع الرحلات
let journeyType = booking.journeyType;
let isMultiPath = false;
let nextJourneyType = null;
if (journeyType === 'eshraq-baseera' || journeyType === 'baseera-sakeena') {
isMultiPath = true;
const parts = journeyType.split('-');
journeyType = parts[0];
nextJourneyType = parts[1];
}
const journeyData = {
// معلومات العميل
clientName: booking.name,
clientEmail: booking.email,
clientPhone: booking.phone,
userId: booking.userId || booking.id,
clientId: booking.userId || booking.id,
// معلومات الرحلة
program: getJourneyDisplayName(booking.journeyType),
journeyType: journeyType,
fullJourneyPath: booking.journeyType, // المسار الكامل
isMultiPath: isMultiPath,
nextJourneyType: nextJourneyType,
// معلومات التحليل من الاستمارة
challengeType: booking.challengeType,
awarenessLevel: booking.awarenessLevel,
urgencyLevel: booking.urgencyLevel,
matchedRecommendation: booking.matchedRecommendation,
recommendedJourney: booking.recommendedJourney,
journeyJustification: booking.journeyJustification,
// البيانات الأساسية
status: 'active',
startDate: firebase.firestore.FieldValue.serverTimestamp(),
currentPhase: 1,
totalPhases: getProgramPhases(journeyType),
progress: 0,
completedSessions: 0,
totalSessions: getProgramSessions(journeyType),
// البيانات األولية
engagementScore: 80,
assignedTools: [],
practicesCompleted: 0,
practicesAssigned: 0,
// بيانات النشاط
lastActivityDate: firebase.firestore.FieldValue.serverTimestamp(),
// معلومات إضافية من الحجز
goals: booking.goals || booking.message || '',
challenges: booking.challenges || '',
notes: booking.notes || '',
// Metadata
lastUpdated: firebase.firestore.FieldValue.serverTimestamp(),
createdAt: firebase.firestore.FieldValue.serverTimestamp()
};
// إنشاء الرحلة
const journeyRef = await db.collection('journeys').add(journeyData);
// إنشاء المراحل
const phases = getDefaultPhases(journeyType);
const batch = db.batch();
phases.forEach((phase, index) => {
const phaseRef = journeyRef.collection('phases').doc();
batch.set(phaseRef, {
...phase,
order: index + 1,
status: index === 0 ? 'in_progress' : 'pending',
startDate: index === 0 ? firebase.firestore.FieldValue.serverTimestamp() : null
});
});
await batch.commit();
// إنشاء نشاط البداية
await db.collection('activities').add({
journeyId: journeyRef.id,
clientId: booking.userId,
clientName: booking.name,
type: 'milestone',
description: `بدأ ${booking.name} ${getJourneyDisplayName(booking.journeyType)}`,
timestamp: firebase.firestore.FieldValue.serverTimestamp()
});
// ربط الحجز بالرحلة
await db.collection('bookings').doc(booking.id).update({
status: 'converted',
journeyId: journeyRef.id,
convertedAt: firebase.firestore.FieldValue.serverTimestamp()
});
// تحديث بيانات المستخدم إن وجد
if (booking.userId) {
await db.collection('users').doc(booking.userId).update({
activeJourneyId: journeyRef.id,
currentProgram: getJourneyDisplayName(booking.journeyType),
journeyStartDate: firebase.firestore.FieldValue.serverTimestamp()
});
}
showNotification('تم إنشاء الرحلة بنجاح', 'success');
return {
id: journeyRef.id,
...journeyData
};
}

// Add session to existing journey
async function addSessionToJourney(journeyId, booking) {
// تحديث الحجز
await db.collection('bookings').doc(booking.id).update({
status: 'converted',
journeyId: journeyId,
convertedAt: firebase.firestore.FieldValue.serverTimestamp()
});
showNotification('تم إضافة الجلسة للرحلة الموجودة', 'success');
}

// Get program phases
function getProgramPhases(program) {
const phases = {
'eshraq': 1,
'baseera': 3,
'sakeena': 3
};
return phases[program] || 1;
}

// Get program sessions
function getProgramSessions(program) {
const sessions = {
'eshraq': 3,
'baseera': 12,
'sakeena': 24
};
return sessions[program] || 3;
}

// Get default phases
function getDefaultPhases(program) {
const phases = {
'eshraq': [
{ name: 'جلسة الإشراقة', description: 'جلسات مكثفة للوضوح والحلول العملية' }
],
'baseera': [
{ name: 'اكتشاف الذات', description: 'فهم الأنماط والقيم الأساسية' },
{ name: 'بناء الوعي', description: 'تحديد نقاط القوة والفرص' },
{ name: 'خطة العمل', description: 'رسم خارطة التغيير' }
],
'sakeena': [
{ name: 'الإنبات', description: 'كشف الجذور وبداية التحول' },
{ name: 'النمو', description: 'بناء الهوية الجديدة' },
{ name: 'الازدهار', description: 'دمج التغيير والاستدامة' }
]
};
return phases[program] || phases['eshraq'];
}

// Get session type name

// Cancel booking
async function cancelBooking(bookingId) {
const booking = allBookings.find(b => b.id === bookingId);
if (!booking) return;
const confirmCancel = confirm(`هل تريد إلغاء حجز ${booking.name}؟`);
if (!confirmCancel) return;
showLoading(true);
try {
await db.collection('bookings').doc(bookingId).update({
status: 'cancelled',
cancelledAt: firebase.firestore.FieldValue.serverTimestamp(),
cancelReason: prompt('سبب الإلغاء (اختياري):') || 'لم يحدد'
});
// إرسال رسالة للعميل
const message = `مرحباً ${booking.name},\n\nنأسف لإبلاغك أنه تم إلغاء حجزك لـ${getJourneyDisplayName(booking.journeyType)}.\n\nإذا كان لديك أي استفسار، لا تتردد في التواصل معنا.\n\nمع تحياتي،\nمحمود فؤاد`;
if (booking.phone) {
openWhatsApp(booking.phone, booking.name, message);
}
showNotification('تم إلغاء الحجز', 'success');
loadBookings(true);
} catch (error) {
console.error('Error cancelling booking:', error);
showNotification('خطأ في إلغاء الحجز', 'error');
} finally {
showLoading(false);
}
}

// View booking details
// استبدل دالة viewDetails بهذه النسخة الصحيحة
async function viewDetails(bookingId) {
    // تأكد من وجود bookingId
    if (!bookingId) {
        console.error('No booking ID provided');
        showNotification('خطأ: لا يوجد معرف للحجز', 'error');
        return;
    }
    
    // ابحث عن الحجز
    const booking = allBookings.find(b => b.id === bookingId);
    
    // تأكد من وجود الحجز
    if (!booking) {
        console.error('Booking not found:', bookingId);
        showNotification('خطأ: لم يتم العثور على الحجز', 'error');
        return;
    }
    
    let detailsHTML = `
        <div class="info-box">
            <h4>معلومات العميل:</h4>
            <p><strong>الاسم:</strong> ${booking.name || 'غير محدد'}</p>
            <p><strong>البريد الإلكتروني:</strong> ${booking.email || ''}</p>
            <p><strong>رقم الهاتف:</strong> ${booking.phone || 'غير محدد'}</p>
            <p><strong>العمر:</strong> ${booking.age || 'غير محدد'}</p>
            <p><strong>رقم الحجز:</strong> ${booking.bookingNumber || ''}</p>
            <p><strong>تاريخ الحجز:</strong> ${formatDate(booking.createdAt)}</p>
        </div>`;
    
    // تحليل الاحتياجات
    detailsHTML += `
        <div class="info-box">
            <h4>تحليل الاحتياجات:</h4>
            <p><strong>نوع التحدي:</strong> ${getChallengeDisplayName(booking.challengeType)}</p>
            <p><strong>مستوى الإلحاح:</strong> ${booking.urgencyLevel || '-'}/10</p>
            <p><strong>الوقت المتاح:</strong> ${booking.timeAvailable || 'غير محدد'}</p>
        </div>`;
    
    // اختيار الرحلة
    detailsHTML += `
        <div class="info-box">
            <h4>اختيار الرحلة:</h4>
            <p><strong>الرحلة المختارة:</strong> ${getJourneyDisplayName(booking.selectedJourney || booking.journeyType)}</p>
            <p><strong>الرحلة الموصى بها:</strong> ${getJourneyDisplayName(booking.recommendedJourney)}</p>
            <p><strong>تطابق مع التوصية:</strong> ${booking.matchedRecommendation ? 
                '<span style="color: green;">نعم ✓</span>' : 
                '<span style="color: orange;">لا - اختار مساراً مختلفاً</span>'}</p>
            ${booking.justificationForChoice ? 
                `<p><strong>تبرير الاختيار:</strong></p>
                <div style="background: #f5f5f5; padding: 10px; border-radius: 5px; margin-top: 5px;">
                    "${booking.justificationForChoice}"
                </div>` : ''}
        </div>`;
    
    // إجابات الاستمارة الرئيسية
    detailsHTML += `
        <div class="info-box" style="background: #e8f4f8; border-right: 4px solid #2C5530;">
            <h4>إجابات الأسئلة الأساسية:</h4>`;
    
    // النقطة الأساسية للألم
    if (booking.mainPainPoint) {
        detailsHTML += `
            <div style="margin: 15px 0; padding: 10px; background: white; border-radius: 5px;">
                <strong>أكثر ما يؤلمه في حياته:</strong>
                <p style="margin: 10px 20px; padding: 10px; background: #f9f9f9; border-right: 3px solid #2C5530; border-radius: 3px;">
                    "${booking.mainPainPoint}"
                </p>
            </div>`;
    }
    
    // الرؤية المستقبلية
    if (booking.futureVision) {
        detailsHTML += `
            <div style="margin: 15px 0; padding: 10px; background: white; border-radius: 5px;">
                <strong>رؤيته بعد عام من الآن:</strong>
                <p style="margin: 10px 20px; padding: 10px; background: #f9f9f9; border-right: 3px solid #8B9467; border-radius: 3px;">
                    "${booking.futureVision}"
                </p>
            </div>`;
    }
    
    // التقييمات الذاتية
    detailsHTML += `
        <div style="margin: 15px 0; padding: 15px; background: white; border-radius: 5px;">
            <strong>التقييمات الذاتية:</strong>
            <div style="display: grid; gap: 10px; margin-top: 10px;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span>إلحاح الحاجة للدعم:</span>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div style="width: 150px; height: 8px; background: #e0e0e0; border-radius: 4px; position: relative;">
                            <div style="width: ${(booking.urgencyLevel || 0) * 10}%; height: 100%; 
                                background: ${booking.urgencyLevel >= 7 ? '#dc3545' : booking.urgencyLevel >= 4 ? '#ffc107' : '#28a745'}; 
                                border-radius: 4px;"></div>
                        </div>
                        <strong>${booking.urgencyLevel || 0}/10</strong>
                    </div>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span>الاستعداد للاستثمار:</span>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div style="width: 150px; height: 8px; background: #e0e0e0; border-radius: 4px; position: relative;">
                            <div style="width: ${(parseInt(booking.investmentLevel) || 0) * 10}%; height: 100%; 
                                background: ${parseInt(booking.investmentLevel) >= 7 ? '#28a745' : parseInt(booking.investmentLevel) >= 4 ? '#ffc107' : '#dc3545'}; 
                                border-radius: 4px;"></div>
                        </div>
                        <strong>${booking.investmentLevel || 0}/10</strong>
                    </div>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span>الثقة في التغيير:</span>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div style="width: 150px; height: 8px; background: #e0e0e0; border-radius: 4px; position: relative;">
                            <div style="width: ${(parseInt(booking.confidenceLevel) || 0) * 10}%; height: 100%; 
                                background: ${parseInt(booking.confidenceLevel) >= 7 ? '#28a745' : parseInt(booking.confidenceLevel) >= 4 ? '#ffc107' : '#dc3545'}; 
                                border-radius: 4px;"></div>
                        </div>
                        <strong>${booking.confidenceLevel || 0}/10</strong>
                    </div>
                </div>
            </div>
        </div>`;
    
    // التجارب السابقة - مع التحقق من الوجود
    if (booking.previousExperience && Array.isArray(booking.previousExperience) && booking.previousExperience.length > 0) {
        detailsHTML += `
            <div style="margin: 15px 0; padding: 10px; background: white; border-radius: 5px;">
                <strong>التجارب السابقة:</strong>
                <p style="margin: 5px 0 0 20px; color: #333;">
                    ${booking.previousExperience.map(e => getExperienceText(e)).join('، ')}
                </p>
            </div>`;
    }
    
    // مصادر الدعم - مع التحقق من الوجود
    if (booking.supportSystems && Array.isArray(booking.supportSystems) && booking.supportSystems.length > 0) {
        detailsHTML += `
            <div style="margin: 15px 0; padding: 10px; background: white; border-radius: 5px;">
                <strong>مصادر الدعم في حياته:</strong>
                <p style="margin: 5px 0 0 20px; color: #333;">
                    ${booking.supportSystems.map(s => getSupportText(s)).join('، ')}
                </p>
            </div>`;
    }
    
    // معلومات إضافية
    if (booking.additionalInfo && booking.additionalInfo !== 'لا') {
        detailsHTML += `
            <div style="margin: 15px 0; padding: 10px; background: white; border-radius: 5px;">
                <strong>معلومات إضافية:</strong>
                <p style="margin: 10px 20px; padding: 10px; background: #f9f9f9; border-radius: 3px;">
                    "${booking.additionalInfo}"
                </p>
            </div>`;
    }
    
    detailsHTML += `</div>`;
    
    // معلومات الحساب
    if (booking.accountCreated) {
        detailsHTML += `
        <div class="info-box">
            <h4>معلومات الحساب:</h4>
            <p><strong>تم إنشاء حساب:</strong> نعم</p>
            <p><strong>طريقة التسجيل:</strong> ${booking.authProvider === 'google' ? 'Google' : 'البريد الإلكتروني'}</p>
            <p><strong>معرف المستخدم:</strong> ${booking.userId || ''}</p>
        </div>`;
    }
    
    // الملاحظات
    if (booking.notes) {
        detailsHTML += `
        <div class="info-box">
            <h4>الملاحظات:</h4>
            <p>${booking.notes}</p>
        </div>`;
    }
    
    // تفاصيل الموعد
    if (booking.status === 'confirmed' && booking.appointmentDate) {
        const date = booking.appointmentDate.toDate ?
            booking.appointmentDate.toDate() : new Date(booking.appointmentDate);
        detailsHTML += `
        <div class="info-box">
            <h4>تفاصيل الموعد:</h4>
            <p><strong>التاريخ:</strong> ${date.toLocaleDateString('ar-EG')}</p>
            <p><strong>الوقت:</strong> ${booking.appointmentTime || 'غير محدد'}</p>
            <p><strong>نوع الجلسة:</strong> ${getSessionTypeName(booking.sessionType)}</p>
            ${booking.sessionLink ? `<p><strong>رابط الجلسة:</strong> <a href="${booking.sessionLink}" target="_blank">${booking.sessionLink}</a></p>` : ''}
        </div>`;
    }
    
    // معلومات النظام
    detailsHTML += `
    <div class="info-box">
        <h4>معلومات النظام:</h4>
        <p><strong>رقم الحجز:</strong> ${booking.bookingNumber || ''}</p>
        <p><strong>معرف التقييم:</strong> ${booking.assessmentId || ''}</p>
        <p><strong>المصدر:</strong> ${booking.source || ''}</p>
        <p><strong>الحالة:</strong> <span class="status-badge ${booking.status || 'pending'}">${getStatusName(booking.status)}</span></p>
    </div>`;
    
    // الإجراءات السريعة
    detailsHTML += `
    <div class="info-box">
        <h4>إجراءات سريعة:</h4>
        <div class="actions-cell" style="margin-top: 10px;">
            ${generateActions(booking)}
        </div>
    </div>`;
    
    document.getElementById('bookingDetailsContent').innerHTML = detailsHTML;
    openModal('detailsModal');
}


// تحديث دالة getChallengeDisplayName لتشمل القيم الجديدة
function getChallengeDisplayName(challengeType) {
    const types = {
        'work': 'تحدي في العمل',
        'relationships': 'تحدي في العلاقات',
        'self': 'تحدي مع الذات',
        'decision': 'اتخاذ قرار مهم',
        'emptiness': 'شعور بالفراغ',
        'patterns': 'أنماط متكررة',
        'passion': 'فقدان الشغف',
        'misplaced': 'عدم الانتماء',
        'clear-vision': 'رؤية واضحة تحتاج تنفيذ',
        'need-change': 'حاجة لتغيير جذري',
        'awakening': 'يقظة روحية',
        'enough': 'وصول لنقطة التحول'
    };
    return types[challengeType] || challengeType || 'غير محدد';
}


// Export to Excel
function exportToExcel() {
let csv = '\ufeff'; // UTF-8 BOM
// Headers
const headers = [
'التاريخ',
'الاسم',
'البريد الإلكتروني',
'الهاتف',
'نوع التحدي',
'الرحلة المختارة',
'الرحلة الموصى بها',
'التطابق',
'مستوى الإلحاح',
'الحالة',
'الملاحظات'
];
csv += headers.join(',') + '\n';
// Data
filteredBookings.forEach(booking => {
const row = [
formatDate(booking.createdAt),
booking.name || 'غير محدد',
booking.email,
booking.phone,
getChallengeDisplayName(booking.challengeType),
getJourneyDisplayName(booking.journeyType),
getJourneyDisplayName(booking.recommendedJourney),
booking.matchedRecommendation ? 'نعم' : 'لا',
booking.urgencyLevel || '-',
getStatusName(booking.status),
(booking.notes || '').replace(/,/g, ';').replace(/\n/g, ' ')
];
csv += row.map(cell => `"${cell}"`).join(',') + '\n';
});
// Download
const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
const link = document.createElement('a');
const url = URL.createObjectURL(blob);
link.setAttribute('href', url);
link.setAttribute('download', `حجوزات_${new Date().toLocaleDateString('en-GB').replace(/\//g, '-')}.csv`);
link.style.visibility = 'hidden';
document.body.appendChild(link);
link.click();
document.body.removeChild(link);
showNotification('تم تحميل الملف بنجاح', 'success');
}



</script>
</body>
</html>
