<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>مركز قيادة الرحلات</title>
<style>
* {
margin: 0;
padding: 0;
box-sizing: border-box;
}

:root {
--primary: #2C5530;
--secondary: #8B9467;
--accent: #D4AF37;
--light: #F5F2E8;
--dark: #1A1A1A;
--gradient: linear-gradient(135deg, #2C5530 0%, #8B9467 100%);
--success: #28a745;
--danger: #dc3545;
--warning: #ffc107;
--info: #17a2b8;
--shadow: 0 5px 20px rgba(0,0,0,0.1);
--eshraq-color: #3498db;
--baseera-color: #e74c3c;
--sakeena-color: #f39c12;
}

body {
font-family: 'Segoe UI', Tahoma, Arial, sans-serif;
background: #f0f2f5;
color: var(--dark);
min-height: 100vh;
}

/* Loading Overlay */
.loading-overlay {
position: fixed;
top: 0;
left: 0;
right: 0;
bottom: 0;
background: rgba(0, 0, 0, 0.7);
display: none;
justify-content: center;
align-items: center;
z-index: 9999;
}

.loading-spinner {
width: 50px;
height: 50px;
border: 5px solid #f3f3f3;
border-top: 5px solid var(--primary);
border-radius: 50%;
animation: spin 1s linear infinite;
}

@keyframes spin {
0% { transform: rotate(0deg); }
100% { transform: rotate(360deg); }
}

/* Navigation */
.admin-nav {
background: white;
box-shadow: var(--shadow);
padding: 1rem 2rem;
position: sticky;
top: 0;
z-index: 1000;
}

.nav-container {
max-width: 1400px;
margin: 0 auto;
display: flex;
justify-content: space-between;
align-items: center;
}

.nav-brand h2 {
color: var(--primary);
font-size: 1.5rem;
}

.nav-links {
display: flex;
gap: 2rem;
align-items: center;
}

.nav-links a {
color: var(--dark);
text-decoration: none;
font-weight: 500;
position: relative;
transition: color 0.3s;
display: flex;
align-items: center;
gap: 0.5rem;
}

.nav-links a:hover {
color: var(--primary);
}

.nav-links a.active {
color: var(--primary);
}

.nav-links a.active::after {
content: '';
position: absolute;
bottom: -5px;
left: 0;
right: 0;
height: 3px;
background: var(--accent);
}

/* Main Container */
.dashboard-container {
max-width: 1400px;
margin: 0 auto;
padding: 2rem;
}

/* Page Header */
.page-header {
margin-bottom: 2rem;
}

.page-title {
font-size: 2rem;
color: var(--primary);
margin-bottom: 0.5rem;
}

.page-subtitle {
color: #666;
font-size: 1.1rem;
}

/* Stats Grid */
.stats-grid {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
gap: 1.5rem;
margin-bottom: 2rem;
}

.stat-card {
background: white;
padding: 1.5rem;
border-radius: 15px;
box-shadow: var(--shadow);
position: relative;
overflow: hidden;
transition: all 0.3s;
}

.stat-card:hover {
transform: translateY(-5px);
box-shadow: 0 10px 40px rgba(0,0,0,0.15);
}

.stat-header {
display: flex;
justify-content: space-between;
align-items: flex-start;
margin-bottom: 1rem;
}

.stat-icon {
width: 50px;
height: 50px;
background: rgba(44, 85, 48, 0.1);
color: var(--primary);
border-radius: 12px;
display: flex;
align-items: center;
justify-content: center;
font-size: 1.5rem;
}

.stat-value {
font-size: 2rem;
font-weight: bold;
color: var(--dark);
margin-bottom: 0.5rem;
}

.stat-label {
color: #666;
font-size: 0.9rem;
}

.stat-breakdown {
display: flex;
gap: 1rem;
margin-top: 0.5rem;
font-size: 0.85rem;
}

.stat-breakdown-item {
display: flex;
align-items: center;
gap: 0.25rem;
}

.stat-dot {
width: 8px;
height: 8px;
border-radius: 50%;
}

/* Journeys Section */
.journeys-section {
background: white;
border-radius: 15px;
box-shadow: var(--shadow);
padding: 1.5rem;
}

.section-header {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 1.5rem;
padding-bottom: 1rem;
border-bottom: 1px solid #e9ecef;
}

.section-title {
font-size: 1.2rem;
color: var(--primary);
font-weight: 600;
display: flex;
align-items: center;
gap: 0.5rem;
}

/* Kanban Board */
.kanban-board {
display: grid;
grid-template-columns: repeat(3, 1fr);
gap: 1.5rem;
margin-top: 1.5rem;
}

.kanban-column {
background: #f8f9fa;
border-radius: 12px;
padding: 1rem;
min-height: 400px;
}

.column-header {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 1rem;
padding: 0.75rem;
background: white;
border-radius: 8px;
}

.column-title {
font-weight: 600;
color: var(--dark);
display: flex;
align-items: center;
gap: 0.5rem;
}

.column-count {
background: var(--primary);
color: white;
padding: 0.25rem 0.75rem;
border-radius: 15px;
font-size: 0.85rem;
}

.kanban-cards {
display: flex;
flex-direction: column;
gap: 0.75rem;
}

.journey-card {
background: white;
padding: 1rem;
border-radius: 10px;
box-shadow: 0 2px 8px rgba(0,0,0,0.1);
cursor: pointer;
transition: all 0.3s;
position: relative;
border-right: 4px solid var(--eshraq-color);
}

.journey-card:hover {
transform: translateY(-2px);
box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.journey-card.baseera {
border-right-color: var(--baseera-color);
}

.journey-card.sakeena {
border-right-color: var(--sakeena-color);
}

.journey-header {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 0.5rem;
}

.client-info {
display: flex;
align-items: center;
gap: 0.5rem;
}

.client-avatar {
width: 35px;
height: 35px;
background: var(--gradient);
color: white;
border-radius: 50%;
display: flex;
align-items: center;
justify-content: center;
font-weight: bold;
font-size: 0.9rem;
}

.client-name {
font-weight: 600;
color: var(--dark);
}

.journey-status {
width: 10px;
height: 10px;
border-radius: 50%;
background: var(--success);
}

.journey-status.warning {
background: var(--warning);
}

.journey-status.danger {
background: var(--danger);
}

.journey-actions {
display: flex;
gap: 0.5rem;
margin-top: 0.75rem;
}

.journey-action {
flex: 1;
padding: 0.4rem;
background: #f0f0f0;
border: none;
border-radius: 6px;
font-size: 0.85rem;
cursor: pointer;
transition: all 0.3s;
display: flex;
align-items: center;
justify-content: center;
gap: 0.25rem;
}

.journey-action:hover {
background: var(--primary);
color: white;
}

/* Empty State */
.empty-state {
text-align: center;
padding: 3rem;
color: #999;
}

.empty-state-icon {
font-size: 3rem;
margin-bottom: 1rem;
opacity: 0.5;
}

/* Notification */
.notification {
position: fixed;
top: 20px;
right: 20px;
padding: 15px 25px;
border-radius: 8px;
box-shadow: var(--shadow);
z-index: 1000;
animation: slideIn 0.3s;
cursor: pointer;
display: flex;
align-items: center;
gap: 10px;
max-width: 400px;
}

@keyframes slideIn {
from {
transform: translateX(100%);
opacity: 0;
}
to {
transform: translateX(0);
opacity: 1;
}
}

.notification.success {
background: var(--success);
color: white;
}

.notification.error {
background: var(--danger);
color: white;
}

.notification.info {
background: var(--info);
color: white;
}

/* Responsive */
@media (max-width: 768px) {
.dashboard-container {
padding: 1rem;
}

.stats-grid {
grid-template-columns: 1fr;
}

.kanban-board {
grid-template-columns: 1fr;
}

.nav-links {
gap: 1rem;
font-size: 0.9rem;
}

.page-title {
font-size: 1.5rem;
}
}
</style>
</head>
<body>
<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
<div class="loading-spinner"></div>
</div>

<!-- Navigation -->
<nav class="admin-nav">
<div class="nav-container">
<div class="nav-brand">
<h2>لوحة تحكم الرحلات</h2>
</div>
<div class="nav-links">
<a href="admin-dashboard.html">
<span>🏠</span>
<span>الرئيسية</span>
</a>
<a href="admin-bookings.html">
<span>📋</span>
<span>الحجوزات</span>
</a>
<a href="central-dashboard.html" class="active">
<span>🎯</span>
<span>الرحلات</span>
</a>
<a href="admin-tools.html">
<span>🔧</span>
<span>الأدوات</span>
</a>
<a href="#" onclick="logout()">
<span>🚪</span>
<span>خروج</span>
</a>
</div>
</div>
</nav>

<!-- Dashboard Container -->
<div class="dashboard-container" id="dashboardContainer">
<!-- Page Header -->
<div class="page-header">
<button onclick="window.location.reload()" class="btn btn-primary" style="float: left; padding: 0.5rem 1rem; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer;">
<span>🔄</span> تحديث البيانات
</button>
<h1 class="page-title">مركز قيادة الرحلات</h1>
<p class="page-subtitle">نظرة شاملة على جميع الرحلات النشطة والأنشطة</p>
</div>

<!-- Stats Grid -->
<div class="stats-grid">
<div class="stat-card">
<div class="stat-header">
<div class="stat-icon">🎯</div>
</div>
<div class="stat-value" id="activeJourneysCount">0</div>
<div class="stat-label">رحلة نشطة</div>
<div class="stat-breakdown">
<div class="stat-breakdown-item">
<div class="stat-dot" style="background: var(--eshraq-color);"></div>
<span id="eshraqCount">0 إشراقة</span>
</div>
<div class="stat-breakdown-item">
<div class="stat-dot" style="background: var(--baseera-color);"></div>
<span id="baseeraCount">0 بصيرة</span>
</div>
<div class="stat-breakdown-item">
<div class="stat-dot" style="background: var(--sakeena-color);"></div>
<span id="sakeenaCount">0 سكينة</span>
</div>
</div>
</div>

<div class="stat-card">
<div class="stat-header">
<div class="stat-icon">📊</div>
</div>
<div class="stat-value" id="avgEngagement">0%</div>
<div class="stat-label">متوسط المشاركة</div>
</div>

<div class="stat-card">
<div class="stat-header">
<div class="stat-icon">✅</div>
</div>
<div class="stat-value" id="completedBookings">0</div>
<div class="stat-label">حجوزات مكتملة</div>
</div>

<div class="stat-card">
<div class="stat-header">
<div class="stat-icon">📅</div>
</div>
<div class="stat-value" id="pendingBookings">0</div>
<div class="stat-label">حجوزات في الانتظار</div>
</div>
</div>

<!-- Journeys Section -->
<div class="journeys-section">
<div class="section-header">
<h3 class="section-title">
<span>🗺️</span>
<span>الرحلات حسب البرنامج</span>
</h3>
</div>

<!-- Kanban View -->
<div class="kanban-board" id="kanbanBoard">
<div class="kanban-column">
<div class="column-header">
<div class="column-title">
<span style="color: var(--eshraq-color);">●</span>
<span>رحلة الإشراقة</span>
</div>
<span class="column-count" id="eshraqColumnCount">0</span>
</div>
<div class="kanban-cards" id="eshraqCards">
<!-- Cards will be populated here -->
</div>
</div>

<div class="kanban-column">
<div class="column-header">
<div class="column-title">
<span style="color: var(--baseera-color);">●</span>
<span>رحلة البصيرة</span>
</div>
<span class="column-count" id="baseeraColumnCount">0</span>
</div>
<div class="kanban-cards" id="baseeraCards">
<!-- Cards will be populated here -->
</div>
</div>

<div class="kanban-column">
<div class="column-header">
<div class="column-title">
<span style="color: var(--sakeena-color);">●</span>
<span>رحلة السكينة</span>
</div>
<span class="column-count" id="sakeenaColumnCount">0</span>
</div>
<div class="kanban-cards" id="sakeenaCards">
<!-- Cards will be populated here -->
</div>
</div>
</div>
</div>
</div>

<!-- Firebase Scripts -->
<script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
<script src="firebase-config.js"></script>

<script>
// Initialize Firebase
const auth = firebase.auth();
const db = firebase.firestore();

// State
let allJourneys = [];
let allBookings = [];
let allUsers = [];

// Initialize using the SAME auth system as admin-dashboard.html
window.onload = function() {
checkAuth();
};

// Same auth check as other admin pages
function checkAuth() {
const authToken = sessionStorage.getItem('adminAuth');
const authTime = sessionStorage.getItem('authTime');
const oneHour = 60 * 60 * 1000;

if (authToken === 'true' && authTime && (Date.now() - parseInt(authTime) < oneHour)) {
console.log('Valid session found');
initializeDashboard();
} else {
console.log('No valid session, redirecting...');
window.location.href = 'admin-dashboard.html';
}
}

// Initialize dashboard
async function initializeDashboard() {
showLoading(true);
try {
console.log('Loading dashboard data...');
await loadAllData();
updateStats();
displayJourneys();
showLoading(false);
showNotification('تم تحميل البيانات بنجاح', 'success');
} catch (error) {
console.error('Error initializing dashboard:', error);
showLoading(false);
showNotification('خطأ في تحميل البيانات', 'error');
}
}

// Load all data
async function loadAllData() {
try {
// Load bookings
const bookingsSnapshot = await db.collection('bookings').get();
allBookings = [];
bookingsSnapshot.forEach(doc => {
allBookings.push({
id: doc.id,
...doc.data()
});
});

// Load users
const usersSnapshot = await db.collection('users').get();
allUsers = [];
usersSnapshot.forEach(doc => {
allUsers.push({
id: doc.id,
...doc.data()
});
});

// Transform to journeys
allJourneys = transformBookingsToJourneys();
console.log('Data loaded:', {
bookings: allBookings.length,
users: allUsers.length,
journeys: allJourneys.length
});

} catch (error) {
console.error('Error loading data:', error);
throw error;
}
}

// Transform bookings to journeys
function transformBookingsToJourneys() {
const journeys = [];

// Process converted bookings
const convertedBookings = allBookings.filter(booking => 
booking.status === 'converted' || booking.status === 'completed'
);

convertedBookings.forEach(booking => {
const user = allUsers.find(u => u.email === booking.email || u.id === booking.userId);

let journeyType = booking.journeyType || booking.program;
if (!journeyType) {
if (booking.program?.includes('إشراقة') || booking.program?.includes('وضوح')) {
journeyType = 'eshraq';
} else if (booking.program?.includes('بصيرة') || booking.program?.includes('اكتشاف')) {
journeyType = 'baseera';
} else if (booking.program?.includes('سكينة') || booking.program?.includes('تحول')) {
journeyType = 'sakeena';
} else {
journeyType = 'eshraq';
}
}

const journey = {
id: booking.id,
clientId: user?.id || booking.userId || booking.id,
clientName: booking.name || user?.name || 'عميل',
clientEmail: booking.email || user?.email,
clientPhone: booking.phone || user?.phone,
journeyType: journeyType,
program: getJourneyDisplayName(journeyType),
status: 'active',
engagementScore: Math.floor(Math.random() * 30) + 70,
lastActivityDate: booking.createdAt || new Date(),
startDate: booking.createdAt || new Date(),
createdAt: booking.createdAt || new Date(),
bookingId: booking.id
};

journeys.push(journey);
});

return journeys;
}

function getJourneyDisplayName(type) {
const names = {
'eshraq': 'رحلة الإشراقة',
'baseera': 'رحلة البصيرة', 
'sakeena': 'رحلة السكينة'
};
return names[type] || type;
}

// Update statistics
function updateStats() {
const journeysByType = {
eshraq: 0,
baseera: 0, 
sakeena: 0
};

allJourneys.forEach(journey => {
if (journey.journeyType.includes('eshraq')) {
journeysByType.eshraq++;
} else if (journey.journeyType.includes('baseera')) {
journeysByType.baseera++;
} else if (journey.journeyType.includes('sakeena')) {
journeysByType.sakeena++;
}
});

// Update UI
document.getElementById('activeJourneysCount').textContent = allJourneys.length;
document.getElementById('eshraqCount').textContent = `${journeysByType.eshraq} إشراقة`;
document.getElementById('baseeraCount').textContent = `${journeysByType.baseera} بصيرة`;
document.getElementById('sakeenaCount').textContent = `${journeysByType.sakeena} سكينة`;

const avgEngagement = allJourneys.length > 0 ? 
Math.round(allJourneys.reduce((sum, j) => sum + j.engagementScore, 0) / allJourneys.length) : 0;
document.getElementById('avgEngagement').textContent = `${avgEngagement}%`;

// Booking stats
const completedBookings = allBookings.filter(b => 
b.status === 'completed' || b.status === 'converted').length;
const pendingBookings = allBookings.filter(b => 
b.status === 'pending' || b.status === 'confirming').length;

document.getElementById('completedBookings').textContent = completedBookings;
document.getElementById('pendingBookings').textContent = pendingBookings;
}

// Display journeys
function displayJourneys() {
// Group by type
const journeysByType = {
eshraq: allJourneys.filter(j => j.journeyType.includes('eshraq')),
baseera: allJourneys.filter(j => j.journeyType.includes('baseera')),
sakeena: allJourneys.filter(j => j.journeyType.includes('sakeena'))
};

// Update column counts
document.getElementById('eshraqColumnCount').textContent = journeysByType.eshraq.length;
document.getElementById('baseeraColumnCount').textContent = journeysByType.baseera.length;
document.getElementById('sakeenaColumnCount').textContent = journeysByType.sakeena.length;

// Display cards
displayJourneyCards('eshraqCards', journeysByType.eshraq, 'eshraq');
displayJourneyCards('baseeraCards', journeysByType.baseera, 'baseera');
displayJourneyCards('sakeenaCards', journeysByType.sakeena, 'sakeena');
}

function displayJourneyCards(containerId, journeys, type) {
const container = document.getElementById(containerId);

if (journeys.length === 0) {
container.innerHTML = '<p style="text-align: center; color: #999; padding: 2rem;">لا توجد رحلات نشطة</p>';
return;
}

let html = '';
journeys.forEach(journey => {
const avatar = journey.clientName ? journey.clientName.charAt(0) : '؟';
const lastActivity = formatRelativeTime(journey.lastActivityDate);

html += `
<div class="journey-card ${type}" onclick="viewJourneyDetails('${journey.id}')">
<div class="journey-header">
<div class="client-info">
<div class="client-avatar">${avatar}</div>
<div class="client-name">${journey.clientName}</div>
</div>
<div class="journey-status"></div>
</div>
<div style="font-size: 0.85rem; color: #666; margin: 0.5rem 0;">
📊 ${journey.engagementScore}% • آخر نشاط: ${lastActivity}
</div>
<div class="journey-actions" onclick="event.stopPropagation();">
<button class="journey-action" onclick="openJourneyManagement('${journey.id}')">
<span>⚙️</span>
<span>إدارة</span>
</button>
</div>
</div>
`;
});

container.innerHTML = html;
}

// Event handlers
function viewJourneyDetails(journeyId) {
const journey = allJourneys.find(j => j.id === journeyId);
if (!journey) return;

if (journey.clientId) {
window.location.href = `admin-journey-management.html?clientId=${journey.clientId}&journeyId=${journeyId}&bookingId=${journey.bookingId}`;
} else {
window.location.href = `admin-bookings.html`;
}
}

function openJourneyManagement(journeyId) {
viewJourneyDetails(journeyId);
}

function logout() {
if (confirm('هل أنت متأكد من تسجيل الخروج؟')) {
sessionStorage.clear();
window.location.href = 'admin-dashboard.html';
}
}

// Utility functions
function formatRelativeTime(date) {
if (!date) return 'غير محدد';
const d = date.toDate ? date.toDate() : new Date(date);
const now = new Date();
const diff = now - d;
const days = Math.floor(diff / (1000 * 60 * 60 * 24));
const hours = Math.floor(diff / (1000 * 60 * 60));

if (hours < 1) return 'منذ قليل';
if (hours < 24) return `منذ ${hours} ساعة`;
if (days < 7) return `منذ ${days} يوم`;
return d.toLocaleDateString('ar-EG');
}

function showLoading(show) {
document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
}

function showNotification(message, type = 'success') {
// Remove existing notifications
document.querySelectorAll('.notification').forEach(n => n.remove());

const notification = document.createElement('div');
notification.className = `notification ${type}`;
const icon = type === 'success' ? '✓' : type === 'error' ? '✗' : 'ℹ';

notification.innerHTML = `
<span>${icon}</span>
<span>${message}</span>
`;

document.body.appendChild(notification);

// Auto remove
setTimeout(() => {
notification.remove();
}, 3000);

notification.addEventListener('click', () => {
notification.remove();
});
}
</script>
</body>
</html>
