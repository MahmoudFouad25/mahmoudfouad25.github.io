<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ù…Ø±ÙƒØ² Ù‚ÙŠØ§Ø¯Ø© Ø§Ù„Ø±Ø­Ù„Ø§Øª - Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</title>
<style>
* {
margin: 0;
padding: 0;
box-sizing: border-box;
}

:root {
--primary: #2C5530;
--secondary: #8B9467;
--accent: #D4AF37;
--light: #F5F2E8;
--dark: #1A1A1A;
--gradient: linear-gradient(135deg, #2C5530 0%, #8B9467 100%);
--success: #28a745;
--danger: #dc3545;
--warning: #ffc107;
--info: #17a2b8;
--shadow: 0 5px 20px rgba(0,0,0,0.1);
--shadow-lg: 0 10px 40px rgba(0,0,0,0.15);
--eshraq-color: #3498db;
--baseera-color: #e74c3c;
--sakeena-color: #f39c12;
}

body {
font-family: 'Segoe UI', Tahoma, Arial, sans-serif;
background: #f0f2f5;
color: var(--dark);
min-height: 100vh;
}

/* Loading Overlay */
.loading-overlay {
position: fixed;
top: 0;
left: 0;
right: 0;
bottom: 0;
background: rgba(0, 0, 0, 0.7);
display: flex;
justify-content: center;
align-items: center;
z-index: 9999;
opacity: 0;
visibility: hidden;
transition: all 0.3s;
}

.loading-overlay.show {
opacity: 1;
visibility: visible;
}

.loading-spinner {
width: 50px;
height: 50px;
border: 5px solid #f3f3f3;
border-top: 5px solid var(--primary);
border-radius: 50%;
animation: spin 1s linear infinite;
}

@keyframes spin {
0% { transform: rotate(0deg); }
100% { transform: rotate(360deg); }
}

/* Auth Check Screen */
.auth-check {
display: none;
justify-content: center;
align-items: center;
min-height: 100vh;
background: var(--gradient);
}

.auth-message {
background: white;
padding: 3rem;
border-radius: 15px;
box-shadow: 0 10px 40px rgba(0,0,0,0.2);
text-align: center;
max-width: 500px;
}

.auth-message h2 {
color: var(--primary);
margin-bottom: 1rem;
}

.auth-message p {
color: #666;
margin-bottom: 2rem;
}

.auth-message button {
padding: 1rem 2rem;
background: var(--gradient);
color: white;
border: none;
border-radius: 8px;
font-size: 1rem;
font-weight: bold;
cursor: pointer;
}

/* Navigation */
.admin-nav {
background: white;
box-shadow: var(--shadow);
padding: 1rem 2rem;
position: sticky;
top: 0;
z-index: 1000;
}

.nav-container {
max-width: 1400px;
margin: 0 auto;
display: flex;
justify-content: space-between;
align-items: center;
}

.nav-brand h2 {
color: var(--primary);
font-size: 1.5rem;
}

.nav-links {
display: flex;
gap: 2rem;
align-items: center;
}

.nav-links a {
color: var(--dark);
text-decoration: none;
font-weight: 500;
position: relative;
transition: color 0.3s;
display: flex;
align-items: center;
gap: 0.5rem;
}

.nav-links a:hover {
color: var(--primary);
}

.nav-links a.active {
color: var(--primary);
}

.nav-links a.active::after {
content: '';
position: absolute;
bottom: -5px;
left: 0;
right: 0;
height: 3px;
background: var(--accent);
}

/* Main Container */
.dashboard-container {
max-width: 1400px;
margin: 0 auto;
padding: 2rem;
display: none;
}

.dashboard-container.show {
display: block;
}

/* Page Header */
.page-header {
margin-bottom: 2rem;
}

.page-title {
font-size: 2rem;
color: var(--primary);
margin-bottom: 0.5rem;
}

.page-subtitle {
color: #666;
font-size: 1.1rem;
}

/* Date Range Selector */
.date-range {
display: flex;
align-items: center;
gap: 1rem;
background: white;
padding: 0.75rem 1.5rem;
border-radius: 10px;
box-shadow: var(--shadow);
width: fit-content;
margin-top: 1rem;
}

.date-range select {
padding: 0.5rem 1rem;
border: 1px solid #e0e0e0;
border-radius: 6px;
font-size: 0.9rem;
cursor: pointer;
}

/* Stats Grid */
.stats-grid {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
gap: 1.5rem;
margin-bottom: 2rem;
}

.stat-card {
background: white;
padding: 1.5rem;
border-radius: 15px;
box-shadow: var(--shadow);
position: relative;
overflow: hidden;
transition: all 0.3s;
}

.stat-card:hover {
transform: translateY(-5px);
box-shadow: var(--shadow-lg);
}

.stat-header {
display: flex;
justify-content: space-between;
align-items: flex-start;
margin-bottom: 1rem;
}

.stat-icon {
width: 50px;
height: 50px;
background: rgba(44, 85, 48, 0.1);
color: var(--primary);
border-radius: 12px;
display: flex;
align-items: center;
justify-content: center;
font-size: 1.5rem;
}

.stat-value {
font-size: 2rem;
font-weight: bold;
color: var(--dark);
margin-bottom: 0.5rem;
}

.stat-label {
color: #666;
font-size: 0.9rem;
}

.stat-breakdown {
display: flex;
gap: 1rem;
margin-top: 0.5rem;
font-size: 0.85rem;
}

.stat-breakdown-item {
display: flex;
align-items: center;
gap: 0.25rem;
}

.stat-dot {
width: 8px;
height: 8px;
border-radius: 50%;
}

/* Main Content Grid */
.content-grid {
display: grid;
grid-template-columns: 1fr 350px;
gap: 2rem;
}

/* Journeys Section */
.journeys-section {
background: white;
border-radius: 15px;
box-shadow: var(--shadow);
padding: 1.5rem;
}

.section-header {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 1.5rem;
padding-bottom: 1rem;
border-bottom: 1px solid #e9ecef;
}

.section-title {
font-size: 1.2rem;
color: var(--primary);
font-weight: 600;
display: flex;
align-items: center;
gap: 0.5rem;
}

.view-toggle {
display: flex;
gap: 0.5rem;
background: #f0f0f0;
padding: 0.25rem;
border-radius: 8px;
width: fit-content;
}

.view-btn {
padding: 0.5rem 1rem;
background: transparent;
border: none;
border-radius: 6px;
cursor: pointer;
transition: all 0.3s;
font-size: 0.9rem;
}

.view-btn.active {
background: white;
box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

/* Kanban Board */
.kanban-board {
display: grid;
grid-template-columns: repeat(3, 1fr);
gap: 1.5rem;
margin-top: 1.5rem;
}

.kanban-column {
background: #f8f9fa;
border-radius: 12px;
padding: 1rem;
min-height: 400px;
}

.column-header {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 1rem;
padding: 0.75rem;
background: white;
border-radius: 8px;
}

.column-title {
font-weight: 600;
color: var(--dark);
display: flex;
align-items: center;
gap: 0.5rem;
}

.column-count {
background: var(--primary);
color: white;
padding: 0.25rem 0.75rem;
border-radius: 15px;
font-size: 0.85rem;
}

.kanban-cards {
display: flex;
flex-direction: column;
gap: 0.75rem;
}

.journey-card {
background: white;
padding: 1rem;
border-radius: 10px;
box-shadow: 0 2px 8px rgba(0,0,0,0.1);
cursor: pointer;
transition: all 0.3s;
position: relative;
border-right: 4px solid var(--eshraq-color);
}

.journey-card:hover {
transform: translateY(-2px);
box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.journey-card.baseera {
border-right-color: var(--baseera-color);
}

.journey-card.sakeena {
border-right-color: var(--sakeena-color);
}

.journey-header {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 0.5rem;
}

.client-info {
display: flex;
align-items: center;
gap: 0.5rem;
}

.client-avatar {
width: 35px;
height: 35px;
background: var(--gradient);
color: white;
border-radius: 50%;
display: flex;
align-items: center;
justify-content: center;
font-weight: bold;
font-size: 0.9rem;
}

.client-name {
font-weight: 600;
color: var(--dark);
}

.journey-status {
width: 10px;
height: 10px;
border-radius: 50%;
background: var(--success);
}

.journey-status.warning {
background: var(--warning);
}

.journey-status.danger {
background: var(--danger);
}

.journey-phase {
font-size: 0.8rem;
color: #666;
background: #f0f0f0;
padding: 0.2rem 0.6rem;
border-radius: 12px;
margin-bottom: 0.5rem;
display: inline-block;
}

.journey-progress {
margin-bottom: 0.5rem;
}

.progress-bar {
height: 6px;
background: #e0e0e0;
border-radius: 3px;
overflow: hidden;
}

.progress-fill {
height: 100%;
background: var(--primary);
border-radius: 3px;
transition: width 0.3s;
}

.journey-stats {
display: flex;
gap: 1rem;
margin-top: 0.5rem;
font-size: 0.85rem;
color: #666;
}

.journey-stat {
display: flex;
align-items: center;
gap: 0.25rem;
}

.journey-actions {
display: flex;
gap: 0.5rem;
margin-top: 0.75rem;
}

.journey-action {
flex: 1;
padding: 0.4rem;
background: #f0f0f0;
border: none;
border-radius: 6px;
font-size: 0.85rem;
cursor: pointer;
transition: all 0.3s;
display: flex;
align-items: center;
justify-content: center;
gap: 0.25rem;
}

.journey-action:hover {
background: var(--primary);
color: white;
}

/* Alerts Panel */
.alerts-panel {
display: flex;
flex-direction: column;
gap: 1.5rem;
}

.alert-card {
background: white;
border-radius: 15px;
box-shadow: var(--shadow);
padding: 1.5rem;
}

.alert-list {
display: flex;
flex-direction: column;
gap: 0.75rem;
max-height: 300px;
overflow-y: auto;
}

.alert-item {
display: flex;
align-items: center;
gap: 1rem;
padding: 1rem;
background: #fff3cd;
border-radius: 10px;
border-right: 4px solid var(--warning);
}

.alert-item.danger {
background: #f8d7da;
border-color: var(--danger);
}

.alert-item.info {
background: #d1ecf1;
border-color: var(--info);
}

.alert-item.success {
background: #d4edda;
border-color: var(--success);
}

.alert-icon {
font-size: 1.5rem;
}

.alert-content {
flex: 1;
}

.alert-title {
font-weight: 600;
color: var(--dark);
margin-bottom: 0.25rem;
}

.alert-desc {
font-size: 0.85rem;
color: #666;
}

.alert-action {
padding: 0.4rem 0.8rem;
background: var(--primary);
color: white;
border: none;
border-radius: 6px;
font-size: 0.85rem;
cursor: pointer;
transition: all 0.3s;
}

.alert-action:hover {
background: var(--secondary);
}

/* Empty State */
.empty-state {
text-align: center;
padding: 3rem;
color: #999;
}

.empty-state-icon {
font-size: 3rem;
margin-bottom: 1rem;
opacity: 0.5;
}

/* Notification */
.notification {
position: fixed;
top: 20px;
right: 20px;
padding: 15px 25px;
border-radius: 8px;
box-shadow: var(--shadow-lg);
z-index: 1000;
animation: slideIn 0.3s;
cursor: pointer;
display: flex;
align-items: center;
gap: 10px;
max-width: 400px;
}

@keyframes slideIn {
from {
transform: translateX(100%);
opacity: 0;
}
to {
transform: translateX(0);
opacity: 1;
}
}

.notification.success {
background: var(--success);
color: white;
}

.notification.error {
background: var(--danger);
color: white;
}

.notification.info {
background: var(--info);
color: white;
}

/* Responsive */
@media (max-width: 1200px) {
.content-grid {
grid-template-columns: 1fr;
}

.alerts-panel {
order: -1;
flex-direction: row;
overflow-x: auto;
}

.alert-card {
min-width: 300px;
}
}

@media (max-width: 768px) {
.dashboard-container {
padding: 1rem;
}

.stats-grid {
grid-template-columns: 1fr;
}

.kanban-board {
grid-template-columns: 1fr;
}

.nav-links {
gap: 1rem;
font-size: 0.9rem;
}

.page-title {
font-size: 1.5rem;
}
}
</style>
</head>
<body>
<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
<div class="loading-spinner"></div>
</div>

<!-- Auth Check -->
<div id="authCheck" class="auth-check">
<div class="auth-message">
<h2>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ø·Ù„ÙˆØ¨</h2>
<p>ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹ Ù„Ù„ÙˆØµÙˆÙ„ Ù„Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø©</p>
<button onclick="redirectToLogin()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
</div>
</div>

<!-- Main Content -->
<div id="mainContent">
<!-- Navigation -->
<nav class="admin-nav">
<div class="nav-container">
<div class="nav-brand">
<h2>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø±Ø­Ù„Ø§Øª</h2>
</div>
<div class="nav-links">
<a href="admin-dashboard.html">
<span>ğŸ </span>
<span>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
</a>
<a href="admin-bookings.html">
<span>ğŸ“‹</span>
<span>Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª</span>
</a>
<a href="central-dashboard.html" class="active">
<span>ğŸ¯</span>
<span>Ø§Ù„Ø±Ø­Ù„Ø§Øª</span>
</a>
<a href="admin-tools.html">
<span>ğŸ”§</span>
<span>Ø§Ù„Ø£Ø¯ÙˆØ§Øª</span>
</a>
<a href="#" onclick="logout()">
<span>ğŸšª</span>
<span>Ø®Ø±ÙˆØ¬</span>
</a>
</div>
</div>
</nav>

<!-- Dashboard Container -->
<div class="dashboard-container" id="dashboardContainer">
<!-- Page Header -->
<div class="page-header">
<button onclick="window.location.reload()" class="btn btn-primary" style="float: left; padding: 0.5rem 1rem; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer;">
<span>ğŸ”„</span> ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
</button>
<h1 class="page-title">Ù…Ø±ÙƒØ² Ù‚ÙŠØ§Ø¯Ø© Ø§Ù„Ø±Ø­Ù„Ø§Øª</h1>
<p class="page-subtitle">Ù†Ø¸Ø±Ø© Ø´Ø§Ù…Ù„Ø© Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø±Ø­Ù„Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø© ÙˆØ§Ù„Ø£Ù†Ø´Ø·Ø©</p>
<div class="date-range">
<span>ğŸ“…</span>
<select id="dateRange" onchange="updateDateRange()">
<option value="today">Ø§Ù„ÙŠÙˆÙ…</option>
<option value="week" selected>Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</option>
<option value="month">Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±</option>
<option value="quarter">Ø¢Ø®Ø± 3 Ø´Ù‡ÙˆØ±</option>
<option value="all">ÙƒÙ„ Ø§Ù„ÙˆÙ‚Øª</option>
</select>
</div>
</div>

<!-- Stats Grid -->
<div class="stats-grid">
<div class="stat-card">
<div class="stat-header">
<div class="stat-icon">ğŸ¯</div>
</div>
<div class="stat-value" id="activeJourneysCount">0</div>
<div class="stat-label">Ø±Ø­Ù„Ø© Ù†Ø´Ø·Ø©</div>
<div class="stat-breakdown">
<div class="stat-breakdown-item">
<div class="stat-dot" style="background: var(--eshraq-color);"></div>
<span id="eshraqCount">0 Ø¥Ø´Ø±Ø§Ù‚Ø©</span>
</div>
<div class="stat-breakdown-item">
<div class="stat-dot" style="background: var(--baseera-color);"></div>
<span id="baseeraCount">0 Ø¨ØµÙŠØ±Ø©</span>
</div>
<div class="stat-breakdown-item">
<div class="stat-dot" style="background: var(--sakeena-color);"></div>
<span id="sakeenaCount">0 Ø³ÙƒÙŠÙ†Ø©</span>
</div>
</div>
</div>

<div class="stat-card">
<div class="stat-header">
<div class="stat-icon">ğŸ“Š</div>
</div>
<div class="stat-value" id="avgEngagement">0%</div>
<div class="stat-label">Ù…ØªÙˆØ³Ø· Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©</div>
</div>

<div class="stat-card">
<div class="stat-header">
<div class="stat-icon">âœ…</div>
</div>
<div class="stat-value" id="completedBookings">0</div>
<div class="stat-label">Ø­Ø¬ÙˆØ²Ø§Øª Ù…ÙƒØªÙ…Ù„Ø©</div>
</div>

<div class="stat-card">
<div class="stat-header">
<div class="stat-icon">ğŸ“…</div>
</div>
<div class="stat-value" id="pendingBookings">0</div>
<div class="stat-label">Ø­Ø¬ÙˆØ²Ø§Øª ÙÙŠ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</div>
</div>
</div>

<!-- Main Content Grid -->
<div class="content-grid">
<!-- Journeys Section -->
<div class="journeys-section">
<div class="section-header">
<h3 class="section-title">
<span>ğŸ—ºï¸</span>
<span>Ø§Ù„Ø±Ø­Ù„Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬</span>
</h3>
<div class="view-toggle">
<button class="view-btn active" onclick="switchView('kanban')">ğŸ“‹ ÙƒØ§Ù†Ø¨Ø§Ù†</button>
<button class="view-btn" onclick="switchView('list')">ğŸ“ Ù‚Ø§Ø¦Ù…Ø©</button>
</div>
</div>

<!-- Kanban View -->
<div class="kanban-board" id="kanbanBoard">
<div class="kanban-column">
<div class="column-header">
<div class="column-title">
<span style="color: var(--eshraq-color);">â—</span>
<span>Ø±Ø­Ù„Ø© Ø§Ù„Ø¥Ø´Ø±Ø§Ù‚Ø©</span>
</div>
<span class="column-count" id="eshraqColumnCount">0</span>
</div>
<div class="kanban-cards" id="eshraqCards">
<!-- Cards will be populated here -->
</div>
</div>

<div class="kanban-column">
<div class="column-header">
<div class="column-title">
<span style="color: var(--baseera-color);">â—</span>
<span>Ø±Ø­Ù„Ø© Ø§Ù„Ø¨ØµÙŠØ±Ø©</span>
</div>
<span class="column-count" id="baseeraColumnCount">0</span>
</div>
<div class="kanban-cards" id="baseeraCards">
<!-- Cards will be populated here -->
</div>
</div>

<div class="kanban-column">
<div class="column-header">
<div class="column-title">
<span style="color: var(--sakeena-color);">â—</span>
<span>Ø±Ø­Ù„Ø© Ø§Ù„Ø³ÙƒÙŠÙ†Ø©</span>
</div>
<span class="column-count" id="sakeenaColumnCount">0</span>
</div>
<div class="kanban-cards" id="sakeenaCards">
<!-- Cards will be populated here -->
</div>
</div>
</div>
</div>

<!-- Alerts Panel -->
<div class="alerts-panel">
<!-- Smart Alerts -->
<div class="alert-card">
<div class="section-header">
<h3 class="section-title">
<span>ğŸš¨</span>
<span>ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø°ÙƒÙŠØ©</span>
</h3>
</div>
<div class="alert-list" id="alertsList">
<div class="empty-state">
<p>Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ†Ø¨ÙŠÙ‡Ø§Øª</p>
</div>
</div>
</div>

<!-- Recent Activity -->
<div class="alert-card">
<div class="section-header">
<h3 class="section-title">
<span>âš¡</span>
<span>Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ø£Ø®ÙŠØ±</span>
</h3>
</div>
<div id="recentActivity">
<div class="empty-state">
<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ù†Ø´Ø·Ø© Ø­Ø¯ÙŠØ«Ø©</p>
</div>
</div>
</div>
</div>
</div>
</div>
</div>

<!-- Firebase Scripts -->
<script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
<script src="firebase-config.js"></script>

<script>
// Initialize Firebase
const auth = firebase.auth();
const db = firebase.firestore();

// State
let allJourneys = [];
let allBookings = [];
let allUsers = [];
let currentUser = null;

// Admin emails - Ø¶Ø¹ Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù‡Ù†Ø§
const adminEmails = ['coach.s.fouad@gmail.com', 'admin@example.com'];

// Initialize
document.addEventListener('DOMContentLoaded', function() {
checkAuth();
});

// Check authentication
function checkAuth() {
showLoading(true);

auth.onAuthStateChanged(user => {
console.log('Auth state changed, user:', user);

if (!user) {
console.log('No user, showing auth check...');
showAuthCheck();
showLoading(false);
return;
}

// Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ
if (!adminEmails.includes(user.email)) {
console.log('User not authorized:', user.email);
showNotification('Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµØ­Ù„Ø© Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø©', 'error');
auth.signOut();
showAuthCheck();
showLoading(false);
return;
}

console.log('User authorized:', user.email);
currentUser = user;
showDashboard();
initializeDashboard();
});
}

function showAuthCheck() {
document.getElementById('authCheck').style.display = 'flex';
document.getElementById('mainContent').style.display = 'none';
}

function showDashboard() {
document.getElementById('authCheck').style.display = 'none';
document.getElementById('mainContent').style.display = 'block';
document.getElementById('dashboardContainer').classList.add('show');
}

function redirectToLogin() {
window.location.href = 'admin-dashboard.html';
}

// Initialize dashboard
async function initializeDashboard() {
try {
console.log('Initializing dashboard...');
await loadAllData();
updateStats();
displayJourneys();
generateAlerts();
showLoading(false);
showNotification('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­', 'success');
} catch (error) {
console.error('Error initializing dashboard:', error);
showLoading(false);
showNotification('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ' + error.message, 'error');
}
}

// Load all data
async function loadAllData() {
console.log('Loading all data...');

try {
// Load bookings first
const bookingsSnapshot = await db.collection('bookings').get();
allBookings = [];
bookingsSnapshot.forEach(doc => {
allBookings.push({
id: doc.id,
...doc.data()
});
});
console.log('Loaded bookings:', allBookings.length);

// Load users
const usersSnapshot = await db.collection('users').get();
allUsers = [];
usersSnapshot.forEach(doc => {
allUsers.push({
id: doc.id,
...doc.data()
});
});
console.log('Loaded users:', allUsers.length);

// Transform bookings into journeys format
allJourneys = transformBookingsToJourneys();
console.log('Transformed journeys:', allJourneys.length);

} catch (error) {
console.error('Error loading data:', error);
throw error;
}
}

// Transform bookings to journeys format
function transformBookingsToJourneys() {
const journeys = [];

// Process converted bookings (status: converted)
const convertedBookings = allBookings.filter(booking => 
booking.status === 'converted' || booking.status === 'completed'
);

convertedBookings.forEach(booking => {
// Find corresponding user
const user = allUsers.find(u => u.email === booking.email || u.id === booking.userId);

// Map journey type
let journeyType = booking.journeyType || booking.program;
if (!journeyType) {
// Try to determine from program name
if (booking.program) {
if (booking.program.includes('Ø¥Ø´Ø±Ø§Ù‚Ø©') || booking.program.includes('ÙˆØ¶ÙˆØ­')) {
journeyType = 'eshraq';
} else if (booking.program.includes('Ø¨ØµÙŠØ±Ø©') || booking.program.includes('Ø§ÙƒØªØ´Ø§Ù')) {
journeyType = 'baseera';
} else if (booking.program.includes('Ø³ÙƒÙŠÙ†Ø©') || booking.program.includes('ØªØ­ÙˆÙ„')) {
journeyType = 'sakeena';
} else {
journeyType = 'eshraq'; // default
}
} else {
journeyType = 'eshraq'; // default
}
}

const journey = {
id: booking.id,
clientId: user?.id || booking.userId || booking.id,
clientName: booking.name || user?.name || 'Ø¹Ù…ÙŠÙ„',
clientEmail: booking.email || user?.email,
clientPhone: booking.phone || user?.phone,
journeyType: journeyType,
program: getJourneyDisplayName(journeyType),
status: 'active',
currentPhase: 1,
totalPhases: getJourneyPhases(journeyType),
completedSessions: 0,
totalSessions: getJourneySessions(journeyType),
engagementScore: Math.floor(Math.random() * 30) + 70, // Mock data
practicesCompleted: Math.floor(Math.random() * 10),
practicesAssigned: Math.floor(Math.random() * 5) + 10,
lastActivityDate: booking.createdAt || new Date(),
startDate: booking.createdAt || new Date(),
createdAt: booking.createdAt || new Date(),
bookingId: booking.id,
assessmentId: booking.assessmentId
};

journeys.push(journey);
});

// Process confirmed bookings that haven't been converted yet
const confirmedBookings = allBookings.filter(booking => 
booking.status === 'confirmed' && !convertedBookings.some(cb => cb.id === booking.id)
);

confirmedBookings.forEach(booking => {
const user = allUsers.find(u => u.email === booking.email);
let journeyType = booking.journeyType || 'eshraq';

const journey = {
id: 'pending_' + booking.id,
clientId: user?.id || booking.userId || booking.id,
clientName: booking.name || 'Ø¹Ù…ÙŠÙ„',
clientEmail: booking.email,
clientPhone: booking.phone,
journeyType: journeyType,
program: getJourneyDisplayName(journeyType),
status: 'pending_start',
currentPhase: 0,
totalPhases: getJourneyPhases(journeyType),
completedSessions: 0,
totalSessions: getJourneySessions(journeyType),
engagementScore: 0,
practicesCompleted: 0,
practicesAssigned: 0,
lastActivityDate: booking.createdAt,
startDate: null,
createdAt: booking.createdAt,
bookingId: booking.id,
needsAttention: true
};

journeys.push(journey);
});

return journeys;
}

function getJourneyDisplayName(type) {
const names = {
'eshraq': 'Ø±Ø­Ù„Ø© Ø§Ù„Ø¥Ø´Ø±Ø§Ù‚Ø©',
'baseera': 'Ø±Ø­Ù„Ø© Ø§Ù„Ø¨ØµÙŠØ±Ø©', 
'sakeena': 'Ø±Ø­Ù„Ø© Ø§Ù„Ø³ÙƒÙŠÙ†Ø©',
'mixed-eshraq-baseera': 'Ù…Ø³Ø§Ø± Ù…ØªØ¯Ø±Ø¬ (Ø¥Ø´Ø±Ø§Ù‚Ø©-Ø¨ØµÙŠØ±Ø©)',
'mixed-baseera-sakeena': 'Ù…Ø³Ø§Ø± Ù…ØªØ¯Ø±Ø¬ (Ø¨ØµÙŠØ±Ø©-Ø³ÙƒÙŠÙ†Ø©)'
};
return names[type] || type;
}

function getJourneyPhases(type) {
const phases = {
'eshraq': 3,
'baseera': 3,
'sakeena': 3
};
return phases[type] || 3;
}

function getJourneySessions(type) {
const sessions = {
'eshraq': 3,
'baseera': 12,
'sakeena': 24
};
return sessions[type] || 3;
}

// Update statistics
function updateStats() {
console.log('Updating stats...');

// Count journeys by type
const journeysByType = {
eshraq: 0,
baseera: 0, 
sakeena: 0
};

let totalEngagement = 0;
let engagementCount = 0;

allJourneys.forEach(journey => {
// Count by type
if (journey.journeyType.includes('eshraq')) {
journeysByType.eshraq++;
} else if (journey.journeyType.includes('baseera')) {
journeysByType.baseera++;
} else if (journey.journeyType.includes('sakeena')) {
journeysByType.sakeena++;
}

// Calculate engagement
if (journey.engagementScore > 0) {
totalEngagement += journey.engagementScore;
engagementCount++;
}
});

// Update UI
document.getElementById('activeJourneysCount').textContent = allJourneys.length;
document.getElementById('eshraqCount').textContent = `${journeysByType.eshraq} Ø¥Ø´Ø±Ø§Ù‚Ø©`;
document.getElementById('baseeraCount').textContent = `${journeysByType.baseera} Ø¨ØµÙŠØ±Ø©`;
document.getElementById('sakeenaCount').textContent = `${journeysByType.sakeena} Ø³ÙƒÙŠÙ†Ø©`;

const avgEngagement = engagementCount > 0 ? Math.round(totalEngagement / engagementCount) : 0;
document.getElementById('avgEngagement').textContent = `${avgEngagement}%`;

// Booking stats
const completedBookings = allBookings.filter(b => b.status === 'completed' || b.status === 'converted').length;
const pendingBookings = allBookings.filter(b => b.status === 'pending' || b.status === 'confirming').length;

document.getElementById('completedBookings').textContent = completedBookings;
document.getElementById('pendingBookings').textContent = pendingBookings;

console.log('Stats updated:', {
total: allJourneys.length,
eshraq: journeysByType.eshraq,
baseera: journeysByType.baseera,
sakeena: journeysByType.sakeena
});
}

// Display journeys
function displayJourneys() {
console.log('Displaying journeys...');

// Group by type
const journeysByType = {
eshraq: allJourneys.filter(j => j.journeyType.includes('eshraq')),
baseera: allJourneys.filter(j => j.journeyType.includes('baseera')),
sakeena: allJourneys.filter(j => j.journeyType.includes('sakeena'))
};

// Update column counts
document.getElementById('eshraqColumnCount').textContent = journeysByType.eshraq.length;
document.getElementById('baseeraColumnCount').textContent = journeysByType.baseera.length;
document.getElementById('sakeenaColumnCount').textContent = journeysByType.sakeena.length;

// Display cards
displayJourneyCards('eshraqCards', journeysByType.eshraq, 'eshraq');
displayJourneyCards('baseeraCards', journeysByType.baseera, 'baseera');
displayJourneyCards('sakeenaCards', journeysByType.sakeena, 'sakeena');
}

function displayJourneyCards(containerId, journeys, type) {
const container = document.getElementById(containerId);

if (journeys.length === 0) {
container.innerHTML = '<p style="text-align: center; color: #999; padding: 2rem;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø­Ù„Ø§Øª Ù†Ø´Ø·Ø©</p>';
return;
}

let html = '';
journeys.forEach(journey => {
const progress = journey.totalSessions > 0 ? 
Math.round((journey.completedSessions / journey.totalSessions) * 100) : 0;

const statusClass = journey.needsAttention ? 'danger' : 
journey.engagementScore >= 70 ? 'success' : 'warning';

const lastActivity = journey.lastActivityDate ? 
formatRelativeTime(journey.lastActivityDate) : 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†Ø´Ø§Ø·';

const avatar = journey.clientName ? journey.clientName.charAt(0) : 'ØŸ';

html += `
<div class="journey-card ${type}" onclick="viewJourneyDetails('${journey.id}')">
<div class="journey-header">
<div class="client-info">
<div class="client-avatar">${avatar}</div>
<div class="client-name">${journey.clientName}</div>
</div>
<div class="journey-status ${statusClass}"></div>
</div>
<div class="journey-phase">Ø§Ù„Ù…Ø±Ø­Ù„Ø© ${journey.currentPhase} Ù…Ù† ${journey.totalPhases}</div>
<div class="journey-progress">
<div class="progress-bar">
<div class="progress-fill" style="width: ${progress}%;"></div>
</div>
</div>
<div class="journey-stats">
<div class="journey-stat">
<span>ğŸ“Š</span>
<span>${journey.engagementScore}%</span>
</div>
<div class="journey-stat">
<span>âœ…</span>
<span>${journey.completedSessions}/${journey.totalSessions}</span>
</div>
</div>
<div style="font-size: 0.8rem; color: #999; margin-top: 0.5rem;">
Ø¢Ø®Ø± Ù†Ø´Ø§Ø·: ${lastActivity}
</div>
<div class="journey-actions" onclick="event.stopPropagation();">
<button class="journey-action" onclick="sendMessage('${journey.id}')">
<span>ğŸ’¬</span>
<span>Ø±Ø³Ø§Ù„Ø©</span>
</button>
<button class="journey-action" onclick="openJourneyManagement('${journey.id}')">
<span>âš™ï¸</span>
<span>Ø¥Ø¯Ø§Ø±Ø©</span>
</button>
</div>
</div>
`;
});

container.innerHTML = html;
}

// Generate alerts
function generateAlerts() {
const alerts = [];

// Check for inactive journeys
allJourneys.forEach(journey => {
const daysSinceActivity = getDaysSince(journey.lastActivityDate);
if (daysSinceActivity > 7) {
alerts.push({
type: 'warning',
icon: 'âš ï¸',
title: 'Ø¹Ù…ÙŠÙ„ ØºÙŠØ± Ù†Ø´Ø·',
desc: `${journey.clientName} Ù„Ù… ÙŠØªÙØ§Ø¹Ù„ Ù…Ù†Ø° ${daysSinceActivity} Ø£ÙŠØ§Ù…`,
action: () => sendMessage(journey.id)
});
}

if (journey.needsAttention) {
alerts.push({
type: 'info',
icon: 'ğŸ“Œ',
title: 'ÙŠØ­ØªØ§Ø¬ Ù…ØªØ§Ø¨Ø¹Ø©',
desc: `${journey.clientName} - ${journey.program}`,
action: () => openJourneyManagement(journey.id)
});
}
});

// Check for pending bookings
const pendingBookings = allBookings.filter(b => b.status === 'pending').length;
if (pendingBookings > 0) {
alerts.push({
type: 'info',
icon: 'ğŸ“‹',
title: 'Ø­Ø¬ÙˆØ²Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©',
desc: `${pendingBookings} Ø­Ø¬Ø² ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©`,
action: () => window.location.href = 'admin-bookings.html'
});
}

displayAlerts(alerts);
}

function displayAlerts(alerts) {
const container = document.getElementById('alertsList');

if (alerts.length === 0) {
container.innerHTML = '<div class="empty-state"><p>Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ†Ø¨ÙŠÙ‡Ø§Øª</p></div>';
return;
}

let html = '';
alerts.forEach((alert, index) => {
html += `
<div class="alert-item ${alert.type}">
<div class="alert-icon">${alert.icon}</div>
<div class="alert-content">
<div class="alert-title">${alert.title}</div>
<div class="alert-desc">${alert.desc}</div>
</div>
<button class="alert-action" onclick="handleAlert(${index})">
Ø¥Ø¬Ø±Ø§Ø¡
</button>
</div>
`;
});

container.innerHTML = html;
window.currentAlerts = alerts;
}

// Event handlers
function handleAlert(index) {
if (window.currentAlerts && window.currentAlerts[index]) {
window.currentAlerts[index].action();
}
}

function viewJourneyDetails(journeyId) {
const journey = allJourneys.find(j => j.id === journeyId);
if (!journey) return;

if (journey.clientId && !journeyId.startsWith('pending_')) {
window.location.href = `admin-journey-management.html?clientId=${journey.clientId}&journeyId=${journeyId}&bookingId=${journey.bookingId}`;
} else {
window.location.href = `admin-bookings.html`;
}
}

function openJourneyManagement(journeyId) {
viewJourneyDetails(journeyId);
}

function sendMessage(journeyId) {
showNotification('Ù…ÙŠØ²Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ù‚ÙŠØ¯ Ø§Ù„ØªØ·ÙˆÙŠØ±', 'info');
}

function switchView(view) {
// Update button states
document.querySelectorAll('.view-btn').forEach(btn => {
btn.classList.remove('active');
});
event.target.classList.add('active');

if (view === 'list') {
showNotification('Ø¹Ø±Ø¶ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù‚ÙŠØ¯ Ø§Ù„ØªØ·ÙˆÙŠØ±', 'info');
}
}

function updateDateRange() {
const range = document.getElementById('dateRange').value;
showNotification(`ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ø²Ù…Ù†ÙŠ: ${range}`, 'info');
// ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ù…Ù†Ø·Ù‚ Ø§Ù„ÙÙ„ØªØ±Ø© Ù‡Ù†Ø§
}

function logout() {
if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ')) {
auth.signOut().then(() => {
window.location.href = 'admin-dashboard.html';
});
}
}

// Utility functions
function getDaysSince(date) {
if (!date) return 999;
const d = date.toDate ? date.toDate() : new Date(date);
const now = new Date();
const diffTime = Math.abs(now - d);
return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
}

function formatRelativeTime(date) {
if (!date) return 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
const d = date.toDate ? date.toDate() : new Date(date);
const now = new Date();
const diff = now - d;
const days = Math.floor(diff / (1000 * 60 * 60 * 24));
const hours = Math.floor(diff / (1000 * 60 * 60));
const minutes = Math.floor(diff / (1000 * 60));

if (minutes < 1) return 'Ø§Ù„Ø¢Ù†';
if (minutes < 60) return `Ù…Ù†Ø° ${minutes} Ø¯Ù‚ÙŠÙ‚Ø©`;
if (hours < 24) return `Ù…Ù†Ø° ${hours} Ø³Ø§Ø¹Ø©`;
if (days < 7) return `Ù…Ù†Ø° ${days} ÙŠÙˆÙ…`;
return d.toLocaleDateString('ar-EG');
}

function showLoading(show) {
const overlay = document.getElementById('loadingOverlay');
if (show) {
overlay.classList.add('show');
} else {
overlay.classList.remove('show');
}
}

function showNotification(message, type = 'success') {
// Remove existing notifications
document.querySelectorAll('.notification').forEach(n => n.remove());

const notification = document.createElement('div');
notification.className = `notification ${type}`;
const icon = type === 'success' ? 'âœ“' : type === 'error' ? 'âœ—' : 'â„¹';

notification.innerHTML = `
<span>${icon}</span>
<span>${message}</span>
`;

document.body.appendChild(notification);

// Auto remove after 3 seconds
setTimeout(() => {
notification.remove();
}, 3000);

// Remove on click
notification.addEventListener('click', () => {
notification.remove();
});
}
</script>
</body>
</html>
